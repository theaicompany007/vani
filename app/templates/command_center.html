<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Vani | Strategic Command</title>
    <!-- Tailwind CSS (compiled) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Additional custom styles if needed -->
    <style>
        /* Admin tab styles */
        .admin-tab-btn {
            transition: all 0.2s;
        }
        .admin-tab-btn.admin-tab-active {
            border-bottom-color: rgb(99 102 241);
            color: rgb(99 102 241);
        }
        .admin-tab-content {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-600 text-white w-10 h-10 rounded-lg flex items-center justify-center font-bold text-xl">V</div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">Project Vani</h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide uppercase">Strategic Reconnaissance</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-slate-500 hidden md:block">
                        Operational Status: <span class="text-emerald-600 font-bold">READY TO DEPLOY</span>
                    </div>
                    <!-- Industry Selector - Only visible for Pitch Presentation and Target Hit List -->
                    <div id="industry-selector-container" class="flex items-center gap-2 hidden">
                        <label class="text-xs text-slate-500 font-medium">Industry:</label>
                        <select id="industry-selector" onchange="switchIndustry(this.value)" 
                                class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">All Industries</option>
                        </select>
                        <span id="industry-badge" class="hidden px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded"></span>
                    </div>
                    <!-- User Info & Logout -->
                    <div class="flex items-center gap-3">
                        <div id="user-info" class="hidden text-sm text-slate-700">
                            <span id="user-name" class="font-medium"></span>
                            <span id="user-badges" class="ml-2"></span>
                        </div>
                        <button onclick="handleLogout()" id="logout-btn" class="hidden px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
                            <i class="fa-solid fa-sign-out-alt mr-2"></i>Sign Out
                        </button>
                    </div>
                    <!-- HIT Notifications -->
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="relative p-2 text-slate-600 hover:text-slate-900">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <span id="notification-badge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
                            <div class="p-4 border-b border-slate-200">
                                <h3 class="font-bold text-slate-800">HIT Notifications</h3>
                                <p class="text-xs text-slate-500">Email opens, clicks, replies, WhatsApp engagement, meetings</p>
                            </div>
                            <div id="notification-list" class="p-2">
                                <div class="text-center text-slate-500 py-4 text-sm">Loading notifications...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Navigation -->
            <nav class="flex gap-8 -mb-px overflow-x-auto text-sm">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn nav-active pb-3 px-1 transition-colors">Situation Room</button>
                <button onclick="switchTab('pitch')" id="nav-pitch" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Pitch Presentation</button>
                <button onclick="switchTab('analytics')" id="nav-analytics" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Analytics</button>
                <button onclick="switchTab('meetings')" id="nav-meetings" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Meetings</button>
                <button onclick="switchTab('arbitrage')" id="nav-arbitrage" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">The Arbitrage</button>
                <button onclick="switchTab('commercial')" id="nav-commercial" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Revenue Sim</button>
                <button onclick="switchTab('targets')" id="nav-targets" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Target Hit List</button>
                <button onclick="switchTab('ai-finder')" id="nav-ai-finder" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors hidden" style="display: none;">AI Target Finder</button>
                <button onclick="switchTab('contacts')" id="nav-contacts" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Contacts</button>
                <button onclick="switchTab('companies')" id="nav-companies" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors">Companies</button>
                <button onclick="switchTab('admin')" id="nav-admin" class="nav-btn text-slate-500 hover:text-slate-700 pb-3 px-1 transition-colors hidden" style="display: none;">Admin</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- VIEW 1: DASHBOARD / SITUATION ROOM -->
        <section id="view-dashboard" class="space-y-8 animate-fade-in">
            <!-- Intro Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Executive Summary: The Coverage Gap</h2>
                <p class="text-slate-600 leading-relaxed mb-4">
                    FMCG giants like Asian Paints and Coca-Cola miss out on <strong>80% of potential retail outlets</strong> because human sales visits are too expensive (‚Çπ300/visit) for small orders. Apps have failed due to retailer literacy issues.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-1"><i class="fa-solid fa-brain text-indigo-500 mr-2"></i>The Brain (The AI Company)</h3>
                        <p class="text-sm text-slate-600">Proprietary "Sales Ontology" trained on millions of Indian trade conversations. Speaks Hinglish, Tamil, Bengali.</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-1"><i class="fa-solid fa-network-wired text-emerald-500 mr-2"></i>The Body (Platform)</h3>
                        <p class="text-sm text-slate-600">Infrastructure-agnostic telecom integration. Zero-latency voice that replaces the need for human field agents.</p>
                    </div>
                </div>
            </div>

            <!-- The Problem Viz -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800">The "Void" in Distribution</h3>
                        <span class="text-xs font-semibold bg-rose-100 text-rose-700 px-2 py-1 rounded-full">80% Unserved</span>
                    </div>
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <canvas id="gapChart"></canvas>
                    </div>
                    <p class="text-center text-sm text-slate-500 mt-4">Top brands reach only 2-3M stores directly. 9M+ are "Dark Stores".</p>
                </div>

                <div class="bg-indigo-900 text-white rounded-xl shadow-lg p-6 flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                    <h3 class="text-xl font-bold mb-4 z-10">The Solution: Vani</h3>
                    <ul class="space-y-4 z-10">
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle mt-1 mr-3 text-emerald-400"></i>
                            <span class="text-indigo-100 text-sm"><strong>Agentic AI:</strong> Wakes up, plans beat, calls stores autonomously.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle mt-1 mr-3 text-emerald-400"></i>
                            <span class="text-indigo-100 text-sm"><strong>Voice First:</strong> No typing required. Zero friction for Kirana owners.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle mt-1 mr-3 text-emerald-400"></i>
                            <span class="text-indigo-100 text-sm"><strong>Infinite Scale:</strong> Call 10M stores in a day if needed.</span>
                        </li>
                    </ul>
                    <button onclick="switchTab('targets')" class="mt-8 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded transition w-full">Deploy Pilot Strategy</button>
                </div>
            </div>
        </section>

        <!-- VIEW 2: ARBITRAGE -->
        <section id="view-arbitrage" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">The Unit Economics Arbitrage</h2>
                <p class="text-slate-600 mb-6">Why human agents cannot service the long tail, and why Vani creates immediate margin.</p>
                
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="arbitrageChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Human Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-rose-500">
                    <h3 class="font-bold text-lg mb-2">Human Salesman</h3>
                    <div class="text-4xl font-extrabold text-slate-900 mb-1">‚Çπ300</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-4">Cost Per Visit</div>
                    <ul class="text-sm text-slate-600 space-y-2">
                        <li><i class="fa-solid fa-xmark text-rose-500 mr-2"></i>Max 30 stores/day</li>
                        <li><i class="fa-solid fa-xmark text-rose-500 mr-2"></i>High training cost</li>
                        <li><i class="fa-solid fa-xmark text-rose-500 mr-2"></i>Forgets to upsell</li>
                    </ul>
                </div>

                <!-- App Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-slate-400">
                    <h3 class="font-bold text-lg mb-2">App Notification</h3>
                    <div class="text-4xl font-extrabold text-slate-900 mb-1">‚Çπ0.10</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-4">Cost Per Msg</div>
                    <ul class="text-sm text-slate-600 space-y-2">
                        <li><i class="fa-solid fa-check text-slate-500 mr-2"></i>Unlimited Reach</li>
                        <li><i class="fa-solid fa-xmark text-rose-500 mr-2"></i>5% Open Rate</li>
                        <li><i class="fa-solid fa-xmark text-rose-500 mr-2"></i>Requires Literacy</li>
                    </ul>
                </div>

                <!-- Vani Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-emerald-500 shadow-md transform scale-105">
                    <h3 class="font-bold text-lg mb-2 flex items-center gap-2">Vani (The AI Company) <span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-0.5 rounded-full">Recommended</span></h3>
                    <div class="text-4xl font-extrabold text-emerald-600 mb-1">‚Çπ5 - ‚Çπ10</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-4">Cost Per Interaction</div>
                    <ul class="text-sm text-slate-600 space-y-2">
                        <li><i class="fa-solid fa-check text-emerald-500 mr-2"></i>Unlimited Scale</li>
                        <li><i class="fa-solid fa-check text-emerald-500 mr-2"></i>Native Voice Negotiation</li>
                        <li><i class="fa-solid fa-check text-emerald-500 mr-2"></i>Direct DMS Integration</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- VIEW 3: COMMERCIAL MODELS -->
        <section id="view-commercial" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Revenue Simulator</h2>
                <p class="text-slate-600 mb-6">Select a target volume to project revenue across our three commercial strategies.</p>

                <!-- Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 bg-slate-50 p-6 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Target Store Count</label>
                        <input type="range" id="storeInput" min="1000" max="100000" step="1000" value="5000" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600" oninput="updateRevenue()">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>1k (Pilot)</span>
                            <span id="storeDisplay" class="font-bold text-emerald-600 text-lg">5,000 Stores</span>
                            <span>100k (Enterprise)</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Avg. Order Value (‚Çπ)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <span class="text-gray-500 sm:text-sm">‚Çπ</span>
                            </div>
                            <input type="number" id="aovInput" value="2000" class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" oninput="updateRevenue()">
                        </div>
                    </div>
                </div>

                <!-- Model Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Option A -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 hover:shadow-lg transition-shadow relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-bl-lg">FOR PILOTS</div>
                        <h3 class="text-xl font-bold text-slate-800">The "Lazarus" Model</h3>
                        <p class="text-xs text-slate-500 mb-4">Pure Outcome: We only get paid if we wake up a dead store.</p>
                        <div class="my-4 pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-600">Success Fee: <strong>‚Çπ150</strong> / Order</p>
                            <p class="text-sm text-slate-600">Est. Conversion: <strong>10%</strong></p>
                        </div>
                        <div class="mt-6">
                            <span class="text-xs text-slate-400 uppercase">Projected Revenue</span>
                            <div class="text-3xl font-bold text-emerald-600" id="rev-lazarus">‚Çπ75,000</div>
                        </div>
                    </div>

                    <!-- Option B -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                        <h3 class="text-xl font-bold text-slate-800">The "Digital Seat"</h3>
                        <p class="text-xs text-slate-500 mb-4">Pure SaaS: Replace human headcount with digital seats.</p>
                        <div class="my-4 pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-600">License: <strong>‚Çπ5,000</strong> / Agent / Mo</p>
                            <p class="text-sm text-slate-600">Capacity: <strong>5,000</strong> stores/agent</p>
                        </div>
                        <div class="mt-6">
                            <span class="text-xs text-slate-400 uppercase">Projected Revenue (MRR)</span>
                            <div class="text-3xl font-bold text-indigo-600" id="rev-seat">‚Çπ5,000</div>
                        </div>
                    </div>

                    <!-- Option C -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 hover:shadow-lg transition-shadow relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-emerald-100 text-emerald-800 text-xs font-bold px-3 py-1 rounded-bl-lg">SCALE GOAL</div>
                        <h3 class="text-xl font-bold text-slate-800">Hybrid Scale</h3>
                        <p class="text-xs text-slate-500 mb-4">Base + Upside: Align incentives with order growth.</p>
                        <div class="my-4 pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-600">Platform Fee: <strong>‚Çπ10</strong> / Call</p>
                            <p class="text-sm text-slate-600">Comm: <strong>1.5%</strong> of GMV</p>
                        </div>
                        <div class="mt-6">
                            <span class="text-xs text-slate-400 uppercase">Projected Revenue</span>
                            <div class="text-3xl font-bold text-emerald-600" id="rev-hybrid">‚Çπ200,000</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: PITCH PRESENTATION -->
        <section id="view-pitch" class="hidden space-y-8 animate-fade-in">
            <!-- Industry Display for Pitch Presentation -->
            <div id="pitch-industry-display" class="p-3 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-industry text-indigo-600"></i>
                    <span class="text-sm font-medium text-indigo-900">Active Industry: </span>
                    <span id="pitch-industry-name" class="text-sm font-bold text-indigo-700"></span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Pitch Presentation</h2>
                <p class="text-slate-600 mb-6">Generate and send AI-powered pitch presentations to your targets.</p>
                
                <div class="space-y-6">
                    <!-- Target Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Target</label>
                        <select id="pitch-target-select" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm" onchange="onPitchTargetChange()">
                            <option value="">-- Select a target --</option>
                        </select>
                    </div>
                    
                    <!-- Pitch History (shown when target is selected) -->
                    <div id="pitch-history-section" class="hidden border border-slate-200 rounded-lg p-4 bg-slate-50">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-slate-900">Pitch History</h3>
                            <button onclick="togglePitchHistory()" class="text-slate-500 hover:text-slate-700 text-sm">
                                <i id="pitch-history-toggle-icon" class="fa-solid fa-chevron-down mr-1"></i>
                                <span id="pitch-history-toggle-text">Show</span>
                            </button>
                        </div>
                        <div id="pitch-history-content" class="hidden space-y-2">
                            <div id="pitch-history-list" class="space-y-2">
                                <div class="text-center text-slate-500 py-4">Loading pitch history...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Pitch Button -->
                    <button onclick="generatePitch()" id="btn-generate-pitch" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate AI Pitch Presentation
                    </button>
                    
                    <!-- Pitch Preview -->
                    <div id="pitch-preview" class="hidden border border-slate-200 rounded-lg p-4 bg-slate-50">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-slate-900">Generated Pitch Preview</h3>
                            <button onclick="togglePitchPreview()" class="text-slate-500 hover:text-slate-700 text-sm">
                                <i id="pitch-preview-toggle-icon" class="fa-solid fa-chevron-up mr-1"></i>
                                <span id="pitch-preview-toggle-text">Collapse</span>
                            </button>
                        </div>
                        <div id="pitch-preview-content" class="space-y-4">
                            <!-- Sent Status Warning -->
                            <div id="pitch-sent-warning" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-exclamation-triangle text-amber-600"></i>
                                    <span class="text-sm font-medium text-amber-900">This pitch has already been sent. Sending again may result in duplicate messages.</span>
                                </div>
                            </div>
                            <div id="pitch-content" class="prose max-w-none text-slate-900" style="color: #0f172a !important;"></div>
                            <div class="mt-4">
                                <h4 class="text-sm font-medium text-slate-700 mb-3">Send Pitch</h4>
                                <div class="flex gap-2">
                                    <button onclick="showPitchSendPreview('email')" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition">
                                        <i class="fa-solid fa-envelope mr-2"></i>Email
                                    </button>
                                    <button onclick="showPitchSendPreview('whatsapp')" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition">
                                        <i class="fa-brands fa-whatsapp mr-2"></i>WhatsApp
                                    </button>
                                    <button onclick="showPitchSendPreview('linkedin')" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition">
                                        <i class="fa-brands fa-linkedin mr-2"></i>LinkedIn
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW 2: ANALYTICS -->
        <section id="view-analytics" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Real-time Engagement Analytics</h2>
                        <p class="text-slate-600">Track opens, clicks, replies, and engagement across all channels</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshAnalytics()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <div id="polling-status" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm">
                            <i class="fa-solid fa-clock mr-2"></i><span id="last-poll-time">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                        <div class="text-sm text-emerald-700 font-medium mb-1">Total Sent</div>
                        <div class="text-2xl font-bold text-emerald-900" id="stat-total-sent">0</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="text-sm text-blue-700 font-medium mb-1">Opened</div>
                        <div class="text-2xl font-bold text-blue-900" id="stat-opened">0</div>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <div class="text-sm text-indigo-700 font-medium mb-1">Clicked</div>
                        <div class="text-2xl font-bold text-indigo-900" id="stat-clicked">0</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="text-sm text-purple-700 font-medium mb-1">Replied</div>
                        <div class="text-2xl font-bold text-purple-900" id="stat-replied">0</div>
                    </div>
                </div>

                <!-- Channel Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <div class="text-sm text-slate-600 mb-2">Email</div>
                        <div class="text-xl font-bold text-slate-900" id="stat-email">0</div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <div class="text-sm text-slate-600 mb-2">WhatsApp</div>
                        <div class="text-xl font-bold text-slate-900" id="stat-whatsapp">0</div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <div class="text-sm text-slate-600 mb-2">LinkedIn</div>
                        <div class="text-xl font-bold text-slate-900" id="stat-linkedin">0</div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-white border border-slate-200 rounded-lg p-4">
                    <h3 class="font-bold text-slate-800 mb-4">Recent Activities</h3>
                    <div id="recent-activities" class="space-y-2">
                        <div class="text-center text-slate-500 py-8">Loading activities...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW 3: MEETINGS -->
        <section id="view-meetings" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Scheduled Meetings</h2>
                <p class="text-slate-600 mb-6">View and manage meetings scheduled via Cal.com</p>
                
                <div id="meetings-list" class="space-y-4">
                    <div class="text-center text-slate-500 py-8">Loading meetings...</div>
                </div>
            </div>
        </section>


        <!-- VIEW 5: AI TARGET FINDER -->
        <section id="view-ai-finder" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">ü§ñ AI Target Finder</h2>
                        <p class="text-slate-600">AI-powered target identification from your contact database</p>
                    </div>
                </div>

                <!-- Configuration Form -->
                <div class="bg-slate-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Search Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Industry</label>
                            <select id="ai-finder-industry" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Industries</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Minimum Seniority Score</label>
                            <input type="number" id="ai-finder-seniority" min="0" max="1" step="0.1" value="0.5" 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">0.0 = Any level, 1.0 = C-Level only</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Max Results</label>
                            <input type="number" id="ai-finder-limit" min="1" max="100" value="50" 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="runAITargetFinder()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            üîç Find Targets
                        </button>
                        <button onclick="selectAllAIRecommendations()" 
                                class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors font-medium">
                            Select All
                        </button>
                        <button onclick="deselectAllAIRecommendations()" 
                                class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors font-medium">
                            Deselect All
                        </button>
                        <button onclick="createSelectedTargets()" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                            ‚úÖ Create Selected Targets
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="ai-finder-results" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">AI Recommendations</h3>
                        <span id="ai-finder-count" class="text-sm text-slate-600"></span>
                    </div>
                    <div id="ai-finder-list" class="space-y-4">
                        <!-- AI recommendations will be inserted here -->
                    </div>
                </div>

                <!-- Loading State -->
                <div id="ai-finder-loading" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    <p class="mt-4 text-slate-600">Analyzing contacts with AI...</p>
                </div>

                <!-- Empty State -->
                <div id="ai-finder-empty" class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-slate-900">Ready to Find Targets</h3>
                    <p class="mt-2 text-slate-600">Configure your search parameters above and click "Find Targets"</p>
                </div>
            </div>
        </section>

        <!-- VIEW 6: TARGETS (HIT LIST) -->
        <section id="view-targets" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">The Hit List</h2>
                        <p class="text-slate-600">High-priority targets. Click to reveal strategy and outreach script.</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-import-sheets" onclick="importFromSheets(this)" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-download mr-2"></i>Import from Sheets
                        </button>
                        <button id="btn-export-sheets" onclick="exportToSheets(this)" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-upload mr-2"></i>Export to Sheets
                        </button>
                    </div>
                </div>
            </div>

            <!-- Industry Display for Target Hit List -->
            <div id="targets-industry-display" class="mb-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-industry text-emerald-600"></i>
                    <span class="text-sm font-medium text-emerald-900">Active Industry: </span>
                    <span id="targets-industry-name" class="text-sm font-bold text-emerald-700"></span>
                </div>
            </div>
            
            <!-- Search and Filters for Targets -->
            <div class="mb-4 flex gap-2 items-center">
                <div class="flex-1 relative">
                    <input type="text" id="targets-search" placeholder="Search targets by company, contact, or role..." 
                           class="w-full px-4 py-2 border border-slate-300 rounded-lg pr-10"
                           oninput="filterTargets()">
                    <i class="fa-solid fa-search absolute right-3 top-3 text-slate-400"></i>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- List Side -->
                <div class="md:col-span-4 space-y-4">
                    <div id="target-list">
                        <!-- Buttons generated by JS -->
                    </div>
                    <!-- Pagination for Targets -->
                    <div id="targets-pagination" class="flex justify-between items-center mt-4 hidden">
                        <button id="targets-prev" onclick="targetsPreviousPage()" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-chevron-left mr-1"></i>Previous
                        </button>
                        <span id="targets-page-info" class="text-sm text-slate-600"></span>
                        <button id="targets-next" onclick="targetsNextPage()" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Next<i class="fa-solid fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Detail Side -->
                <div class="md:col-span-8">
                    <div id="target-detail" class="bg-white rounded-xl shadow-lg border border-slate-200 p-8 h-full sticky top-24">
                        <div class="flex items-center gap-4 mb-6">
                            <div id="detail-icon" class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-3xl text-slate-400">
                                <i class="fa-solid fa-crosshairs"></i>
                            </div>
                            <div>
                                <h2 id="detail-name" class="text-3xl font-bold text-slate-900">Select a Target</h2>
                                <p id="detail-role" class="text-slate-500 text-lg">To view recon data</p>
                            </div>
                        </div>
                        
                        <div id="detail-content" class="hidden space-y-6">
                            <div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">The Pain Point</h4>
                                <p id="detail-pain" class="text-slate-700 bg-rose-50 border border-rose-100 p-4 rounded-lg">Select a target to see their specific pain point.</p>
                            </div>

                            <div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">The Pitch Angle</h4>
                                <p id="detail-angle" class="text-slate-800 font-medium italic border-l-4 border-indigo-500 pl-4">The strategic angle used to enter the account.</p>
                            </div>

                            <div>
                                <div class="flex justify-between items-end mb-2">
                                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">LinkedIn Script (Trojan Horse)</h4>
                                    <button onclick="copyScript()" class="text-xs text-emerald-600 hover:text-emerald-700 font-bold"><i class="fa-regular fa-copy mr-1"></i>Copy</button>
                                </div>
                                <div class="script-box p-4 rounded-lg text-sm text-slate-700 leading-relaxed overflow-x-auto">
                                    <p id="detail-script">...</p>
                                </div>
                            </div>

                            <!-- Outreach Actions -->
                            <div class="mt-6 pt-6 border-t border-slate-200">
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Send Outreach</h4>
                                <div class="space-y-4">
                                    <!-- Channel Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Channel</label>
                                        <div class="flex gap-3">
                                            <button onclick="selectChannel('email')" id="btn-email" class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg hover:border-emerald-500 transition-colors">
                                                <i class="fa-solid fa-envelope mr-2"></i>Email
                                            </button>
                                            <button onclick="selectChannel('whatsapp')" id="btn-whatsapp" class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg hover:border-emerald-500 transition-colors">
                                                <i class="fa-brands fa-whatsapp mr-2"></i>WhatsApp
                                            </button>
                                            <button onclick="selectChannel('linkedin')" id="btn-linkedin" class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg hover:border-emerald-500 transition-colors">
                                                <i class="fa-brands fa-linkedin mr-2"></i>LinkedIn
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Generate & Preview Section -->
                                    <div id="message-preview-section" class="hidden">
                                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <label class="text-sm font-medium text-slate-700">Generated Message</label>
                                                <button onclick="generateMessage()" class="text-xs text-indigo-600 hover:text-indigo-700 font-bold">
                                                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Regenerate
                                                </button>
                                            </div>
                                            <div id="message-subject-container" class="mb-3 hidden">
                                                <input type="text" id="message-subject" placeholder="Email Subject" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm">
                                            </div>
                                            <textarea id="message-content" rows="6" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm" placeholder="Message will be generated here..."></textarea>
                                            <div class="mt-2 flex gap-2">
                                                <button onclick="sendOutreach()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition">
                                                    <i class="fa-solid fa-paper-plane mr-2"></i>Send Now
                                                </button>
                                                <button onclick="editMessage()" class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-100 transition">
                                                    <i class="fa-solid fa-edit mr-2"></i>Edit
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Generate Button -->
                                    <button onclick="generateMessage()" id="btn-generate" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate AI Message
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW 6: COMPANIES -->
        <section id="view-companies" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Companies</h2>
                        <p class="text-slate-600">Manage company information. Companies are auto-created when importing contacts.</p>
                        <div id="companies-industry-notice" class="hidden mt-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800"><i class="fa-solid fa-info-circle mr-2"></i>Showing companies for: <strong id="companies-industry-name"></strong></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showAddCompanyModal()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-building mr-2"></i>Add Company
                        </button>
                        <button onclick="showPurgeCompaniesModal()" class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-trash mr-2"></i>Purge Selected
                        </button>
                        <button onclick="backfillCompanyDomains()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-magic mr-2"></i>Backfill Domains
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="company-search" placeholder="Search by name, domain, or industry..." class="px-4 py-2 border border-slate-300 rounded-lg text-sm" onkeyup="filterCompanies()">
                    <select id="company-industry-filter" class="px-4 py-2 border border-slate-300 rounded-lg text-sm" onchange="filterCompanies()">
                        <option value="">All Industries</option>
                    </select>
                    <button onclick="loadCompanies()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">
                        <i class="fa-solid fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Companies List -->
            <div id="companies-list" class="space-y-4">
                <div class="text-center text-slate-500 py-8">Loading companies...</div>
            </div>
        </section>

        <!-- VIEW 7: CONTACTS -->
        <section id="view-contacts" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Contacts</h2>
                        <p class="text-slate-600">Manage contacts and import from Excel. Companies are auto-created during import.</p>
                        <div id="contacts-industry-notice" class="hidden mt-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800"><i class="fa-solid fa-info-circle mr-2"></i>Showing contacts for: <strong id="contacts-industry-name"></strong></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showAddContactModal()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-user-plus mr-2"></i>Add Contact
                        </button>
                        <button onclick="showImportExcelModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-file-excel mr-2"></i>Import Excel
                        </button>
                        <button onclick="exportContactsExcel()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-download mr-2"></i>Export Excel
                        </button>
                        <button onclick="exportContactsSheets()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold whitespace-nowrap">
                            <i class="fa-solid fa-table mr-2"></i>Export to Sheets
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="contact-search" placeholder="Search by name, email, phone, company, role, industry, or source..." class="px-4 py-2 border border-slate-300 rounded-lg text-sm" onkeyup="filterContacts()">
                    <select id="contact-company-filter" class="px-4 py-2 border border-slate-300 rounded-lg text-sm" onchange="filterContacts()">
                        <option value="">All Companies</option>
                    </select>
                    <select id="contact-industry-filter" class="px-4 py-2 border border-slate-300 rounded-lg text-sm" onchange="filterContacts()">
                        <option value="">All Industries</option>
                    </select>
                    <button onclick="loadContacts()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">
                        <i class="fa-solid fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Contacts List -->
            <div id="contacts-list" class="space-y-4">
                <div class="text-center text-slate-500 py-8">Loading contacts...</div>
            </div>
        </section>

        <!-- VIEW: ADMIN (SUPER USER ONLY) -->
        <section id="view-admin" class="hidden space-y-8 animate-fade-in">
            <!-- Header Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">
                            <i class="fa-solid fa-shield-halved text-indigo-600 mr-2"></i>Admin
                        </h2>
                        <p class="text-slate-600">System management and configuration (Super Admin Only)</p>
                    </div>
                </div>
            </div>

            <!-- Admin Tabs Navigation -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                <div class="flex gap-6 border-b border-slate-200">
                    <button onclick="switchAdminTab('user-mgmt')" id="admin-tab-user-mgmt" class="admin-tab-btn admin-tab-active pb-3 px-1 border-b-2 border-indigo-600 text-indigo-600 font-medium">
                        <i class="fa-solid fa-user-shield mr-2"></i>User Management
                    </button>
                    <button onclick="switchAdminTab('signatures')" id="admin-tab-signatures" class="admin-tab-btn pb-3 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium">
                        <i class="fa-solid fa-signature mr-2"></i>Signatures
                    </button>
                    <button onclick="switchAdminTab('tools')" id="admin-tab-tools" class="admin-tab-btn pb-3 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium">
                        <i class="fa-solid fa-tools mr-2"></i>Tools
                    </button>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="admin-content-user-mgmt" class="admin-tab-content">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 mb-2">User Management</h3>
                            <p class="text-sm text-slate-600">Manage users, permissions, and access control</p>
                        </div>
                        <button onclick="showAddUserModal()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-user-plus mr-2"></i>Add New User
                        </button>
                    </div>
                </div>

                <!-- Users List -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div id="users-list" class="space-y-4">
                        <div class="text-center text-slate-500 py-8">Loading users...</div>
                    </div>
                </div>
            </div>

            <!-- Signatures Tab -->
            <div id="admin-content-signatures" class="admin-tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 mb-2">Signature Management</h3>
                            <p class="text-sm text-slate-600">Manage email, WhatsApp, and LinkedIn signatures</p>
                        </div>
                        <button onclick="showCreateSignatureForm()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-plus mr-2"></i>Create Signature
                        </button>
                    </div>
                </div>

                <!-- Signatures List -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div id="signatures-list" class="space-y-4">
                        <div class="text-center text-slate-500 py-8">
                            <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading signatures...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Tab (Contact Mgmt) -->
            <div id="admin-content-tools" class="admin-tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 mb-2">Batch Contact Import</h3>
                            <p class="text-sm text-slate-600">Import contacts from Excel file using batch processing with threading and memory management.</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Excel File Path</label>
                            <input type="text" id="admin-excel-file" placeholder="data/the_ai_company.xlsx" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">Relative to project root (e.g., data/filename.xlsx)</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Batch Size</label>
                                <input type="number" id="admin-batch-size" value="100" min="10" max="500" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Threads</label>
                                <input type="number" id="admin-threads" value="4" min="1" max="16" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Sheet Name (Optional)</label>
                            <input type="text" id="admin-sheet" placeholder="Leave empty for all sheets" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="admin-update-existing" class="mr-2">
                                <span class="text-sm text-slate-700">Update existing contacts</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="admin-import-only-new" class="mr-2">
                                <span class="text-sm text-slate-700">Import only new contacts (skip duplicates)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="admin-dry-run" class="mr-2">
                                <span class="text-sm text-slate-700">Dry run (preview only, don't import)</span>
                            </label>
                        </div>
                        
                        <button onclick="runBatchImport()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-play mr-2"></i>Run Batch Import
                        </button>
                        
                        <div id="admin-import-status"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Chosen Palette: Slate (Background), Emerald (Primary Action/Profit), Rose (Negative/Cost), Indigo (Information) -->
    <!-- Application Structure Plan: 
         1. Dashboard: High-level visual summary of the "Coverage Gap" thesis.
         2. Arbitrage: Data comparison to prove the ROI of Vani vs Humans.
         3. Commercial: Interactive calculator to help founders negotiate pricing.
         4. Targets: CRM-like interface to manage the 5 specific leads provided in the report.
    -->
    
    <!-- Visualization & Content Choices:
         - Gap Chart: Doughnut chart to visualize the sheer volume of "Dark Stores" (9M vs 3M).
         - Arbitrage: Comparative visual cards for instant comprehension of cost deltas.
         - Calculator: Interactive input/output to make the business model tangible.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <script>
        // --- NAVIGATION LOGIC (Define early so it's available for onclick handlers) ---
        // Make switchTab globally accessible - define immediately
        function switchTab(tabId) {
            // Prevent non-super users from accessing Admin tab
            if (tabId === 'admin') {
                const isSuperUser = currentUserData && (
                    currentUserData.is_super_user === true || 
                    currentUserData.is_super_user === 'true' || 
                    currentUserData.is_super_user === 1
                );
                if (!isSuperUser) {
                    showToast('error', 'Access Denied', 'Super user access required', 5000);
                    console.warn(`Non-super user attempted to access ${tabId} tab`);
                    return;
                }
            }
            
            // Check AI Target Finder permission (super users and industry admins)
            if (tabId === 'ai-finder') {
                const hasAIFinderAccess = currentUserData && (
                    currentUserData.is_super_user === true || 
                    currentUserData.is_super_user === 'true' || 
                    currentUserData.is_super_user === 1 ||
                    currentUserData.is_industry_admin === true ||
                    currentUserData.is_industry_admin === 'true' ||
                    currentUserData.is_industry_admin === 1
                );
                if (!hasAIFinderAccess) {
                    showToast('error', 'Access Denied', 'AI Target Finder permission required', 5000);
                    console.warn(`User does not have ai_target_finder permission`);
                    return;
                }
            }
            
            // Update Buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('nav-active', 'text-slate-900');
                btn.classList.add('text-slate-500');
            });
            const navBtn = document.getElementById('nav-' + tabId);
            if (navBtn) {
                navBtn.classList.add('nav-active');
                navBtn.classList.remove('text-slate-500');
            }

            // Show Section
            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            const section = document.getElementById('view-' + tabId);
            if (section) {
                section.classList.remove('hidden');
            }
            
            // Show/hide industry selector based on active tab
            const industrySelectorContainer = document.getElementById('industry-selector-container');
            if (industrySelectorContainer) {
                // Only show for Pitch Presentation and Target Hit List
                if (tabId === 'pitch' || tabId === 'targets') {
                    industrySelectorContainer.classList.remove('hidden');
                } else {
                    industrySelectorContainer.classList.add('hidden');
                }
            }

            // Trigger Chart renders if needed
            if (tabId === 'dashboard' && typeof renderGapChart === 'function') renderGapChart();
            if (tabId === 'arbitrage' && typeof renderArbitrageChart === 'function') renderArbitrageChart();
            if (tabId === 'analytics' && typeof refreshAnalytics === 'function') refreshAnalytics();
            if (tabId === 'meetings' && typeof loadMeetings === 'function') loadMeetings();
            if (tabId === 'admin') {
                // Switch to first admin tab by default
                switchAdminTab('user-mgmt');
            }
            if (tabId === 'ai-finder') {
                // Load industries for AI Finder
                loadAIFinderIndustries();
            }
            if (tabId === 'pitch') {
                if (typeof loadPitchTargets === 'function') loadPitchTargets();
                updatePitchIndustryDisplay();
                // Restore pitch if it exists and load history
                if (typeof restorePitchIfExists === 'function') {
                    restorePitchIfExists();
                    // Also check if target is selected and load history
                    setTimeout(() => {
                        const targetId = document.getElementById('pitch-target-select').value;
                        if (targetId && typeof onPitchTargetChange === 'function') {
                            onPitchTargetChange();
                        }
                    }, 100);
                }
            } else {
                // Collapse pitch preview when leaving pitch tab
                const pitchPreviewContent = document.getElementById('pitch-preview-content');
                if (pitchPreviewContent && !pitchPreviewContent.classList.contains('hidden')) {
                    const icon = document.getElementById('pitch-preview-toggle-icon');
                    const text = document.getElementById('pitch-preview-toggle-text');
                    if (icon && text) {
                        pitchPreviewContent.classList.add('hidden');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                        text.textContent = 'Expand';
                    }
                }
            }
            if (tabId === 'companies' && typeof loadCompanies === 'function') loadCompanies();
            if (tabId === 'contacts' && typeof loadContacts === 'function') loadContacts();
            if (tabId === 'targets' && typeof loadTargetsFromAPI === 'function') {
                console.log('Loading targets when switching to targets tab...');
                loadTargetsFromAPI();
                updateTargetsIndustryDisplay();
            }
            if (tabId === 'arbitrage') {
                // Initialize chart when arbitrage tab is opened
                setTimeout(() => {
                    if (typeof initArbitrageChart === 'function') {
                        initArbitrageChart();
                    }
                }, 100);
            }
        }
        
        // Make switchTab globally accessible
        window.switchTab = switchTab;

        // --- DATA STORAGE ---
        let targets = [];
        let allTargets = []; // Store all targets for filtering/pagination
        let targetsPage = 1;
        const targetsPerPage = 20;
        let targetsSearchTerm = '';
        
        // Load targets from API
        async function loadTargetsFromAPI() {
            try {
                console.log('Loading targets from API...');
                const url = currentIndustryId 
                    ? `/api/targets?industry=${currentIndustryId}`
                    : '/api/targets';
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('Targets API response:', data);
                console.log('Targets count:', data.targets ? data.targets.length : 0);
                
                if (data.success && data.targets) {
                    console.log(`Processing ${data.targets.length} targets...`);
                    allTargets = data.targets.map(t => {
                        // Get industry from target, contact, or company
                        let industry = null;
                        if (t.industry_id && allIndustries.length > 0) {
                            const industryObj = allIndustries.find(ind => ind.id === t.industry_id);
                            industry = industryObj ? industryObj.name : null;
                        } else if (t.contact && t.contact.industry) {
                            industry = t.contact.industry;
                        } else if (t.company && t.company.industry) {
                            industry = t.company.industry;
                        }
                        
                        return {
                            id: t.id, // Use actual UUID from database
                            db_id: t.id,
                            name: t.company_name || t.contact_name || 'Unknown',
                            role: `${t.contact_name || ''} (${t.role || ''})`.trim(),
                            color: getColorForTarget(t.company_name),
                            pain: t.pain_point || '',
                            angle: t.pitch_angle || '',
                            script: t.script || '',
                            email: t.email,
                            phone: t.phone,
                            linkedin_url: t.linkedin_url,
                            industry: industry,
                            status: t.status || 'NEW'
                        };
                    });
                    console.log(`Loaded ${allTargets.length} targets...`);
                    targetsPage = 1; // Reset to first page
                    filterTargets(); // Apply search and pagination
                } else if (data.success && Array.isArray(data.targets) && data.targets.length === 0) {
                    // API returned empty array - this is valid, just show empty state
                    console.log('API returned empty targets array (no targets match current industry filter)');
                    allTargets = [];
                    targets = [];
                    renderTargetList();
                } else {
                    // Fallback to hardcoded if API fails
                    console.warn('Failed to load targets from API, using fallback');
                    console.warn('Response data:', data);
                    loadFallbackTargets();
                }
            } catch (error) {
                console.error('Error loading targets:', error);
                loadFallbackTargets();
            }
        }
        
        function getColorForTarget(companyName) {
            const colors = ['bg-blue-600', 'bg-red-600', 'bg-cyan-600', 'bg-orange-500', 'bg-yellow-600', 'bg-purple-600', 'bg-pink-600', 'bg-green-600'];
            const hash = companyName ? companyName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) : 0;
            return colors[hash % colors.length];
        }
        
        function loadFallbackTargets() {
            targets = [
                {
                    id: 'hul',
                    name: 'Hindustan Unilever',
                    role: 'Arun Neelakantan (ED, Customer Dev)',
                    color: 'bg-blue-600',
                    pain: 'Need to drive usage of "Shikhar" app in deep rural areas where literacy is a barrier. Apps work for the top tier, but fail for the bottom tier.',
                    angle: '"Shikhar is great for the top tier. Let Vani drive the bottom tier who can\'t type but can talk."',
                    script: "Hi Arun, been following your work on HUL's digital transformation. We've built Vani, an Agentic AI Voice Sales Officer designed to capture orders from the bottom 50% of retailers who struggle with apps like Shikhar due to literacy or habit. Vani calls them, negotiates in native Hindi/Tamil, and punches orders directly. Would you be open to a pilot on 1,000 'inactive' rural stores to see if we can wake them up?"
                },
                {
                    id: 'britannia',
                    name: 'Britannia Ind.',
                    role: 'Shantanu Gupta (National Sales Dev Mgr)',
                    color: 'bg-red-600',
                    pain: 'Losing market share to regional players (Parle) in rural belts due to lack of real-time reach. Human visits (‚Çπ300) make serving deep rural stores unviable.',
                    angle: '"Real-time coverage of remote villages without adding headcount."',
                    script: "Hi Shantanu, I know RTM efficiency is a priority for Britannia. The cost of a human visit (‚Çπ300) often makes serving deep rural stores unviable. We solve this with Vani‚Äîan autonomous Voice AI agent that costs pennies per call. She can cover your 'dark' rural territories daily without adding headcount. Can we run a 30-day reactivation pilot on your dead stockist list?"
                },
                {
                    id: 'marico',
                    name: 'Marico',
                    role: 'Vaibhav Bhanchawat (COO)',
                    color: 'bg-cyan-600',
                    pain: 'Aggressive expansion into Pharmacies and Cosmetic Stores‚Äînew channels where their current human salesforce is weak.',
                    angle: '"Don\'t hire 1,000 new agents for Pharmacies. Deploy Vani to call every chemist in India tomorrow."',
                    script: "Hi Vaibhav, congrats on the Foods growth. I know expanding into Pharmacies/Cosmetic outlets is key. Instead of hiring a massive new field force, have you considered a Digital Sales Force? Vani (our AI Agent) can call 10,000 pharmacies in a day to stock Saffola/Parachute. Zero latency, full negotiation capability. Happy to demo the voice capability if you have 5 mins."
                },
                {
                    id: 'asianpaints',
                    name: 'Asian Paints',
                    role: 'Yash Batra (Chief Sales Exec)',
                    color: 'bg-orange-500',
                    pain: 'High "Cost to Serve" for small hardware stores (selling putty/primer) compared to big "Beautiful Homes" dealers. 20k+ dealers don\'t justify a weekly visit.',
                    angle: '"Reactivate your 100k inactive dealers profitably."',
                    script: "Hi Yash, Asian Paints owns the dealer network, but the smaller hardware stores remain expensive to serve manually. We built Vani to fix this arbitrage. She is a Voice AI agent that can autonomously manage order collection from your bottom 20k dealers who don't order frequently enough to justify a weekly visit. Would love to show you how she handles 'Hinglish' negotiation."
                },
                {
                    id: 'itc',
                    name: 'ITC Limited',
                    role: 'Hemant Malik (Divisional Chief Exec)',
                    color: 'bg-yellow-600',
                    pain: 'Massive portfolio (Aashirvaad, Bingo, Sunfeast). Retailers forget to order half the SKUs because the human agent is in a rush.',
                    angle: '"Vani never forgets to upsell the new Bingo flavor."',
                    script: "Hi Hemant, the biggest challenge in General Trade is retailers forgetting to order the full SKU range. Humans rush the visit; Vani (our AI agent) doesn't. She memorizes purchase history and upsells specific SKUs (like Bingo or new launches) on every call. We are already seeing high conversion on 'dead' store pilots. Open to a quick chat?"
                }
            ];
            renderTargetList();
        }

        // switchTab function moved to top of script for early availability

        // --- REVENUE SIMULATOR LOGIC ---
        function updateRevenue() {
            const stores = parseInt(document.getElementById('storeInput').value);
            const aov = parseInt(document.getElementById('aovInput').value);
            
            // Update Display Text
            document.getElementById('storeDisplay').innerText = stores.toLocaleString() + " Stores";

            // Calculation Logic
            // Model A: Lazarus (10% conversion, 150 fee)
            const conversionRate = 0.10;
            const successFee = 150;
            const revLazarus = stores * conversionRate * successFee;

            // Model B: Seat (1 agent per 5000 stores, 5000 fee)
            const agentsNeeded = Math.ceil(stores / 5000);
            const seatFee = 5000;
            const revSeat = agentsNeeded * seatFee;

            // Model C: Hybrid (4 calls/mo/store, 10 platform fee, 1.5% comm)
            const callsPerMonth = 4;
            const platformFee = 10;
            const commRate = 0.015;
            // Assuming 25% conversion on regular calls for active stores
            const activeConversion = 0.25; 
            
            const platformRev = stores * callsPerMonth * platformFee;
            const commRev = stores * callsPerMonth * activeConversion * aov * commRate;
            const revHybrid = platformRev + commRev;

            // Update DOM
            document.getElementById('rev-lazarus').innerText = "‚Çπ" + Math.round(revLazarus).toLocaleString();
            document.getElementById('rev-seat').innerText = "‚Çπ" + Math.round(revSeat).toLocaleString();
            document.getElementById('rev-hybrid').innerText = "‚Çπ" + Math.round(revHybrid).toLocaleString();
        }

        // --- TARGET LIST LOGIC ---
        function filterTargets() {
            targetsSearchTerm = document.getElementById('targets-search')?.value.toLowerCase() || '';
            
            // Filter targets by search term
            let filtered = allTargets;
            if (targetsSearchTerm) {
                filtered = allTargets.filter(t => 
                    t.name.toLowerCase().includes(targetsSearchTerm) ||
                    (t.role && t.role.toLowerCase().includes(targetsSearchTerm)) ||
                    (t.industry && t.industry.toLowerCase().includes(targetsSearchTerm))
                );
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filtered.length / targetsPerPage);
            const startIndex = (targetsPage - 1) * targetsPerPage;
            const endIndex = startIndex + targetsPerPage;
            targets = filtered.slice(startIndex, endIndex);
            
            // Update pagination UI
            const paginationDiv = document.getElementById('targets-pagination');
            const pageInfo = document.getElementById('targets-page-info');
            const prevBtn = document.getElementById('targets-prev');
            const nextBtn = document.getElementById('targets-next');
            
            if (filtered.length > targetsPerPage) {
                if (paginationDiv) paginationDiv.classList.remove('hidden');
                if (pageInfo) {
                    pageInfo.textContent = `Page ${targetsPage} of ${totalPages} (${filtered.length} total)`;
                }
                if (prevBtn) prevBtn.disabled = targetsPage === 1;
                if (nextBtn) nextBtn.disabled = targetsPage >= totalPages;
            } else {
                if (paginationDiv) paginationDiv.classList.add('hidden');
            }
            
            renderTargetList(filtered.length);
        }
        
        function targetsPreviousPage() {
            if (targetsPage > 1) {
                targetsPage--;
                filterTargets();
            }
        }
        
        function targetsNextPage() {
            const totalPages = Math.ceil(allTargets.filter(t => 
                !targetsSearchTerm || 
                t.name.toLowerCase().includes(targetsSearchTerm) ||
                (t.role && t.role.toLowerCase().includes(targetsSearchTerm)) ||
                (t.industry && t.industry.toLowerCase().includes(targetsSearchTerm))
            ).length / targetsPerPage);
            if (targetsPage < totalPages) {
                targetsPage++;
                filterTargets();
            }
        }
        
        function renderTargetList(totalCount = null) {
            const container = document.getElementById('target-list');
            if (!container) return;
            container.innerHTML = '';
            
            // Show count if "All Industries" is selected
            if (!currentIndustryId && totalCount !== null && allTargets.length > 0) {
                const countDiv = document.createElement('div');
                countDiv.className = 'mb-3 text-sm text-slate-600';
                countDiv.innerHTML = `<i class="fa-solid fa-info-circle mr-1"></i>Showing ${targets.length} of ${totalCount || allTargets.length} targets across all industries`;
                container.appendChild(countDiv);
            }
            
            if (targets.length === 0) {
                const emptyMsg = targetsSearchTerm 
                    ? `No targets found matching "${targetsSearchTerm}"`
                    : 'No targets found. Use AI Target Finder to identify targets.';
                container.innerHTML = `<div class="text-center text-slate-500 py-8">${emptyMsg}</div>`;
                return;
            }
            
            // Find original index in allTargets for each displayed target
            targets.forEach((t) => {
                const originalIndex = allTargets.findIndex(at => at.id === t.id);
                const btn = document.createElement('div');
                btn.className = 'card-hover bg-white p-4 rounded-lg border border-slate-200 cursor-pointer flex items-center justify-between group';
                btn.onclick = () => loadTarget(originalIndex >= 0 ? originalIndex : targets.indexOf(t));
                const industryBadge = t.industry ? `<span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded ml-2">${t.industry}</span>` : '';
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="${t.color} text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm">${t.name.substring(0,2).toUpperCase()}</div>
                        <div>
                            <div class="flex items-center">
                                <h4 class="font-bold text-slate-800">${t.name}</h4>
                                ${industryBadge}
                            </div>
                            <p class="text-xs text-slate-500 truncate w-40">${t.role.split('(')[0]}</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-emerald-500"></i>
                `;
                container.appendChild(btn);
            });
        }

        // --- TARGETS MANAGEMENT FUNCTIONS (Additional) ---
        // Note: targets, allTargets, targetsPage, targetsPerPage are already declared at line 837-841
        // loadTargetsFromAPI is already defined at line 844
        // This section adds a wrapper function for compatibility
        
        // Alias function - loadTargetsFromAPI already exists above
        if (typeof loadTargets === 'undefined') {
            window.loadTargets = async function loadTargets() {
                // Use existing loadTargetsFromAPI function (declared at line 844)
                if (typeof loadTargetsFromAPI === 'function') {
                    await loadTargetsFromAPI();
                } else {
                    console.error('loadTargetsFromAPI function not found');
                }
            };
        }

        // ========================================
        // AI TARGET FINDER FUNCTIONS
        // ========================================
        
        let aiRecommendations = [];
        
        // Load industries for AI Finder
        async function loadAIFinderIndustries() {
            try {
                const response = await window.fetch('/api/industries', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const industries = data.industries || data || []; // Handle both response formats
                    const select = document.getElementById('ai-finder-industry');
                    if (select) {
                        select.innerHTML = '<option value="">All Industries</option>';
                        industries.forEach(ind => {
                            const option = document.createElement('option');
                            option.value = ind.code;
                            option.textContent = ind.name;
                            select.appendChild(option);
                        });
                        console.log(`Loaded ${industries.length} industries for AI Finder`);
                    }
                }
            } catch (error) {
                console.error('Error loading industries:', error);
            }
        }
        
        // Run AI Target Finder
        async function runAITargetFinder() {
            const industry = document.getElementById('ai-finder-industry').value;
            const minSeniority = parseFloat(document.getElementById('ai-finder-seniority').value);
            const limit = parseInt(document.getElementById('ai-finder-limit').value);
            
            // Show loading
            document.getElementById('ai-finder-empty').classList.add('hidden');
            document.getElementById('ai-finder-results').classList.add('hidden');
            document.getElementById('ai-finder-loading').classList.remove('hidden');
            
            try {
                const response = await window.fetch('/api/targets/ai-identify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        industry: industry || null,
                        min_seniority: minSeniority,
                        limit: limit
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                aiRecommendations = data.recommendations || [];
                
                // Hide loading, show results
                document.getElementById('ai-finder-loading').classList.add('hidden');
                
                if (aiRecommendations.length > 0) {
                    renderAIRecommendations();
                    document.getElementById('ai-finder-results').classList.remove('hidden');
                } else {
                    document.getElementById('ai-finder-empty').classList.remove('hidden');
                    showToast('info', 'No Results', 'No matching contacts found. Try adjusting your search parameters.');
                }
                
            } catch (error) {
                console.error('AI Target Finder error:', error);
                document.getElementById('ai-finder-loading').classList.add('hidden');
                document.getElementById('ai-finder-empty').classList.remove('hidden');
                showToast('error', 'AI Target Finder Failed', error.message);
            }
        }
        
        // Render AI recommendations
        function renderAIRecommendations() {
            const list = document.getElementById('ai-finder-list');
            const count = document.getElementById('ai-finder-count');
            
            count.textContent = `${aiRecommendations.length} recommendations found`;
            list.innerHTML = '';
            
            aiRecommendations.forEach((rec, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <input type="checkbox" 
                               id="ai-rec-${index}" 
                               class="mt-1 h-5 w-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                               checked>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="text-lg font-semibold text-slate-900">${rec.contact_name || 'Unknown'}</h4>
                                    <p class="text-sm text-slate-600">${rec.role || 'No role'} at ${rec.company_name || 'Unknown Company'}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-blue-600">Score: ${(rec.overall_score * 100).toFixed(0)}%</div>
                                    <div class="text-xs text-slate-500">Seniority: ${(rec.seniority_score * 100).toFixed(0)}%</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <span class="text-xs font-medium text-slate-500">Relevance:</span>
                                    <div class="w-full bg-slate-200 rounded-full h-2 mt-1">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: ${rec.relevance_score * 100}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xs font-medium text-slate-500">Engagement:</span>
                                    <div class="w-full bg-slate-200 rounded-full h-2 mt-1">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${rec.engagement_score * 100}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            ${rec.reasoning ? `
                                <div class="bg-blue-50 rounded-lg p-3 mb-2">
                                    <p class="text-sm text-slate-700"><strong>Why this target:</strong> ${rec.reasoning}</p>
                                </div>
                            ` : ''}
                            
                            ${rec.pain_points && rec.pain_points.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-xs font-medium text-slate-500 mb-1">Pain Points:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${rec.pain_points.map(p => `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">${p}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${rec.capability_gaps && rec.capability_gaps.length > 0 ? `
                                <div>
                                    <p class="text-xs font-medium text-slate-500 mb-1">Capability Gaps:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${rec.capability_gaps.map(g => `<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded">${g}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        // Select all AI recommendations
        function selectAllAIRecommendations() {
            aiRecommendations.forEach((_, index) => {
                const checkbox = document.getElementById(`ai-rec-${index}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // Deselect all AI recommendations
        function deselectAllAIRecommendations() {
            aiRecommendations.forEach((_, index) => {
                const checkbox = document.getElementById(`ai-rec-${index}`);
                if (checkbox) checkbox.checked = false;
            });
        }
        
        // Create selected targets
        async function createSelectedTargets() {
            const selectedIndices = [];
            aiRecommendations.forEach((_, index) => {
                const checkbox = document.getElementById(`ai-rec-${index}`);
                if (checkbox && checkbox.checked) {
                    selectedIndices.push(index);
                }
            });
            
            if (selectedIndices.length === 0) {
                showToast('warning', 'No Selection', 'Please select at least one recommendation');
                return;
            }
            
            const selectedRecs = selectedIndices.map(i => aiRecommendations[i]);
            
            try {
                showToast('info', 'Creating Targets', `Creating ${selectedRecs.length} target(s)...`);
                
                const response = await window.fetch('/api/targets/ai-create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        recommendations: selectedRecs,
                        auto_link: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                showToast('success', 'Targets Created', `Successfully created ${data.created_count} target(s)`);
                
                // Remove created recommendations from list
                aiRecommendations = aiRecommendations.filter((_, index) => !selectedIndices.includes(index));
                
                if (aiRecommendations.length > 0) {
                    renderAIRecommendations();
                } else {
                    document.getElementById('ai-finder-results').classList.add('hidden');
                    document.getElementById('ai-finder-empty').classList.remove('hidden');
                }
                
                // Reload targets list
                if (typeof loadTargetsFromAPI === 'function') {
                    loadTargetsFromAPI();
                }
                
            } catch (error) {
                console.error('Create targets error:', error);
                showToast('error', 'Creation Failed', error.message);
            }
        }

        function renderTargets() {
            const container = document.getElementById('target-list');
            if (!container) return;
            
            if (targetsFiltered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8">No targets found</div>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(targetsFiltered.length / targetsPerPage);
            const startIdx = (targetsPage - 1) * targetsPerPage;
            const endIdx = Math.min(startIdx + targetsPerPage, targetsFiltered.length);
            const paginatedTargets = targetsFiltered.slice(startIdx, endIdx);
            
            container.innerHTML = paginatedTargets.map((target, idx) => {
                const initials = (target.contact_name || target.company_name || 'T').substring(0, 2).toUpperCase();
                const color = ['bg-indigo-500', 'bg-emerald-500', 'bg-rose-500', 'bg-amber-500', 'bg-purple-500'][idx % 5];
                return `
                    <button onclick="loadTarget(${startIdx + idx})" class="w-full text-left p-4 bg-white border border-slate-200 rounded-lg hover:border-emerald-500 hover:shadow-md transition-all mb-2">
                        <div class="flex items-center gap-3">
                            <div class="${color} text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">${initials}</div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-900">${target.contact_name || 'Unknown'}</div>
                                <div class="text-sm text-slate-600">${target.company_name || 'Unknown Company'}</div>
                                ${target.role ? `<div class="text-xs text-slate-500">${target.role}</div>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');
            
            // Show pagination if needed
            const paginationDiv = document.getElementById('targets-pagination');
            if (paginationDiv && totalPages > 1) {
                paginationDiv.classList.remove('hidden');
                document.getElementById('targets-page-info').textContent = `Page ${targetsPage} / ${totalPages}`;
                document.getElementById('targets-prev').disabled = targetsPage === 1;
                document.getElementById('targets-next').disabled = targetsPage === totalPages;
            } else if (paginationDiv) {
                paginationDiv.classList.add('hidden');
            }
        }

        // Note: filterTargets, targetsPreviousPage, targetsNextPage, and loadTarget functions
        // are already defined elsewhere in the code (around lines 1004-1106).
        // These duplicate functions have been removed to avoid conflicts.
        // The existing functions handle target filtering, pagination, and loading.

        function copyScript() {
            const text = document.getElementById('detail-script').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Script copied to clipboard!');
            });
        }

        // --- OUTREACH MESSAGE GENERATION ---
        let currentTargetId = null;
        let currentChannel = 'email';
        let currentGeneratedMessage = null;

        function selectChannel(channel) {
            currentChannel = channel;
            // Update button styles
            document.getElementById('btn-email').classList.remove('border-emerald-500', 'bg-emerald-50');
            document.getElementById('btn-whatsapp').classList.remove('border-emerald-500', 'bg-emerald-50');
            document.getElementById('btn-linkedin').classList.remove('border-emerald-500', 'bg-emerald-50');
            
            const selectedBtn = document.getElementById('btn-' + channel);
            if (selectedBtn) {
                selectedBtn.classList.add('border-emerald-500', 'bg-emerald-50');
            }
            
            // Show/hide subject for email
            if (channel === 'email') {
                document.getElementById('message-subject-container').classList.remove('hidden');
            } else {
                document.getElementById('message-subject-container').classList.add('hidden');
            }
        }

        async function generateMessage() {
            if (!currentTargetId) {
                alert('Please select a target first');
                return;
            }
            
            // Validate that currentTargetId is a UUID (not a fallback target)
            const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidPattern.test(currentTargetId)) {
                alert('Cannot generate message for demo target. Please select a target from the database or add targets first.');
                return;
            }

            const btn = document.getElementById('btn-generate');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generating...';

            try {
                const response = await fetch('/api/messages/generate', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_id: currentTargetId,
                        channel: currentChannel
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentGeneratedMessage = data.message;
                    document.getElementById('message-content').value = data.message;
                    if (data.subject) {
                        document.getElementById('message-subject').value = data.subject;
                    }
                    document.getElementById('message-preview-section').classList.remove('hidden');
                    document.getElementById('btn-generate').classList.add('hidden');
                    showToast('success', 'OK - Message Generated', 'AI message generated successfully. Review and edit if needed.', 3000);
                } else {
                    showToast('error', 'Not OK - Generation Failed', data.error || 'Failed to generate message', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate AI Message';
            }
        }

        function editMessage() {
            const textarea = document.getElementById('message-content');
            textarea.readOnly = false;
            textarea.focus();
        }

        async function sendOutreach() {
            if (!currentTargetId) {
                showToast('warning', 'No Target Selected', 'Please select a target first', 3000);
                return;
            }
            
            // Validate that currentTargetId is a UUID (not a fallback target)
            const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidPattern.test(currentTargetId)) {
                showToast('error', 'Invalid Target', 'Cannot send outreach for demo target. Please select a target from the database.', 5000);
                return;
            }

            const message = document.getElementById('message-content').value;
            const subject = document.getElementById('message-subject').value;

            if (!message.trim()) {
                showToast('warning', 'Empty Message', 'Message cannot be empty', 3000);
                return;
            }

            if (currentChannel === 'email' && !subject.trim()) {
                showToast('warning', 'Missing Subject', 'Email subject is required', 3000);
                return;
            }

            if (!confirm(`Send ${currentChannel} message to this target?`)) {
                return;
            }

            // Show processing toast
            showToast('info', 'Sending...', `Sending ${currentChannel} message...`, 2000);

            try {
                const response = await fetch('/api/outreach/send', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_id: currentTargetId,
                        channel: currentChannel,
                        message: message,
                        subject: subject,
                        approved: true
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('success', 'OK - Message Sent', `Message sent successfully via ${currentChannel}`, 4000);
                    // Reset UI
                    document.getElementById('message-preview-section').classList.add('hidden');
                    document.getElementById('btn-generate').classList.remove('hidden');
                    document.getElementById('message-content').value = '';
                    document.getElementById('message-subject').value = '';
                } else {
                    const errorMsg = data.error || 'Failed to send message';
                    if (data.skipped && errorMsg.includes('weekend')) {
                        showToast('warning', 'Not OK - Skipped', 'Outreach is excluded on weekends', 4000);
                    } else {
                        showToast('error', 'Not OK - Send Failed', errorMsg, 5000);
                    }
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message || 'Network error. Check console for details.', 5000);
            }
        }

        function loadTarget(index) {
            const t = targets[index];
            // CRITICAL FIX: Use actual UUID from database, not company name
            currentTargetId = t.id; // This is now the UUID from database
            if (!currentTargetId) {
                alert('Error: Target ID not found. Please refresh the page.');
                return;
            }
            document.getElementById('detail-content').classList.remove('hidden');
            document.getElementById('detail-icon').innerHTML = `<div class="${t.color} text-white w-full h-full rounded-full flex items-center justify-center font-bold text-2xl">${t.name.substring(0,2)}</div>`;
            document.getElementById('detail-name').innerText = t.name;
            document.getElementById('detail-role').innerText = t.role;
            document.getElementById('detail-pain').innerText = t.pain || 'No pain point specified';
            document.getElementById('detail-angle').innerText = t.angle || 'No pitch angle specified';
            document.getElementById('detail-script').innerText = t.script || 'No script available';
            
            // Reset message preview
            document.getElementById('message-preview-section').classList.add('hidden');
            document.getElementById('btn-generate').classList.remove('hidden');
            selectChannel('email'); // Default to email
        }
        
        // Analytics functions
        async function refreshAnalytics() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    credentials: 'include'
                });
                
                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Analytics API error:', response.status, errorText);
                    showToast('error', 'Not OK - Analytics Failed', `Server error (${response.status}). Check console for details.`, 5000);
                    return;
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    showToast('error', 'Not OK - Invalid Response', 'Server returned non-JSON response. Check console for details.', 5000);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.stats) {
                    const stats = data.stats;
                    document.getElementById('stat-total-sent').textContent = stats.activities.total || 0;
                    document.getElementById('stat-opened').textContent = stats.activities.by_status.opened || 0;
                    document.getElementById('stat-clicked').textContent = stats.activities.by_status.clicked || 0;
                    document.getElementById('stat-replied').textContent = stats.activities.by_status.replied || 0;
                    document.getElementById('stat-email').textContent = stats.activities.by_channel.email || 0;
                    document.getElementById('stat-whatsapp').textContent = stats.activities.by_channel.whatsapp || 0;
                    document.getElementById('stat-linkedin').textContent = stats.activities.by_channel.linkedin || 0;
                    
                    // Update recent activities
                    const recentActivities = stats.recent_activities || [];
                    const activitiesHtml = recentActivities.length > 0 ? recentActivities.map(a => `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div>
                                <div class="font-medium text-slate-800">${a.channel || 'Unknown'} to ${a.target_id ? a.target_id.substring(0, 8) : 'Unknown'}</div>
                                <div class="text-xs text-slate-500">${a.created_at ? new Date(a.created_at).toLocaleString() : 'N/A'}</div>
                            </div>
                            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-medium">${a.status || 'unknown'}</span>
                        </div>
                    `).join('') : '<div class="text-center text-slate-500 py-4">No activities yet</div>';
                    document.getElementById('recent-activities').innerHTML = activitiesHtml;
                    
                    // Update polling status
                    const now = new Date();
                    document.getElementById('last-poll-time').textContent = `Last updated: ${now.toLocaleTimeString()}`;
                } else {
                    showToast('warning', 'Analytics Warning', data.error || 'No data available', 4000);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('error', 'Not OK - Analytics Failed', error.message || 'Failed to load analytics', 5000);
            }
        }
        
        // Meetings functions
        async function loadMeetings() {
            try {
                const response = await fetch('/api/meetings', {
                    credentials: 'include'
                });
                
                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Meetings API error:', response.status, errorText);
                    showToast('error', 'Not OK - Meetings Failed', `Server error (${response.status}). Check console for details.`, 5000);
                    return;
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    showToast('error', 'Not OK - Invalid Response', 'Server returned non-JSON response. Check console for details.', 5000);
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.meetings) {
                    const meetingsHtml = data.meetings.map(m => `
                        <div class="bg-white border border-slate-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-slate-800">Meeting with Target</div>
                                    <div class="text-sm text-slate-600 mt-1">${new Date(m.scheduled_at).toLocaleString()}</div>
                                    ${m.meeting_url ? `<a href="${m.meeting_url}" target="_blank" class="text-emerald-600 hover:underline text-sm mt-2 inline-block">Join Meeting</a>` : ''}
                                </div>
                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-medium">${m.status}</span>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('meetings-list').innerHTML = meetingsHtml || '<div class="text-center text-slate-500 py-8">No meetings scheduled</div>';
                }
            } catch (error) {
                console.error('Error loading meetings:', error);
                document.getElementById('meetings-list').innerHTML = '<div class="text-center text-slate-500 py-8">Failed to load meetings</div>';
            }
        }
        
        // HIT Notifications
        let notificationsOpen = false;
        
        function toggleNotifications() {
            notificationsOpen = !notificationsOpen;
            const dropdown = document.getElementById('notification-dropdown');
            if (notificationsOpen) {
                dropdown.classList.remove('hidden');
                loadNotifications();
            } else {
                dropdown.classList.add('hidden');
            }
        }
        
        async function loadNotifications() {
            try {
                // Get recent HITs (opens, clicks, replies, meetings)
                const [statsRes, meetingsRes] = await Promise.all([
                    fetch('/api/dashboard/stats', { credentials: 'include' }),
                    fetch('/api/meetings?status=scheduled', { credentials: 'include' })
                ]);
                
                const stats = await statsRes.json();
                const meetings = await meetingsRes.json();
                
                let notifications = [];
                
                // Add opened emails
                if (stats.success && stats.stats.activities.by_status.opened > 0) {
                    notifications.push({
                        type: 'email_opened',
                        message: `${stats.stats.activities.by_status.opened} email(s) opened`,
                        time: 'Recent',
                        icon: 'fa-envelope-open',
                        color: 'text-blue-600'
                    });
                }
                
                // Add clicked emails
                if (stats.success && stats.stats.activities.by_status.clicked > 0) {
                    notifications.push({
                        type: 'email_clicked',
                        message: `${stats.stats.activities.by_status.clicked} email(s) clicked`,
                        time: 'Recent',
                        icon: 'fa-mouse-pointer',
                        color: 'text-indigo-600'
                    });
                }
                
                // Add replied emails
                if (stats.success && stats.stats.activities.by_status.replied > 0) {
                    notifications.push({
                        type: 'email_replied',
                        message: `${stats.stats.activities.by_status.replied} email(s) replied`,
                        time: 'Recent',
                        icon: 'fa-reply',
                        color: 'text-emerald-600'
                    });
                }
                
                // Add scheduled meetings
                if (meetings.success && meetings.meetings.length > 0) {
                    notifications.push({
                        type: 'meeting_scheduled',
                        message: `${meetings.meetings.length} meeting(s) scheduled`,
                        time: 'Recent',
                        icon: 'fa-calendar-check',
                        color: 'text-purple-600'
                    });
                }
                
                // Update badge
                const badge = document.getElementById('notification-badge');
                if (notifications.length > 0) {
                    badge.classList.remove('hidden');
                    badge.textContent = notifications.length;
                } else {
                    badge.classList.add('hidden');
                }
                
                // Render notifications
                const list = document.getElementById('notification-list');
                if (notifications.length > 0) {
                    list.innerHTML = notifications.map(n => `
                        <div class="p-3 hover:bg-slate-50 rounded-lg cursor-pointer">
                            <div class="flex items-start gap-3">
                                <i class="fa-solid ${n.icon} ${n.color} mt-1"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-slate-800">${n.message}</div>
                                    <div class="text-xs text-slate-500 mt-1">${n.time}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="text-center text-slate-500 py-4 text-sm">No new notifications</div>';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        // Google Sheets functions
        async function importFromSheets(buttonElement) {
            if (!confirm('Import targets from Google Sheets? This will add new targets to the database.')) return;
            
            const btn = buttonElement || document.getElementById('btn-import-sheets');
            if (!btn) {
                alert('Error: Button not found');
                return;
            }
            
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Importing...';
                
                const response = await fetch('/api/targets/import', { 
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('success', 'OK - Import Successful', `Imported ${data.imported} targets from Google Sheets`, 4000);
                    loadTargetsFromAPI(); // Reload targets
                } else {
                    const errorMsg = data.error || 'Failed to import';
                    if (errorMsg.includes('credentials') || errorMsg.includes('not found') || errorMsg.includes('ValueError')) {
                        showToast('warning', 'Not OK - Not Configured', 'Google Sheets not configured. Add credentials to .env.local', 6000);
                    } else if (errorMsg.includes('index') || errorMsg.includes('empty') || errorMsg.includes('No data')) {
                        showToast('error', 'Not OK - Empty Sheet', 'Google Sheets is empty or "Targets" sheet not found', 6000);
                    } else {
                        showToast('error', 'Not OK - Import Failed', errorMsg, 5000);
                    }
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('error', 'Not OK - Network Error', error.message || 'Network error. Check console for details.', 5000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        async function exportToSheets(buttonElement) {
            if (!confirm('Export all targets to Google Sheets?')) return;
            
            const btn = buttonElement || document.getElementById('btn-export-sheets');
            if (!btn) {
                alert('Error: Button not found');
                return;
            }
            
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Exporting...';
                
                const response = await fetch('/api/targets/export', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('success', 'OK - Export Successful', `Exported ${data.exported} targets to Google Sheets`, 4000);
                } else {
                    const errorMsg = data.error || 'Failed to export';
                    if (errorMsg.includes('credentials') || errorMsg.includes('not found') || errorMsg.includes('ValueError')) {
                        showToast('warning', 'Not OK - Not Configured', 'Google Sheets not configured. Add credentials to .env.local', 6000);
                    } else if (errorMsg.includes('No targets')) {
                        showToast('warning', 'Not OK - No Data', 'No targets to export. Please add targets first.', 4000);
                    } else {
                        showToast('error', 'Not OK - Export Failed', errorMsg, 5000);
                    }
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', 'Not OK - Network Error', error.message || 'Network error. Check console for details.', 5000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // --- CHART JS SETUP ---
        let gapChartInstance = null;
        let arbChartInstance = null;

        function renderGapChart() {
            const ctx = document.getElementById('gapChart').getContext('2d');
            if (gapChartInstance) return; // Prevent re-render

            gapChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Direct Coverage (Humans)', 'The Void (Dark Stores)'],
                    datasets: [{
                        data: [3, 9], // 3M vs 9M approx
                        backgroundColor: ['#e2e8f0', '#4f46e5'], // Slate vs Indigo
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + ' Million Stores';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        function renderArbitrageChart() {
            const ctx = document.getElementById('arbitrageChart').getContext('2d');
            if (arbChartInstance) return;

            arbChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Human Salesman', 'Vani (AI)'],
                    datasets: [{
                        label: 'Cost Per Visit (‚Çπ)',
                        data: [300, 10],
                        backgroundColor: ['#f43f5e', '#10b981'], // Rose vs Emerald
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Cost in Rupees (‚Çπ)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fa-solid ${icons[type] || icons.info} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }
        
        // --- USER MANAGEMENT FUNCTIONS (SUPER USER ONLY) ---
        let currentUserData = null;
        let allUsers = [];
        let allUseCases = [];

        async function checkSuperUser() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Session check failed:', response.status);
                    // If 401, redirect to login
                    if (response.status === 401) {
                        window.location.href = '/login';
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('Session data:', data); // Debug log
                
                if (data.success && data.user) {
                    currentUserData = data.user;
                    console.log('User is_super_user:', data.user.is_super_user); // Debug log
                    
                    // Update user info in header
                    updateUserInfo(data.user);
                    
                    // Show Admin tab for super users (includes User Management)
                    const adminNavBtn = document.getElementById('nav-admin');
                    if (adminNavBtn) {
                        if (data.user.is_super_user === true || data.user.is_super_user === 'true' || data.user.is_super_user === 1) {
                            adminNavBtn.style.display = 'block';
                            adminNavBtn.classList.remove('hidden');
                            console.log('Admin Tools tab shown - user is super user');
                        } else {
                            adminNavBtn.style.display = 'none';
                            adminNavBtn.classList.add('hidden');
                        }
                    }
                    
                    // Show AI Target Finder tab if user has permission (super users and industry admins have it by default)
                    const aiFinderNavBtn = document.getElementById('nav-ai-finder');
                    if (aiFinderNavBtn) {
                        const hasAIFinderAccess = data.user.is_super_user === true || 
                                                 data.user.is_super_user === 'true' || 
                                                 data.user.is_super_user === 1 ||
                                                 data.user.is_industry_admin === true ||
                                                 data.user.is_industry_admin === 'true' ||
                                                 data.user.is_industry_admin === 1;
                        if (hasAIFinderAccess) {
                            aiFinderNavBtn.style.display = 'block';
                            aiFinderNavBtn.classList.remove('hidden');
                            console.log('AI Target Finder tab shown - user has access');
                        } else {
                            aiFinderNavBtn.style.display = 'none';
                            aiFinderNavBtn.classList.add('hidden');
                        }
                    }
                    
                    // Check tab permissions
                    checkContactManagementPermission();
                    checkCompanyManagementPermission();
                } else {
                    console.error('No user data in session response:', data);
                    // Redirect to login if no user
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error checking user:', error);
                // Redirect to login on error
                window.location.href = '/login';
            }
        }
        
        // Check contact_management permission
        async function checkContactManagementPermission() {
            try {
                const response = await fetch('/api/contacts?limit=1', { credentials: 'include' });
                if (response.status === 403) {
                    const contactsTab = document.getElementById('nav-contacts');
                    if (contactsTab) {
                        contactsTab.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking contact management permission:', error);
            }
        }
        
        // Check company_management permission
        async function checkCompanyManagementPermission() {
            try {
                const response = await fetch('/api/companies?limit=1', { credentials: 'include' });
                if (response.status === 403) {
                    const companiesTab = document.getElementById('nav-companies');
                    if (companiesTab) {
                        companiesTab.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking company management permission:', error);
            }
        }
        
        // Show industry notice for industry admins in Contacts tab
        function showIndustryNoticeForContacts() {
            if (!currentUserData) return;
            
            const isIndustryAdmin = currentUserData.is_industry_admin === true || currentUserData.is_industry_admin === 'true' || currentUserData.is_industry_admin === 1;
            const isSuperUser = currentUserData.is_super_user === true || currentUserData.is_super_user === 'true' || currentUserData.is_super_user === 1;
            
            const noticeDiv = document.getElementById('contacts-industry-notice');
            const industryNameSpan = document.getElementById('contacts-industry-name');
            
            if (noticeDiv && industryNameSpan && isIndustryAdmin && !isSuperUser && currentUserData.industry_name) {
                industryNameSpan.textContent = currentUserData.industry_name;
                noticeDiv.classList.remove('hidden');
            } else if (noticeDiv) {
                noticeDiv.classList.add('hidden');
            }
        }
        
        // Show industry notice for industry admins in Companies tab
        function showIndustryNoticeForCompanies() {
            if (!currentUserData) return;
            
            const isIndustryAdmin = currentUserData.is_industry_admin === true || currentUserData.is_industry_admin === 'true' || currentUserData.is_industry_admin === 1;
            const isSuperUser = currentUserData.is_super_user === true || currentUserData.is_super_user === 'true' || currentUserData.is_super_user === 1;
            
            const noticeDiv = document.getElementById('companies-industry-notice');
            const industryNameSpan = document.getElementById('companies-industry-name');
            
            if (noticeDiv && industryNameSpan && isIndustryAdmin && !isSuperUser && currentUserData.industry_name) {
                industryNameSpan.textContent = currentUserData.industry_name;
                noticeDiv.classList.remove('hidden');
            } else if (noticeDiv) {
                noticeDiv.classList.add('hidden');
            }
        }
        
        function updateUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userBadges = document.getElementById('user-badges');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (userInfo && userName && logoutBtn) {
                userName.textContent = user.name || user.email || 'User';
                
                // Add badges
                if (userBadges) {
                    let badges = '';
                    if (user.is_super_user) {
                        badges += '<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded mr-1">Super User</span>';
                    }
                    if (user.is_industry_admin) {
                        badges += '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">Admin</span>';
                    }
                    userBadges.innerHTML = badges;
                }
                
                userInfo.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            }
        }
        
        async function handleLogout() {
            if (!confirm('Are you sure you want to sign out?')) {
                return;
            }
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Redirect to login regardless of response
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect to login
                window.location.href = '/login';
            }
        }

        // --- CHART INITIALIZATION ---
        let arbitrageChart = null;
        
        function initArbitrageChart() {
            const ctx = document.getElementById('arbitrageChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (arbitrageChart) {
                try {
                    arbitrageChart.destroy();
                } catch (e) {
                    console.warn('Error destroying existing chart:', e);
                }
                arbitrageChart = null;
            }
            
            // Also check if Chart.js has already registered a chart on this canvas
            // Chart.js stores charts in Chart.instances or Chart.getChart()
            try {
                const existingChart = Chart.getChart(ctx);
                if (existingChart) {
                    existingChart.destroy();
                }
            } catch (e) {
                // Chart.getChart might not be available in all versions
                console.warn('Could not check for existing chart:', e);
            }
            
            arbitrageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Human Salesman', 'App Notification', 'Vani (AI)'],
                    datasets: [{
                        label: 'Cost Per Interaction (‚Çπ)',
                        data: [300, 0.10, 7.5],
                        backgroundColor: ['#ef4444', '#94a3b8', '#10b981'],
                        borderColor: ['#dc2626', '#64748b', '#059669'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cost: ‚Çπ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- TAB SWITCHING FUNCTION (DUPLICATE REMOVED) ---
        // Note: switchTab is already defined at line 758. This duplicate has been removed.

        async function loadUsers() {
            try {
                console.log('Loading users...');
                const response = await fetch('/api/auth/users', {
                    credentials: 'include'
                });
                
                console.log('Users API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Users API error:', response.status, errorText);
                    
                    if (response.status === 403) {
                        showToast('error', 'Access Denied', 'Super user access required', 5000);
                        return;
                    }
                    if (response.status === 401) {
                        showToast('error', 'Unauthorized', 'Please login again', 5000);
                        return;
                    }
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        showToast('error', 'Failed', errorData.error || `HTTP ${response.status}`, 5000);
                    } catch {
                        showToast('error', 'Failed', `Server error: ${response.status}`, 5000);
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('Users data:', data);
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    console.log(`Loaded ${allUsers.length} users`);
                    renderUsersList();
                } else {
                    console.error('Invalid response format:', data);
                    showToast('error', 'Failed', data.error || 'Failed to load users', 5000);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('error', 'Failed', `Failed to load users: ${error.message}`, 5000);
            }
        }

        async function loadUseCases() {
            try {
                const response = await fetch('/api/permissions/use-cases', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.use_cases) {
                    allUseCases = data.use_cases;
                }
            } catch (error) {
                console.error('Error loading use cases:', error);
            }
        }
        
        // Industry management
        let allIndustries = [];
        let currentIndustryId = null;
        
        async function loadIndustries() {
            try {
                const response = await fetch('/api/industries', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.industries) {
                    allIndustries = data.industries;
                    const selector = document.getElementById('industry-selector');
                    if (selector) {
                        selector.innerHTML = '<option value="">All Industries</option>' +
                            data.industries.map(ind => 
                                `<option value="${ind.id}">${ind.name}</option>`
                            ).join('');
                        
                        // Set default industry (prioritize default_industry_id, then active_industry_id)
                        let defaultIndustryId = null;
                        if (currentUserData) {
                            defaultIndustryId = currentUserData.default_industry_id || currentUserData.active_industry_id;
                        }
                        
                        if (defaultIndustryId) {
                            selector.value = defaultIndustryId;
                            currentIndustryId = defaultIndustryId;
                            updateIndustryBadge();
                            // Update industry display on targets tab
                            updateTargetsIndustryDisplay();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading industries:', error);
            }
        }
        
        async function switchIndustry(industryId) {
            try {
                const response = await fetch('/api/industries/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ industry_id: industryId || null })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentIndustryId = industryId;
                    updateIndustryBadge();
                    updateTargetsIndustryDisplay();
                    showToast('success', 'Industry Switched', `Active industry: ${data.industry?.name || 'All Industries'}`, 3000);
                    
                    // Reload current view to reflect industry change
                    const currentTab = document.querySelector('.nav-active')?.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
                    if (currentTab) {
                        switchTab(currentTab);
                    }
                } else {
                    showToast('error', 'Failed', data.error || 'Failed to switch industry', 5000);
                }
            } catch (error) {
                console.error('Error switching industry:', error);
                showToast('error', 'Failed', `Failed to switch industry: ${error.message}`, 5000);
            }
        }
        
        function updateIndustryBadge() {
            const badge = document.getElementById('industry-badge');
            if (currentIndustryId && allIndustries.length > 0) {
                const industry = allIndustries.find(ind => ind.id === currentIndustryId);
                if (industry && badge) {
                    badge.textContent = industry.name;
                    badge.classList.remove('hidden');
                }
            } else if (badge) {
                badge.classList.add('hidden');
            }
        }
        
        function updateTargetsIndustryDisplay() {
            const displayDiv = document.getElementById('targets-industry-display');
            const nameSpan = document.getElementById('targets-industry-name');
            
            if (currentIndustryId && allIndustries.length > 0) {
                const industry = allIndustries.find(ind => ind.id === currentIndustryId);
                if (industry && displayDiv && nameSpan) {
                    nameSpan.textContent = industry.name;
                    displayDiv.classList.remove('hidden');
                }
            } else if (displayDiv) {
                displayDiv.classList.add('hidden');
            }
            
            // Also update pitch presentation industry display
            updatePitchIndustryDisplay();
        }
        
        function updatePitchIndustryDisplay() {
            const displayDiv = document.getElementById('pitch-industry-display');
            const nameSpan = document.getElementById('pitch-industry-name');
            
            if (currentIndustryId && allIndustries.length > 0) {
                const industry = allIndustries.find(ind => ind.id === currentIndustryId);
                if (industry && displayDiv && nameSpan) {
                    nameSpan.textContent = industry.name;
                    displayDiv.classList.remove('hidden');
                }
            } else if (displayDiv) {
                displayDiv.classList.add('hidden');
            }
        }

        async function renderUsersList() {
            const container = document.getElementById('users-list');
            if (!container) return;
            if (!allUsers || allUsers.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8">No users found</div>';
                return;
            }

            // Load user industries for each user
            const usersWithIndustries = await Promise.all(allUsers.map(async (user) => {
                try {
                    const response = await fetch(`/api/user-industries/${user.id}`, {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            user.assigned_industries = data.industries || [];
                            user.default_industry_id = data.default_industry_id;
                        }
                    }
                } catch (error) {
                    console.error(`Error loading industries for user ${user.id}:`, error);
                }
                return user;
            }));

            container.innerHTML = usersWithIndustries.map(user => {
                // Show assigned industries
                const assignedIndustries = user.assigned_industries || [];
                const defaultIndustry = assignedIndustries.find(ind => ind.is_default);
                const industriesList = assignedIndustries.length > 0 
                    ? assignedIndustries.map(ind => `${ind.name}${ind.is_default ? ' (Default)' : ''}`).join(', ')
                    : 'No Industries Assigned';
                
                return `
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-slate-900">${(user.name || user.email || 'Unknown').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                                ${user.is_super_user ? '<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded">Super User</span>' : ''}
                                ${user.is_industry_admin ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">Industry Admin</span>' : ''}
                            </div>
                            <p class="text-sm text-slate-600 mb-1">${(user.email || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            <p class="text-xs text-slate-500 mb-3">
                                <i class="fa-solid fa-industry mr-1"></i>Industries: <span class="font-medium">${industriesList}</span>
                            </p>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="manageUserIndustries('${user.id}')" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">
                                    <i class="fa-solid fa-industry mr-1"></i>Manage Industries
                                </button>
                                <button onclick="managePermissions('${user.id}')" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">
                                    <i class="fa-solid fa-key mr-1"></i>Manage Permissions
                                </button>
                                <button onclick="toggleSuperUser('${user.id}', ${user.is_super_user})" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">
                                    ${user.is_super_user ? '<i class="fa-solid fa-user-shield mr-1"></i>Remove Super User' : '<i class="fa-solid fa-user-shield mr-1"></i>Make Super User'}
                                </button>
                                <button onclick="toggleIndustryAdmin('${user.id}', ${user.is_industry_admin}, '${user.industry_id || ''}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                                    ${user.is_industry_admin ? '<i class="fa-solid fa-building mr-1"></i>Remove Admin' : '<i class="fa-solid fa-building mr-1"></i>Make Admin'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        async function assignIndustryToUser(userId) {
            if (allIndustries.length === 0) {
                await loadIndustries();
            }
            
            if (allIndustries.length === 0) {
                showToast('error', 'No Industries', 'No industries available. Please create an industry first.', 5000);
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-900">Assign Industry to ${(user.email || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Industry</label>
                        <select id="assign-industry-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            <option value="">-- No Industry --</option>
                            ${allIndustries.map(ind => 
                                `<option value="${ind.id}" ${(user.industry_id === ind.id || user.active_industry_id === ind.id) ? 'selected' : ''}>${ind.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm">
                            Cancel
                        </button>
                        <button onclick="confirmAssignIndustry('${userId}')" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">
                            <i class="fa-solid fa-check mr-1"></i>Assign
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function confirmAssignIndustry(userId) {
            const select = document.getElementById('assign-industry-select');
            if (!select) return;
            
            const industryId = select.value || null;
            
            try {
                const response = await fetch(`/api/auth/users/${userId}/assign_industry`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ industry_id: industryId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Industry Assigned', data.message || 'Industry assigned successfully', 3000);
                    const modal = document.querySelector('.fixed');
                    if (modal) modal.remove();
                    loadUsers();
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to assign industry', 5000);
                }
            } catch (error) {
                console.error('Error assigning industry:', error);
                showToast('error', 'Not OK - Failed', 'Failed to assign industry', 5000);
            }
        }
        
        async function manageUserIndustries(userId) {
            if (allIndustries.length === 0) {
                await loadIndustries();
            }
            
            if (allIndustries.length === 0) {
                showToast('error', 'No Industries', 'No industries available. Please create an industry first.', 5000);
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Load user's current industries
            let userIndustries = [];
            let defaultIndustryId = null;
            try {
                const response = await fetch(`/api/user-industries/${userId}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        userIndustries = data.industries || [];
                        defaultIndustryId = data.default_industry_id;
                    }
                }
            } catch (error) {
                console.error('Error loading user industries:', error);
            }
            
            const assignedIndustryIds = userIndustries.map(ui => ui.id);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'manage-industries-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-900">Manage Industries: ${(user.email || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                        <button onclick="document.getElementById('manage-industries-modal').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Multi-Selection Search Box -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Search & Add Industries <span class="text-xs text-slate-500">(Type "*" to show all, use checkboxes for multi-select)</span>
                        </label>
                        <div class="relative">
                            <input type="text" id="industry-search" placeholder="Type to search or * for all industries..." 
                                   class="w-full px-3 py-2 border border-slate-300 rounded-lg pr-10"
                                   oninput="filterIndustries()"
                                   onfocus="filterIndustries()">
                            <i class="fa-solid fa-search absolute right-3 top-3 text-slate-400"></i>
                        </div>
                        <div id="industry-search-results" class="mt-2 max-h-64 overflow-y-auto border border-slate-200 rounded-lg bg-white shadow-sm"></div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="selectAllAvailableIndustries()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold flex-1">
                                <i class="fa-solid fa-check-double mr-2"></i>Select All
                            </button>
                            <button onclick="deselectAllIndustries()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm font-bold flex-1">
                                <i class="fa-solid fa-times mr-2"></i>Deselect All
                            </button>
                            <button onclick="addSelectedIndustries()" id="add-selected-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold flex-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa-solid fa-plus mr-2"></i>Add Selected (<span id="selected-count">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Assigned Industries -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Assigned Industries</label>
                        <div id="assigned-industries-list" class="space-y-2">
                            ${userIndustries.length === 0 ? '<p class="text-sm text-slate-500">No industries assigned</p>' : ''}
                            ${userIndustries.map(ui => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span class="font-medium">${ui.name}</span>
                                        ${ui.is_default ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded">Default</span>' : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        ${!ui.is_default ? `<button onclick="setDefaultIndustry('${userId}', '${ui.id}')" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-xs">
                                            Set Default
                                        </button>` : ''}
                                        <button onclick="removeUserIndustry('${userId}', '${ui.id}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                            <i class="fa-solid fa-times mr-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="document.getElementById('manage-industries-modal').remove()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store for use in filter function
            window.currentUserId = userId;
            window.assignedIndustryIds = assignedIndustryIds;
            
            // Show all industries when input is focused (if empty)
            const searchInput = document.getElementById('industry-search');
            if (searchInput) {
                // Trigger filter on focus to show all if empty
                searchInput.addEventListener('focus', () => {
                    if (!searchInput.value) {
                        filterIndustries();
                    }
                });
                
                // Close results when clicking outside
                document.addEventListener('click', (e) => {
                    const resultsDiv = document.getElementById('industry-search-results');
                    if (resultsDiv && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                        resultsDiv.classList.add('hidden');
                    }
                });
            }
        }
        
        function filterIndustries() {
            const searchInput = document.getElementById('industry-search');
            const resultsDiv = document.getElementById('industry-search-results');
            
            if (!searchInput || !resultsDiv) return;
            
            const searchTerm = searchInput.value.trim();
            const showAll = searchTerm === '*';
            const searchLower = searchTerm.toLowerCase();
            
            // Filter industries - exclude already assigned ones
            let filtered = allIndustries.filter(ind => 
                !window.assignedIndustryIds.includes(ind.id)
            );
            
            // Apply search filter unless "*" is typed
            if (!showAll && searchTerm) {
                filtered = filtered.filter(ind => 
                    ind.name.toLowerCase().includes(searchLower)
                );
            }
            
            // Show results when:
            // 1. Input is focused (even if empty - shows all)
            // 2. User typed something
            // 3. User typed "*" to show all
            const isFocused = searchInput === document.activeElement;
            const shouldShow = isFocused || searchTerm || showAll;
            
            if (shouldShow) {
                if (filtered.length === 0) {
                    if (showAll && allIndustries.length === 0) {
                        resultsDiv.innerHTML = '<p class="p-2 text-sm text-slate-500">No industries available</p>';
                    } else if (showAll || (isFocused && !searchTerm)) {
                        resultsDiv.innerHTML = '<p class="p-2 text-sm text-slate-500">All industries are already assigned</p>';
                    } else {
                        resultsDiv.innerHTML = '<p class="p-2 text-sm text-slate-500">No matching industries</p>';
                    }
                } else {
                    // Show header if showing all or when focused with no search term
                    const showHeader = showAll || (isFocused && !searchTerm);
                    const header = showHeader ? `<div class="p-2 bg-slate-100 border-b border-slate-200 text-xs font-medium text-slate-600">
                        ${showAll ? 'All Available Industries' : 'Available Industries'} (${filtered.length})
                    </div>` : '';
                    
                    resultsDiv.innerHTML = header + filtered.map(ind => `
                        <label class="p-3 hover:bg-emerald-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors flex items-center gap-3">
                            <input type="checkbox" class="industry-checkbox rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" 
                                   value="${ind.id}" 
                                   data-name="${ind.name.replace(/"/g, '&quot;')}"
                                   onchange="updateSelectedIndustriesCount()">
                            <div class="font-medium text-slate-900">${ind.name}</div>
                        </label>
                    `).join('');
                }
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('hidden');
            }
        }
        
        async function addUserIndustry(userId, industryId, industryName) {
            try {
                const response = await fetch(`/api/user-industries/${userId}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ industry_id: industryId, is_default: false })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Industry Added', `Industry ${industryName} assigned`, 3000);
                    // Clear search and refresh results
                    const searchInput = document.getElementById('industry-search');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    // Reload modal to refresh assigned industries list
                    manageUserIndustries(userId);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to assign industry', 5000);
                }
            } catch (error) {
                console.error('Error adding industry:', error);
                showToast('error', 'Not OK - Failed', 'Failed to assign industry', 5000);
            }
        }
        
        function updateSelectedIndustriesCount() {
            const checkboxes = document.querySelectorAll('.industry-checkbox:checked');
            const count = checkboxes.length;
            const countSpan = document.getElementById('selected-count');
            const addBtn = document.getElementById('add-selected-btn');
            
            if (countSpan) countSpan.textContent = count;
            if (addBtn) {
                addBtn.disabled = count === 0;
            }
        }
        
        function selectAllAvailableIndustries() {
            const checkboxes = document.querySelectorAll('.industry-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedIndustriesCount();
        }
        
        function deselectAllIndustries() {
            const checkboxes = document.querySelectorAll('.industry-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedIndustriesCount();
        }
        
        async function addSelectedIndustries() {
            const checkboxes = document.querySelectorAll('.industry-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.dataset.name
            }));
            
            if (selected.length === 0) {
                showToast('warning', 'No Selection', 'Please select at least one industry', 3000);
                return;
            }
            
            const userId = window.currentUserId;
            let successCount = 0;
            let errorCount = 0;
            
            // Show progress toast
            showToast('info', 'Adding Industries', `Adding ${selected.length} industry(ies)...`, 2000);
            
            // Add industries sequentially to avoid race conditions
            for (const industry of selected) {
                try {
                    const response = await fetch(`/api/user-industries/${userId}`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ industry_id: industry.id, is_default: false })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error(`Failed to add ${industry.name}`);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error adding ${industry.name}:`, error);
                }
            }
            
            // Show result
            if (successCount > 0) {
                showToast('success', 'OK - Added', `Successfully added ${successCount} industry(ies)${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 3000);
                manageUserIndustries(userId);
            } else {
                showToast('error', 'Not OK - Failed', 'Failed to add selected industries', 5000);
            }
        }
        
        async function removeUserIndustry(userId, industryId) {
            if (!confirm('Remove this industry assignment?')) return;
            
            try {
                const response = await fetch(`/api/user-industries/${userId}/${industryId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Removed', 'Industry assignment removed', 3000);
                    manageUserIndustries(userId);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to remove industry', 5000);
                }
            } catch (error) {
                console.error('Error removing industry:', error);
                showToast('error', 'Not OK - Failed', 'Failed to remove industry', 5000);
            }
        }
        
        async function setDefaultIndustry(userId, industryId) {
            try {
                const response = await fetch(`/api/user-industries/${userId}/set-default`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ industry_id: industryId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Default Set', 'Default industry updated', 3000);
                    manageUserIndustries(userId);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to set default', 5000);
                }
            } catch (error) {
                console.error('Error setting default industry:', error);
                showToast('error', 'Not OK - Failed', 'Failed to set default industry', 5000);
            }
        }
        
        async function toggleIndustryAdmin(userId, currentStatus, currentIndustryId) {
            // If making admin, show industry selection
            if (!currentStatus && allIndustries.length > 0) {
                const industryId = currentIndustryId || await new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-slate-900">Make Industry Admin</h3>
                                <button onclick="this.closest('.fixed').remove(); resolve(null)" class="text-slate-500 hover:text-slate-700">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Select Industry</label>
                                <select id="admin-industry-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    <option value="">-- Select Industry --</option>
                                    ${allIndustries.map(ind => 
                                        `<option value="${ind.id}">${ind.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex gap-2 justify-end">
                                <button onclick="this.closest('.fixed').remove(); resolve(null)" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm">
                                    Cancel
                                </button>
                                <button onclick="const sel = document.getElementById('admin-industry-select'); this.closest('.fixed').remove(); resolve(sel.value)" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                                    <i class="fa-solid fa-check mr-1"></i>Make Admin
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                });
                
                if (industryId === null) return; // User cancelled
                
                try {
                    const response = await fetch(`/api/auth/users/${userId}/toggle_industry_admin`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            is_industry_admin: !currentStatus,
                            industry_id: industryId || undefined
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'OK - Updated', `Industry admin status ${!currentStatus ? 'granted' : 'revoked'}`, 3000);
                        loadUsers();
                    } else {
                        showToast('error', 'Not OK - Failed', data.error || 'Failed to update', 5000);
                    }
                } catch (error) {
                    console.error('Error toggling industry admin:', error);
                    showToast('error', 'Not OK - Failed', 'Failed to update', 5000);
                }
            } else {
                // Removing admin - no industry selection needed
                try {
                    const response = await fetch(`/api/auth/users/${userId}/toggle_industry_admin`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_industry_admin: !currentStatus })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'OK - Updated', `Industry admin status ${!currentStatus ? 'granted' : 'revoked'}`, 3000);
                        loadUsers();
                    } else {
                        showToast('error', 'Not OK - Failed', data.error || 'Failed to update', 5000);
                    }
                } catch (error) {
                    console.error('Error toggling industry admin:', error);
                    showToast('error', 'Not OK - Failed', 'Failed to update', 5000);
                }
            }
        }

        function showAddUserModal() {
            const email = prompt('Enter email address:');
            if (!email) return;
            
            const password = prompt('Enter password (min 6 characters):');
            if (!password || password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            const isSuperUser = confirm('Make this user a Super User?');
            const isIndustryAdmin = confirm('Make this user an Industry Admin?');

            addUser(email, password, isSuperUser, isIndustryAdmin);
        }

        async function addUser(email, password, isSuperUser, isIndustryAdmin) {
            try {
                showToast('info', 'Adding User...', 'Creating new user account...', 2000);
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, is_super_user: isSuperUser, is_industry_admin: isIndustryAdmin })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - User Added', `User ${email} created successfully`, 3000);
                    loadUsers();
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to add user', 5000);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showToast('error', 'Not OK - Failed', 'Failed to add user', 5000);
            }
        }

        async function toggleSuperUser(userId, currentStatus) {
            try {
                const response = await fetch(`/api/auth/users/${userId}/toggle_super_user`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_super_user: !currentStatus })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Updated', `Super user status ${!currentStatus ? 'granted' : 'revoked'}`, 3000);
                    loadUsers();
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to update', 5000);
                }
            } catch (error) {
                console.error('Error toggling super user:', error);
                showToast('error', 'Not OK - Failed', 'Failed to update', 5000);
            }
        }

        async function toggleIndustryAdmin(userId, currentStatus) {
            try {
                const response = await fetch(`/api/auth/users/${userId}/toggle_industry_admin`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_industry_admin: !currentStatus })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Updated', `Industry admin status ${!currentStatus ? 'granted' : 'revoked'}`, 3000);
                    loadUsers();
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to update', 5000);
                }
            } catch (error) {
                console.error('Error toggling industry admin:', error);
                showToast('error', 'Not OK - Failed', 'Failed to update', 5000);
            }
        }

        async function managePermissions(userId) {
            await loadUseCases();
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            let currentPermissions = [];
            try {
                const response = await fetch(`/api/permissions/user/${userId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.permissions) {
                    currentPermissions = data.permissions;
                }
            } catch (error) {
                console.error('Error loading permissions:', error);
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh]" style="overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;">
                    <style>
                        .manage-permissions-modal::-webkit-scrollbar { display: none; }
                    </style>
                    <div class="manage-permissions-modal">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-slate-900">Manage Permissions: ${(user.email || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${allUseCases.map(uc => {
                            const hasPermission = currentPermissions.some(p => p.use_case_id === uc.id);
                            return `
                                <div class="flex justify-between items-center p-3 border border-slate-200 rounded-lg">
                                    <div>
                                        <div class="font-medium text-slate-900">${(uc.name || uc.code || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                        <div class="text-sm text-slate-600">${(uc.description || uc.code || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                    </div>
                                    <button onclick="togglePermission('${userId}', '${uc.id}', ${hasPermission})" 
                                            class="px-4 py-2 ${hasPermission ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded text-sm">
                                        ${hasPermission ? '<i class="fa-solid fa-times mr-1"></i>Revoke' : '<i class="fa-solid fa-check mr-1"></i>Grant'}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function togglePermission(userId, useCaseId, hasPermission) {
            try {
                const endpoint = hasPermission ? 'revoke' : 'grant';
                const response = await fetch(`/api/permissions/user/${userId}/${endpoint}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ use_case_id: useCaseId })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'OK - Updated', `Permission ${hasPermission ? 'revoked' : 'granted'}`, 3000);
                    const modal = document.querySelector('.fixed');
                    if (modal) modal.remove();
                    managePermissions(userId);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to update permission', 5000);
                }
            } catch (error) {
                console.error('Error toggling permission:', error);
                showToast('error', 'Not OK - Failed', 'Failed to update permission', 5000);
            }
        }

        // --- PITCH PRESENTATION FUNCTIONS ---
        let currentPitchId = null;
        let currentPitchData = null;
        let currentPitchTargetId = null;
        
        async function loadPitchTargets() {
            const select = document.getElementById('pitch-target-select');
            if (!select) return;
            
            try {
                const response = await fetch('/api/targets', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.targets) {
                    select.innerHTML = '<option value="">-- Select a target --</option>';
                    data.targets.forEach(target => {
                        const option = document.createElement('option');
                        option.value = target.id;
                        option.textContent = `${target.company_name} - ${target.contact_name || 'N/A'}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading targets for pitch:', error);
            }
        }
        
        // Handle target change - clear pitch preview and load history
        async function onPitchTargetChange() {
            const targetId = document.getElementById('pitch-target-select').value;
            
            // Clear current pitch preview if target changed
            if (currentPitchTargetId && currentPitchTargetId !== targetId) {
                document.getElementById('pitch-preview').classList.add('hidden');
                currentPitchId = null;
                currentPitchData = null;
                localStorage.removeItem('currentPitch');
            }
            
            currentPitchTargetId = targetId;
            
            // Show/hide pitch history section
            const historySection = document.getElementById('pitch-history-section');
            if (targetId) {
                historySection.classList.remove('hidden');
                await loadPitchHistory(targetId);
            } else {
                historySection.classList.add('hidden');
            }
        }
        
        // Load pitch history for a target
        async function loadPitchHistory(targetId) {
            if (!targetId) return;
            
            const historyList = document.getElementById('pitch-history-list');
            if (!historyList) return;
            
            historyList.innerHTML = '<div class="text-center text-slate-500 py-4">Loading pitch history...</div>';
            
            try {
                const response = await fetch(`/api/pitch/history/${targetId}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.pitches) {
                    displayPitchHistory(data.pitches);
                } else {
                    historyList.innerHTML = '<div class="text-center text-slate-500 py-4">No pitches generated yet for this target.</div>';
                }
            } catch (error) {
                console.error('Error loading pitch history:', error);
                historyList.innerHTML = '<div class="text-center text-red-500 py-4">Failed to load pitch history.</div>';
            }
        }
        
        // Display pitch history list
        function displayPitchHistory(pitches) {
            const historyList = document.getElementById('pitch-history-list');
            if (!historyList) return;
            
            if (pitches.length === 0) {
                historyList.innerHTML = '<div class="text-center text-slate-500 py-4">No pitches generated yet for this target.</div>';
                return;
            }
            
            historyList.innerHTML = pitches.map((pitch, idx) => {
                const createdDate = pitch.created_at ? new Date(pitch.created_at).toLocaleString() : 'Unknown date';
                const sentBadge = pitch.sent_at ? 
                    `<span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded">Sent via ${pitch.sent_channel || 'email'}</span>` : 
                    '<span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded">Not sent</span>';
                
                return `
                    <div class="border border-slate-200 rounded-lg p-3 bg-white hover:bg-slate-50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-semibold text-slate-900">${pitch.title || `Pitch #${idx + 1}`}</div>
                                <div class="text-xs text-slate-500 mt-1">${createdDate}</div>
                            </div>
                            <div class="flex gap-2 items-center">
                                ${sentBadge}
                                <button onclick="selectPitchFromHistory('${pitch.id}')" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-bold">
                                    <i class="fa-solid fa-eye mr-1"></i>View
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-slate-600 line-clamp-2">${(pitch.problem_statement || pitch.title || '').substring(0, 100)}...</div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle pitch history visibility
        function togglePitchHistory() {
            const content = document.getElementById('pitch-history-content');
            const icon = document.getElementById('pitch-history-toggle-icon');
            const text = document.getElementById('pitch-history-toggle-text');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                text.textContent = 'Hide';
            } else {
                content.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                text.textContent = 'Show';
            }
        }
        
        // Select a pitch from history to view/use
        async function selectPitchFromHistory(pitchId) {
            try {
                const response = await fetch(`/api/pitch/preview/${pitchId}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    currentPitchId = pitchId;
                    currentPitchData = {
                        pitch_id: pitchId,
                        target_id: currentPitchTargetId,
                        generated_html: data.generated_html,
                        generated_content: data.generated_content,
                        timestamp: Date.now()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('currentPitch', JSON.stringify(currentPitchData));
                    
                    // Display pitch
                    displayPitch(data.generated_html);
                    
                    // Check sent status
                    await checkPitchSentStatus(pitchId);
                    
                    // Expand preview
                    document.getElementById('pitch-preview').classList.remove('hidden');
                    document.getElementById('pitch-preview-content').classList.remove('hidden');
                    
                    showToast('success', 'OK - Loaded', 'Pitch loaded from history', 2000);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to load pitch', 5000);
                }
            } catch (error) {
                console.error('Error loading pitch from history:', error);
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            }
        }

        async function generatePitch() {
            const targetId = document.getElementById('pitch-target-select').value;
            if (!targetId) {
                showToast('warning', 'No Target Selected', 'Please select a target first', 3000);
                return;
            }
            
            const btn = document.getElementById('btn-generate-pitch');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generating...';
            
            try {
                const response = await fetch(`/api/pitch/generate/${targetId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    // Store pitch data for persistence
                    currentPitchId = data.pitch_id;
                    currentPitchData = {
                        pitch_id: data.pitch_id,
                        target_id: targetId,
                        generated_html: data.generated_html,
                        generated_content: data.generated_content,
                        timestamp: Date.now()
                    };
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('currentPitch', JSON.stringify(currentPitchData));
                    
                    // Display pitch
                    displayPitch(data.generated_html);
                    
                    // Check if pitch has been sent
                    await checkPitchSentStatus(data.pitch_id);
                    
                    // Refresh pitch history
                    if (currentPitchTargetId) {
                        await loadPitchHistory(currentPitchTargetId);
                    }
                    
                    showToast('success', 'OK - Generated', 'Pitch presentation generated successfully', 3000);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to generate pitch', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate AI Pitch Presentation';
            }
        }
        
        // Display pitch content with proper styling
        function displayPitch(htmlContent) {
            // Fix white text on white background issues
            let fixedHtml = htmlContent;
            
            // Replace white text colors with dark colors
            fixedHtml = fixedHtml.replace(/color:\s*white/gi, 'color: #0f172a');
            fixedHtml = fixedHtml.replace(/color:\s*#fff/gi, 'color: #0f172a');
            fixedHtml = fixedHtml.replace(/color:\s*#ffffff/gi, 'color: #0f172a');
            fixedHtml = fixedHtml.replace(/text-white/gi, 'text-slate-900');
            
            // Add click handlers for CTA buttons
            fixedHtml = fixedHtml.replace(
                /Schedule a Demo/g,
                '<button onclick="schedulePitchDemo()" class="cursor-pointer hover:bg-white/30 transition">Schedule a Demo</button>'
            );
            fixedHtml = fixedHtml.replace(
                /Book a Call/g,
                '<button onclick="bookPitchCall()" class="cursor-pointer hover:bg-white/30 transition">Book a Call</button>'
            );
            fixedHtml = fixedHtml.replace(
                /Download PDF/g,
                '<button onclick="downloadPitchPDF()" class="cursor-pointer hover:bg-white/30 transition">Download PDF</button>'
            );
            
            document.getElementById('pitch-content').innerHTML = fixedHtml;
            document.getElementById('pitch-preview').classList.remove('hidden');
            document.getElementById('pitch-preview-content').classList.remove('hidden');
        }
        
        // Toggle pitch preview collapse/expand
        function togglePitchPreview() {
            const content = document.getElementById('pitch-preview-content');
            const icon = document.getElementById('pitch-preview-toggle-icon');
            const text = document.getElementById('pitch-preview-toggle-text');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                text.textContent = 'Collapse';
            } else {
                content.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                text.textContent = 'Expand';
            }
        }
        
        // Restore pitch when coming back to tab (only if target matches)
        function restorePitchIfExists() {
            try {
                const savedPitch = localStorage.getItem('currentPitch');
                const currentTarget = document.getElementById('pitch-target-select').value;
                
                if (savedPitch) {
                    const pitchData = JSON.parse(savedPitch);
                    
                    // Only restore if target matches
                    if (pitchData.target_id && pitchData.target_id === currentTarget) {
                        currentPitchId = pitchData.pitch_id;
                        currentPitchData = pitchData;
                        currentPitchTargetId = pitchData.target_id;
                        
                        // Restore display (but keep collapsed initially)
                        displayPitch(pitchData.generated_html);
                        
                        // Collapse by default when restored
                        const content = document.getElementById('pitch-preview-content');
                        const icon = document.getElementById('pitch-preview-toggle-icon');
                        const text = document.getElementById('pitch-preview-toggle-text');
                        if (content && icon && text) {
                            content.classList.add('hidden');
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                            text.textContent = 'Expand';
                        }
                        
                        // Check sent status
                        checkPitchSentStatus(pitchData.pitch_id);
                        
                        // Load pitch history for this target
                        if (currentTarget) {
                            loadPitchHistory(currentTarget);
                        }
                    } else {
                        // Target doesn't match, clear saved pitch
                        localStorage.removeItem('currentPitch');
                        currentPitchId = null;
                        currentPitchData = null;
                    }
                }
            } catch (error) {
                console.error('Error restoring pitch:', error);
            }
        }
        
        // Check if pitch has been sent
        async function checkPitchSentStatus(pitchId) {
            if (!pitchId) return;
            
            try {
                const response = await fetch(`/api/pitch/preview/${pitchId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.sent_at) {
                    // Pitch has been sent
                    document.getElementById('pitch-sent-warning').classList.remove('hidden');
                } else {
                    document.getElementById('pitch-sent-warning').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking pitch sent status:', error);
            }
        }
        
        // CTA button handlers
        function schedulePitchDemo() {
            showToast('info', 'Schedule Demo', 'Demo scheduling feature coming soon!', 3000);
            // TODO: Integrate with Cal.com or other scheduling system
        }
        
        function bookPitchCall() {
            showToast('info', 'Book Call', 'Call booking feature coming soon!', 3000);
            // TODO: Integrate with Cal.com or other scheduling system
        }
        
        function downloadPitchPDF() {
            if (!currentPitchId) {
                showToast('warning', 'No Pitch', 'Please generate a pitch first', 3000);
                return;
            }
            
            // Create a new window with the pitch content for printing/PDF
            const pitchWindow = window.open('', '_blank');
            const pitchContent = document.getElementById('pitch-content').innerHTML;
            
            pitchWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Pitch Presentation - Project VANI</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #0f172a; }
                        p { color: #334155; }
                        @media print {
                            body { padding: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${pitchContent}
                </body>
                </html>
            `);
            pitchWindow.document.close();
            
            // Wait for content to load, then trigger print
            setTimeout(() => {
                pitchWindow.print();
            }, 500);
        }

        // Note: currentPitchId and currentPitchData are already declared at line 2789
        // Only declare currentPitchChannel here
        let currentPitchChannel = null;

        // Show preview modal before sending pitch
        async function showPitchSendPreview(channel) {
            if (!currentPitchId) {
                showToast('warning', 'No Pitch Generated', 'Please generate a pitch first', 3000);
                return;
            }
            
            currentPitchChannel = channel;
            
            // Fetch pitch data to show preview
            try {
                const response = await fetch(`/api/pitch/preview/${currentPitchId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPitchData = data.generated_content;
                    
                    // Format content based on channel
                    let previewContent = '';
                    let previewSubject = '';
                    
                    if (channel === 'email') {
                        previewSubject = data.generated_content.title || 'Strategic Pitch from Project VANI';
                        previewContent = `
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-2">Subject:</h4>
                                    <p class="text-slate-900 font-medium">${previewSubject}</p>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-2">Message:</h4>
                                    <div class="bg-white p-4 rounded border border-slate-200 text-slate-700 whitespace-pre-wrap">${formatPitchForChannel(data.generated_content, channel)}</div>
                                </div>
                            </div>
                        `;
                    } else if (channel === 'whatsapp') {
                        previewContent = `
                            <div>
                                <h4 class="text-sm font-bold text-slate-700 mb-2">WhatsApp Message:</h4>
                                <div class="bg-green-50 p-4 rounded border border-green-200 text-slate-700 whitespace-pre-wrap font-mono text-sm">${formatPitchForChannel(data.generated_content, channel)}</div>
                            </div>
                        `;
                    } else if (channel === 'linkedin') {
                        previewContent = `
                            <div>
                                <h4 class="text-sm font-bold text-slate-700 mb-2">LinkedIn Message:</h4>
                                <div class="bg-blue-50 p-4 rounded border border-blue-200 text-slate-700 whitespace-pre-wrap">${formatPitchForChannel(data.generated_content, channel)}</div>
                            </div>
                        `;
                    }
                    
                    // Show modal
                    document.getElementById('pitch-send-preview-content').innerHTML = previewContent;
                    if (channel === 'email') {
                        document.getElementById('pitch-send-preview-subject').value = previewSubject;
                        document.getElementById('pitch-send-preview-subject-group').classList.remove('hidden');
                    } else {
                        document.getElementById('pitch-send-preview-subject-group').classList.add('hidden');
                    }
                    document.getElementById('pitch-send-preview-modal').classList.remove('hidden');
                } else {
                    showToast('error', 'Failed to Load Preview', data.error || 'Could not load pitch preview', 5000);
                }
            } catch (error) {
                showToast('error', 'Network Error', error.message || 'Failed to load preview', 5000);
            }
        }
        
        // Format pitch content for different channels
        function formatPitchForChannel(pitchData, channel) {
            const title = pitchData.title || 'Strategic Pitch';
            const problem = pitchData.problem || '';
            const solution = pitchData.solution || '';
            const hitList = pitchData.hit_list || '';
            const trojanHorse = pitchData.trojan_horse || '';
            
            if (channel === 'email') {
                return `Hi there,

I have a strategic pitch for your company from Project VANI.

${title}

Problem:
${problem}

Solution:
${solution}

${hitList ? `Hit List:\n${hitList}\n\n` : ''}${trojanHorse ? `Trojan Horse Strategy:\n${trojanHorse}\n\n` : ''}Would you be open to a quick conversation about how VANI can help your company?

Best regards,
Project VANI Team`;
            } else if (channel === 'whatsapp') {
                return `Hi there! üëã

I have a strategic pitch for your company from Project VANI.

*${title}*

*Problem:*
${problem}

*Solution:*
${solution}

${hitList ? `*Hit List:*\n${hitList}\n\n` : ''}Would you be open to a quick conversation about how VANI can help your company?

Best regards,
Project VANI Team`;
            } else if (channel === 'linkedin') {
                return `Hi there,

I have a strategic pitch for your company from Project VANI.

${title}

Problem:
${problem}

Solution:
${solution}

${hitList ? `Hit List:\n${hitList}\n\n` : ''}Would you be open to a quick conversation about how VANI can help your company?

Best regards,
Project VANI Team`;
            }
            
            return '';
        }
        
        // Close preview modal
        function closePitchSendPreview() {
            document.getElementById('pitch-send-preview-modal').classList.add('hidden');
            currentPitchChannel = null;
        }
        
        // Actually send the pitch
        async function confirmSendPitch() {
            if (!currentPitchId || !currentPitchChannel) {
                showToast('warning', 'No Channel Selected', 'Please select a channel first', 3000);
                return;
            }
            
            const btn = document.getElementById('btn-confirm-send-pitch');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Sending...';
            
            try {
                const response = await fetch(`/api/pitch/send/${currentPitchId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ channel: currentPitchChannel })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const targetName = document.getElementById('pitch-target-select').options[document.getElementById('pitch-target-select').selectedIndex].text;
                    showToast('success', 'OK - Sent', `${data.message || `Pitch sent via ${currentPitchChannel} to ${targetName}`}`, 5000);
                    
                    // Update sent status warning
                    if (currentPitchId) {
                        checkPitchSentStatus(currentPitchId);
                    }
                    
                    closePitchSendPreview();
                } else {
                    showToast('error', 'Not OK - Failed', data.error || `Failed to send pitch via ${currentPitchChannel}`, 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- COMPANIES MANAGEMENT FUNCTIONS ---
        let companies = [];
        let companiesFiltered = [];
        let companiesPage = 1;
        const companiesPerPage = 20;

        async function loadCompanies() {
            // Prevent multiple simultaneous loads
            if (isLoadingCompanies) {
                console.log('loadCompanies already in progress, skipping duplicate call');
                return;
            }
            
            const container = document.getElementById('companies-list');
            if (!container) return;
            
            isLoadingCompanies = true;
            
            container.innerHTML = '<div class="text-center text-slate-500 py-8">Loading companies...</div>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch('/api/companies', { 
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // If response is not JSON, use status text
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                if (data.success && data.companies) {
                    companies = data.companies;
                    companiesFiltered = companies;
                    companiesPage = 1;
                    renderCompanies();
                    loadCompanyIndustries();
                    
                    // Show industry notice for industry admins
                    showIndustryNoticeForCompanies();
                } else if (data.error) {
                    // API returned an error
                    throw new Error(data.error);
                } else {
                    // No error but no companies either
                    container.innerHTML = '<div class="text-center text-slate-500 py-8">No companies found</div>';
                }
            } catch (error) {
                console.error('Error loading companies:', error);
                if (error.name === 'AbortError') {
                    container.innerHTML = '<div class="text-center text-red-500 py-8">Request timed out. Please try again.</div>';
                    showToast('error', 'Not OK - Timeout', 'Loading companies took too long. Please refresh.', 5000);
                } else {
                    container.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load companies. <button onclick="loadCompanies()" class="text-indigo-600 hover:underline">Retry</button></div>';
                    showToast('error', 'Not OK - Failed', error.message || 'Failed to load companies', 5000);
                }
            } finally {
                isLoadingCompanies = false;
            }
        }

        function loadCompanyIndustries() {
            const filter = document.getElementById('company-industry-filter');
            if (!filter) return;
            
            const industries = [...new Set(companies.map(c => c.industry).filter(Boolean))].sort();
            filter.innerHTML = '<option value="">All Industries</option>';
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                filter.appendChild(option);
            });
        }

        function filterCompanies() {
            const search = document.getElementById('company-search').value.toLowerCase();
            const industry = document.getElementById('company-industry-filter').value;
            
            companiesFiltered = companies.filter(c => {
                const matchSearch = !search || 
                    (c.name && c.name.toLowerCase().includes(search)) ||
                    (c.domain && c.domain.toLowerCase().includes(search)) ||
                    (c.industry && c.industry.toLowerCase().includes(search));
                const matchIndustry = !industry || c.industry === industry;
                return matchSearch && matchIndustry;
            });
            
            companiesPage = 1;
            renderCompanies();
        }

        function renderCompanies() {
            const container = document.getElementById('companies-list');
            if (!container) return;
            
            if (companiesFiltered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8">No companies found</div>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(companiesFiltered.length / companiesPerPage);
            const startIdx = (companiesPage - 1) * companiesPerPage;
            const endIdx = Math.min(startIdx + companiesPerPage, companiesFiltered.length);
            const paginatedCompanies = companiesFiltered.slice(startIdx, endIdx);
            
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-slate-600">
                            Showing <strong>${startIdx + 1}-${endIdx}</strong> of <strong>${companiesFiltered.length}</strong> companies
                            ${companiesFiltered.length !== companies.length ? `(filtered from ${companies.length} total)` : ''}
                        </div>
                        ${totalPages > 1 ? `
                            <div class="flex items-center gap-2">
                                <button onclick="goToCompaniesPage(${companiesPage - 1})" ${companiesPage === 1 ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <span class="text-sm text-slate-600">Page ${companiesPage} / ${totalPages}</span>
                                <button onclick="goToCompaniesPage(${companiesPage + 1})" ${companiesPage === totalPages ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold text-slate-900">Name</th>
                                    <th class="px-4 py-3 text-left font-semibold text-slate-900">Domain</th>
                                    <th class="px-4 py-3 text-left font-semibold text-slate-900">Industry</th>
                                    <th class="px-4 py-3 text-center font-semibold text-slate-900">Contacts</th>
                                    <th class="px-4 py-3 text-center font-semibold text-slate-900">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paginatedCompanies.map((company, idx) => `
                                    <tr id="company-row-${company.id}" class="border-b border-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'} hover:bg-indigo-50">
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <input type="checkbox" class="company-checkbox" data-company-id="${company.id}" onchange="updateCompanySelection()">
                                                <span class="editable-company cursor-pointer hover:text-indigo-600 hover:underline font-medium text-slate-900" data-field="name" data-company-id="${company.id}" onclick="startInlineEditCompany('${company.id}', 'name', '${(company.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">${company.name || '‚Äî'}</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-slate-600">
                                            <span class="editable-company cursor-pointer hover:text-indigo-600 hover:underline" data-field="domain" data-company-id="${company.id}" onclick="startInlineEditCompany('${company.id}', 'domain', '${(company.domain || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">${company.domain || '‚Äî'}</span>
                                        </td>
                                        <td class="px-4 py-3 text-slate-600">
                                            ${company.industry ? `
                                                <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded inline-block editable-company cursor-pointer hover:text-indigo-600 hover:underline" data-field="industry" data-company-id="${company.id}" onclick="startInlineEditCompany('${company.id}', 'industry', '${(company.industry || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">${company.industry}</span>
                                            ` : '<span class="text-slate-400">‚Äî</span>'}
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <span class="px-2 py-1 rounded-full text-xs font-bold ${company.contact_count ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${company.contact_count || 0}
                                                </span>
                                                ${company.contact_count > 0 ? `
                                                    <button onclick="toggleCompanyContacts('${company.id}')" class="text-indigo-600 hover:text-indigo-700" title="View Contacts">
                                                        <i class="fa-solid fa-chevron-down" id="toggle-icon-${company.id}"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <div class="flex justify-center gap-2">
                                                <button onclick="viewCompanyDetails('${company.id}')" class="text-slate-600 hover:text-slate-700" title="View">
                                                    <i class="fa-solid fa-eye"></i>
                                                </button>
                                                <button onclick="showEditCompanyModal('${company.id}')" class="text-indigo-600 hover:text-indigo-700" title="Edit">
                                                    <i class="fa-solid fa-edit"></i>
                                                </button>
                                                <button onclick="deleteCompany('${company.id}')" class="text-rose-600 hover:text-rose-700" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    ${company.contact_count > 0 ? `
                                        <tr id="contacts-row-${company.id}" class="hidden">
                                            <td colspan="6" class="px-4 py-4 bg-slate-50">
                                                <div id="contacts-content-${company.id}" class="text-center text-slate-500">
                                                    <i class="fa-solid fa-spinner fa-spin"></i> Loading contacts...
                                                </div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function goToCompaniesPage(page) {
            const totalPages = Math.ceil(companiesFiltered.length / companiesPerPage);
            if (page >= 1 && page <= totalPages) {
                companiesPage = page;
                renderCompanies();
            }
        }

        function startInlineEditCompany(companyId, field, currentValue) {
            const span = document.querySelector(`#company-row-${companyId} .editable-company[data-field="${field}"]`);
            if (!span || span.querySelector('input')) return;
            
            const originalValue = currentValue === '‚Äî' ? '' : currentValue;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.className = 'px-2 py-1 border border-indigo-300 rounded text-sm w-full';
            
            let saved = false;
            input.onblur = () => {
                if (!saved) {
                    saveInlineEditCompany(companyId, field, input.value);
                    saved = true;
                }
            };
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saved = true;
                    saveInlineEditCompany(companyId, field, input.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    saved = true;
                    span.innerHTML = originalValue || '‚Äî';
                    span.className = 'editable-company cursor-pointer hover:text-indigo-600 hover:underline text-slate-600';
                }
            };
            
            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();
        }

        async function saveInlineEditCompany(companyId, field, newValue) {
            const span = document.querySelector(`#company-row-${companyId} .editable-company[data-field="${field}"]`);
            if (!span) return;
            
            span.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            try {
                const company = companies.find(c => c.id === companyId);
                if (!company) {
                    span.textContent = newValue || '‚Äî';
                    return;
                }
                
                const updateData = { [field]: newValue || null };
                
                const response = await fetch(`/api/companies/${companyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                if (result.success) {
                    company[field] = newValue || null;
                    span.textContent = newValue || '‚Äî';
                    span.className = 'editable-company cursor-pointer hover:text-indigo-600 hover:underline';
                    if (field === 'name') {
                        span.className += ' font-medium text-slate-900';
                    } else {
                        span.className += ' text-slate-600';
                    }
                    showToast('success', 'OK - Updated', 'Company updated successfully', 2000);
                } else {
                    span.textContent = company[field] || '‚Äî';
                    span.className = 'editable-company cursor-pointer hover:text-indigo-600 hover:underline text-slate-600';
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update company', 3000);
                }
            } catch (error) {
                const company = companies.find(c => c.id === companyId);
                span.textContent = company ? (company[field] || '‚Äî') : '‚Äî';
                span.className = 'editable-company cursor-pointer hover:text-indigo-600 hover:underline text-slate-600';
                showToast('error', 'Not OK - Network Error', error.message, 3000);
            }
        }

        function showAddCompanyModal() {
            showEditCompanyModal(null);
        }

        function showEditCompanyModal(companyId) {
            const company = companyId ? companies.find(c => c.id === companyId) : null;
            
            let modal = document.getElementById('edit-company-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'edit-company-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full mx-4">
                    <h3 class="text-2xl font-bold text-slate-900 mb-6">${company ? 'Edit Company' : 'Add Company'}</h3>
                    <form id="edit-company-form" onsubmit="saveCompanyEdit(event, '${companyId || ''}')">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Name *</label>
                                <input type="text" id="edit-company-name" value="${company ? (company.name || '').replace(/"/g, '&quot;') : ''}" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Domain</label>
                                <input type="text" id="edit-company-domain" value="${company ? (company.domain || '').replace(/"/g, '&quot;') : ''}" placeholder="example.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Industry</label>
                                <input type="text" id="edit-company-industry" value="${company ? (company.industry || '').replace(/"/g, '&quot;') : ''}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Location</label>
                                <input type="text" id="edit-company-location" value="${company ? (company.location || '').replace(/"/g, '&quot;') : ''}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4 border-t border-slate-200">
                            <button type="button" onclick="document.getElementById('edit-company-modal').remove()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-bold">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold">
                                ${company ? 'Save Changes' : 'Create Company'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function saveCompanyEdit(event, companyId) {
            event.preventDefault();
            const data = {
                name: document.getElementById('edit-company-name').value,
                domain: document.getElementById('edit-company-domain').value || null,
                industry: document.getElementById('edit-company-industry').value || null,
                location: document.getElementById('edit-company-location').value || null
            };
            
            if (companyId) {
                updateCompany(companyId, data);
            } else {
                createCompany(data);
            }
            document.getElementById('edit-company-modal').remove();
        }

        async function createCompany(data) {
            try {
                const response = await fetch('/api/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Created', 'Company created successfully', 3000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to create company', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            const name = prompt('Company Name:', company.name);
            if (!name) return;
            
            const domain = prompt('Domain:', company.domain || '');
            const industry = prompt('Industry:', company.industry || '');
            const location = prompt('Location:', company.location || '');
            
            updateCompany(companyId, { name, domain: domain || null, industry: industry || null, location: location || null });
        }

        async function updateCompany(companyId, data) {
            try {
                const response = await fetch(`/api/companies/${companyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Updated', 'Company updated successfully', 3000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update company', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        async function deleteCompany(companyId) {
            // First check if company has contacts
            try {
                const checkResponse = await fetch(`/api/companies/${companyId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const checkResult = await checkResponse.json();
                
                if (checkResult.requiresConfirmation) {
                    const contactCount = checkResult.affectedContacts || 0;
                    const deleteContacts = confirm(
                        `This company has ${contactCount} associated contact(s).\n\n` +
                        `Do you want to delete the company and all its contacts?\n\n` +
                        `Click OK to delete everything, or Cancel to abort.`
                    );
                    
                    if (!deleteContacts) {
                        return; // User cancelled
                    }
                    
                    // Delete with contacts
                    const deleteResponse = await fetch(`/api/companies/${companyId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ confirm: true, deleteContacts: true })
                    });
                    const deleteResult = await deleteResponse.json();
                    
                    if (deleteResult.success) {
                        showToast('success', 'OK - Deleted', `Company and ${deleteResult.deletedContacts || 0} contacts deleted successfully`, 3000);
                        loadCompanies();
                    } else {
                        showToast('error', 'Not OK - Failed', deleteResult.error || 'Failed to delete company', 5000);
                    }
                } else if (checkResult.success) {
                    showToast('success', 'OK - Deleted', 'Company deleted successfully', 3000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', checkResult.error || 'Failed to delete company', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        async function viewCompanyDetails(companyId) {
            try {
                const response = await fetch(`/api/companies/${companyId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success && data.company) {
                    showCompanyDetailsModal(data.company, data.contacts || []);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Failed to load company details', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function showCompanyDetailsModal(company, contacts) {
            let modal = document.getElementById('company-details-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'company-details-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-900">Company Details: ${company.name || 'Unknown'}</h3>
                        <button onclick="document.getElementById('company-details-modal').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <strong class="text-slate-700">Domain:</strong> <span class="text-slate-600">${company.domain || 'Not specified'}</span>
                            </div>
                            <div>
                                <strong class="text-slate-700">Industry:</strong> <span class="text-slate-600">${company.industry || 'Not specified'}</span>
                            </div>
                            ${company.location ? `
                                <div>
                                    <strong class="text-slate-700">Location:</strong> <span class="text-slate-600">${company.location}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold mb-4 text-slate-900">Associated Contacts (${contacts.length})</h4>
                    ${contacts.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse border border-slate-300">
                                <thead>
                                    <tr class="bg-slate-100">
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">Name</th>
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">Email</th>
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">Designation</th>
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">Phone</th>
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">Source</th>
                                        <th class="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-900">LinkedIn</th>
                                        <th class="border border-slate-300 px-3 py-2 text-center font-semibold text-slate-900">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${contacts.map((contact, idx) => `
                                        <tr class="border-b border-slate-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                            <td class="border border-slate-300 px-3 py-2">${contact.name || '‚Äî'}</td>
                                            <td class="border border-slate-300 px-3 py-2">${contact.email || '‚Äî'}</td>
                                            <td class="border border-slate-300 px-3 py-2">${contact.role || '‚Äî'}</td>
                                            <td class="border border-slate-300 px-3 py-2">${contact.phone || '‚Äî'}</td>
                                            <td class="border border-slate-300 px-3 py-2">${contact.lead_source || '‚Äî'}</td>
                                            <td class="border border-slate-300 px-3 py-2">
                                                ${contact.linkedin ? `
                                                    <a href="${contact.linkedin.startsWith('http') ? contact.linkedin : `https://${contact.linkedin}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800">
                                                        LinkedIn
                                                    </a>
                                                ` : '‚Äî'}
                                            </td>
                                            <td class="border border-slate-300 px-3 py-2 text-center">
                                                <button onclick="viewContactFromCompany('${contact.id}')" class="text-indigo-600 hover:text-indigo-700 text-xs">
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center text-slate-500 py-8 italic">No contacts found for this company</div>
                    `}
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="document.getElementById('company-details-modal').remove()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-bold">
                            Close
                        </button>
                    </div>
                </div>
            `;
        }

        function viewContactFromCompany(contactId) {
            document.getElementById('company-details-modal').remove();
            switchTab('contacts');
            // Scroll to contact if possible
            setTimeout(() => {
                const contactRow = document.getElementById(`contact-row-${contactId}`);
                if (contactRow) {
                    contactRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    contactRow.classList.add('bg-indigo-100');
                    setTimeout(() => contactRow.classList.remove('bg-indigo-100'), 2000);
                }
            }, 500);
        }

        async function toggleCompanyContacts(companyId) {
            const row = document.getElementById(`contacts-row-${companyId}`);
            const content = document.getElementById(`contacts-content-${companyId}`);
            const icon = document.getElementById(`toggle-icon-${companyId}`);
            
            if (!row || !content) return;
            
            if (row.classList.contains('hidden')) {
                // Show contacts
                row.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                
                // Load contacts if not already loaded
                if (content.innerHTML.includes('Loading')) {
                    try {
                        const response = await fetch(`/api/companies/${companyId}`, { credentials: 'include' });
                        const data = await response.json();
                        
                        if (data.success && data.contacts) {
                            renderCompanyContactsInline(companyId, data.contacts);
                        } else {
                            content.innerHTML = '<div class="text-red-500">Failed to load contacts</div>';
                        }
                    } catch (error) {
                        content.innerHTML = '<div class="text-red-500">Error loading contacts</div>';
                    }
                }
            } else {
                // Hide contacts
                row.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function renderCompanyContactsInline(companyId, contacts) {
            const content = document.getElementById(`contacts-content-${companyId}`);
            if (!content) return;
            
            if (contacts.length === 0) {
                content.innerHTML = '<div class="text-slate-500 italic">No contacts found</div>';
                return;
            }
            
            content.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="flex items-center text-sm text-slate-700 font-semibold">
                            <input type="checkbox" id="select-all-inline-${companyId}" onchange="toggleSelectAllContactsInline('${companyId}', ${contacts.length})" class="mr-2 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            Select All (${contacts.length})
                        </label>
                        <div class="flex gap-2">
                            <button onclick="deleteSelectedContactsInline('${companyId}')" id="delete-selected-inline-${companyId}" class="px-3 py-1 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa-solid fa-trash mr-1"></i>Delete Selected
                            </button>
                            <button onclick="deleteAllContactsInline('${companyId}')" class="px-3 py-1 bg-rose-700 hover:bg-rose-800 text-white rounded-lg text-xs font-bold">
                                <i class="fa-solid fa-trash mr-1"></i>Delete All
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse border border-slate-300">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="border border-slate-300 px-2 py-1 text-center w-8"></th>
                                    <th class="border border-slate-300 px-2 py-1 text-left">Name</th>
                                    <th class="border border-slate-300 px-2 py-1 text-left">Email</th>
                                    <th class="border border-slate-300 px-2 py-1 text-left">Designation</th>
                                    <th class="border border-slate-300 px-2 py-1 text-left">Phone</th>
                                    <th class="border border-slate-300 px-2 py-1 text-left">LinkedIn</th>
                                    <th class="border border-slate-300 px-2 py-1 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${contacts.map((contact, idx) => `
                                    <tr id="contact-inline-${contact.id}" class="border-b border-slate-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                        <td class="border border-slate-300 px-2 py-1 text-center">
                                            <input type="checkbox" class="contact-checkbox-inline-${companyId} rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${contact.id}" onchange="updateDeleteButtonStateInline('${companyId}')">
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1">
                                            <span class="inline-contact-field" data-field="name" data-contact-id="${contact.id}">${contact.name || '‚Äî'}</span>
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1">
                                            <span class="inline-contact-field" data-field="email" data-contact-id="${contact.id}">${contact.email || '‚Äî'}</span>
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1">
                                            <span class="inline-contact-field" data-field="role" data-contact-id="${contact.id}">${contact.role || '‚Äî'}</span>
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1">
                                            <span class="inline-contact-field" data-field="phone" data-contact-id="${contact.id}">${contact.phone || '‚Äî'}</span>
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1">
                                            ${contact.linkedin ? `
                                                <span class="inline-contact-field" data-field="linkedin" data-contact-id="${contact.id}">
                                                    <a href="${contact.linkedin.startsWith('http') ? contact.linkedin : `https://${contact.linkedin}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${contact.linkedin}">${contact.linkedin.length > 20 ? contact.linkedin.substring(0, 20) + '...' : contact.linkedin}</a>
                                                </span>
                                            ` : `
                                                <span class="inline-contact-field text-slate-400" data-field="linkedin" data-contact-id="${contact.id}">‚Äî</span>
                                            `}
                                        </td>
                                        <td class="border border-slate-300 px-2 py-1 text-center">
                                            <div class="flex justify-center gap-1">
                                                <button onclick="editContactInline('${contact.id}', '${companyId}')" class="text-indigo-600 hover:text-indigo-700" title="Edit">
                                                    <i class="fa-solid fa-edit text-xs"></i>
                                                </button>
                                                <button onclick="deleteSingleContactInline('${contact.id}', '${companyId}')" class="text-rose-600 hover:text-rose-700" title="Delete">
                                                    <i class="fa-solid fa-trash text-xs"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function toggleSelectAllContacts(companyId, totalContacts) {
            const selectAll = document.getElementById(`select-all-contacts-${companyId}`);
            const selectAllHeader = document.getElementById(`select-all-header-${companyId}`);
            const checkboxes = document.querySelectorAll(`.contact-checkbox-${companyId}`);
            const isChecked = selectAll ? selectAll.checked : (selectAllHeader ? selectAllHeader.checked : false);
            
            checkboxes.forEach(cb => cb.checked = isChecked);
            if (selectAll) selectAll.checked = isChecked;
            if (selectAllHeader) selectAllHeader.checked = isChecked;
            updateDeleteButtonState(companyId);
        }

        function toggleSelectAllContactsInline(companyId, totalContacts) {
            const selectAll = document.getElementById(`select-all-inline-${companyId}`);
            const checkboxes = document.querySelectorAll(`.contact-checkbox-inline-${companyId}`);
            const isChecked = selectAll ? selectAll.checked : false;
            
            checkboxes.forEach(cb => cb.checked = isChecked);
            updateDeleteButtonStateInline(companyId);
        }

        function updateDeleteButtonState(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-${companyId}`);
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            const btn = document.getElementById(`delete-selected-btn-${companyId}`);
            if (btn) {
                btn.disabled = checked.length === 0;
            }
        }

        function updateDeleteButtonStateInline(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-inline-${companyId}`);
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            const btn = document.getElementById(`delete-selected-inline-${companyId}`);
            if (btn) {
                btn.disabled = checked.length === 0;
            }
        }

        async function deleteSelectedContacts(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-${companyId}`);
            const selectedIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showToast('error', 'Not OK', 'No contacts selected', 3000);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected contact(s)?`)) {
                return;
            }
            
            await deleteContactsByIds(selectedIds, companyId);
        }

        async function deleteAllContacts(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-${companyId}`);
            const totalContacts = checkboxes.length;
            
            if (totalContacts === 0) {
                showToast('error', 'Not OK', 'No contacts to delete', 3000);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ALL ${totalContacts} contact(s) for this company?`)) {
                return;
            }
            
            const allIds = Array.from(checkboxes).map(cb => cb.value);
            await deleteContactsByIds(allIds, companyId);
        }

        async function deleteSelectedContactsInline(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-inline-${companyId}`);
            const selectedIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showToast('error', 'Not OK', 'No contacts selected', 3000);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected contact(s)?`)) {
                return;
            }
            
            await deleteContactsByIds(selectedIds, companyId, true);
        }

        async function deleteAllContactsInline(companyId) {
            const checkboxes = document.querySelectorAll(`.contact-checkbox-inline-${companyId}`);
            const totalContacts = checkboxes.length;
            
            if (totalContacts === 0) {
                showToast('error', 'Not OK', 'No contacts to delete', 3000);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ALL ${totalContacts} contact(s) for this company?`)) {
                return;
            }
            
            const allIds = Array.from(checkboxes).map(cb => cb.value);
            await deleteContactsByIds(allIds, companyId, true);
        }

        async function deleteSingleContact(contactId, companyId) {
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }
            
            await deleteContactsByIds([contactId], companyId);
        }

        async function deleteSingleContactInline(contactId, companyId) {
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }
            
            await deleteContactsByIds([contactId], companyId, true);
        }

        async function deleteContactsByIds(contactIds, companyId, isInline = false) {
            try {
                let deletedCount = 0;
                let failedCount = 0;
                
                for (const contactId of contactIds) {
                    try {
                        const response = await fetch(`/api/contacts/${contactId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            deletedCount++;
                            // Remove from UI
                            const row = document.getElementById(`contact-row-modal-${contactId}`);
                            if (row) row.remove();
                            
                            const inlineRow = document.getElementById(`contact-inline-${contactId}`);
                            if (inlineRow) inlineRow.remove();
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                        console.error(`Error deleting contact ${contactId}:`, error);
                    }
                }
                
                if (deletedCount > 0) {
                    // Check if company has any contacts left
                    const companyResponse = await fetch(`/api/companies/${companyId}`, { credentials: 'include' });
                    const companyData = await companyResponse.json();
                    
                    if (companyData.success && companyData.contacts && companyData.contacts.length === 0) {
                        // No contacts left - auto-delete company
                        if (confirm('This company now has no contacts. Would you like to delete the company as well?')) {
                            const deleteCompanyResponse = await fetch(`/api/companies/${companyId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });
                            
                            if (deleteCompanyResponse.ok) {
                                showToast('success', 'OK - Deleted', `${deletedCount} contact(s) deleted and company removed (no contacts left)`, 5000);
                                loadCompanies(); // Refresh company list
                                return;
                            }
                        }
                    }
                    
                    showToast('success', 'OK - Deleted', `${deletedCount} contact(s) deleted successfully`, 3000);
                    // Reload company data
                    if (isInline) {
                        await toggleCompanyContacts(companyId); // Close
                        await toggleCompanyContacts(companyId); // Reopen to reload
                    } else {
                        await viewCompanyDetails(companyId);
                    }
                    loadCompanies(); // Refresh company list to update counts
                }
                
                if (failedCount > 0) {
                    showToast('error', 'Not OK - Partial Failure', `${failedCount} contact(s) failed to delete`, 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function viewCompanyContacts(companyId) {
            switchTab('contacts');
            document.getElementById('contact-company-filter').value = companyId;
            filterContacts();
        }

        // --- CONTACTS MANAGEMENT FUNCTIONS ---
        let contacts = [];
        let contactsFiltered = [];
        let contactsTotal = 0; // Total count from server
        let contactsPage = 1;
        const contactsPerPage = 50;

        // Guard to prevent multiple simultaneous loads
        let isLoadingContacts = false;
        let isLoadingCompanies = false;
        
        async function loadContacts() {
            // Prevent multiple simultaneous loads
            if (isLoadingContacts) {
                console.log('loadContacts already in progress, skipping duplicate call');
                return;
            }
            
            const container = document.getElementById('contacts-list');
            if (!container) return;
            
            isLoadingContacts = true;
            
            // Show loading state
            container.innerHTML = '<div class="text-center text-slate-500 py-8">Loading contacts...</div>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch('/api/contacts', { 
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.contacts) {
                    contacts = data.contacts;
                    contactsTotal = data.total || contacts.length; // Store total count from server
                    contactsFiltered = contacts;
                    // Reset to first page when loading
                    contactsPage = 1;
                    renderContacts();
                    loadContactFilters();
                    
                    // Show industry notice for industry admins
                    showIndustryNoticeForContacts();
                } else {
                    container.innerHTML = '<div class="text-center text-slate-500 py-8">No contacts found</div>';
                    if (data.error) {
                        showToast('warning', 'Warning', data.error, 3000);
                    }
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                if (error.name === 'AbortError') {
                    container.innerHTML = '<div class="text-center text-red-500 py-8">Request timed out. Please try again.</div>';
                    showToast('error', 'Not OK - Timeout', 'Loading contacts took too long. Please refresh.', 5000);
                } else {
                    container.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load contacts. <button onclick="loadContacts()" class="text-indigo-600 hover:underline">Retry</button></div>';
                    showToast('error', 'Not OK - Failed', error.message || 'Failed to load contacts', 5000);
                }
            } finally {
                isLoadingContacts = false;
            }
        }

        async function loadContactFilters() {
            // Load companies for filter
            const companyFilter = document.getElementById('contact-company-filter');
            if (companyFilter) {
                try {
                    // Fetch all companies with higher limit
                    const response = await fetch('/api/companies?limit=1000', { credentials: 'include' });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Non-JSON response from companies API:', text.substring(0, 200));
                        throw new Error('Invalid response format from server');
                    }
                    
                    const data = await response.json();
                    
                    companyFilter.innerHTML = '<option value="">All Companies</option>';
                    
                    if (data.success && data.companies && data.companies.length > 0) {
                        // Sort companies by name
                        const sortedCompanies = [...data.companies].sort((a, b) => 
                            (a.name || '').localeCompare(b.name || '')
                        );
                        
                        sortedCompanies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.id;
                            option.textContent = company.name || 'Unnamed Company';
                            companyFilter.appendChild(option);
                        });
                        console.log(`‚úÖ Loaded ${sortedCompanies.length} companies into filter dropdown`);
                    } else {
                        console.warn('‚ö†Ô∏è No companies returned from API, using fallback from contacts');
                        // Fallback: use company names from contacts if companies API fails
                        const companyNames = [...new Set(contacts.map(c => c.company || c.company_name).filter(Boolean))].sort();
                        companyNames.forEach(companyName => {
                            const option = document.createElement('option');
                            option.value = companyName;
                            option.textContent = companyName;
                            companyFilter.appendChild(option);
                        });
                        console.log(`‚úÖ Loaded ${companyNames.length} companies from contacts fallback`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading companies for filter:', error);
                    // Fallback: use company names from contacts
                    const companyNames = [...new Set(contacts.map(c => c.company || c.company_name).filter(Boolean))].sort();
                    companyFilter.innerHTML = '<option value="">All Companies</option>';
                    companyNames.forEach(companyName => {
                        const option = document.createElement('option');
                        option.value = companyName;
                        option.textContent = companyName;
                        companyFilter.appendChild(option);
                    });
                    console.log(`‚úÖ Loaded ${companyNames.length} companies from contacts fallback (error case)`);
                }
            }
            
            // Load industries for filter
            const industryFilter = document.getElementById('contact-industry-filter');
            if (industryFilter) {
                // Get industries from both contacts and companies
                const contactIndustries = [...new Set(contacts.map(c => c.industry).filter(Boolean))];
                const companyIndustries = [...new Set(contacts.map(c => c.company_industry || (c.companies && c.companies.industry)).filter(Boolean))];
                const allIndustries = [...new Set([...contactIndustries, ...companyIndustries])].sort();
                
                industryFilter.innerHTML = '<option value="">All Industries</option>';
                allIndustries.forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industryFilter.appendChild(option);
                });
                console.log(`Loaded ${allIndustries.length} industries into filter`);
            }
        }

        function filterContacts() {
            const search = document.getElementById('contact-search').value.toLowerCase();
            const companyFilter = document.getElementById('contact-company-filter').value;
            const industry = document.getElementById('contact-industry-filter').value;
            
            contactsFiltered = contacts.filter(c => {
                // Multi-field search: name, phone, email, company, industry, lead source
                const matchSearch = !search || 
                    (c.name && c.name.toLowerCase().includes(search)) ||
                    (c.email && c.email && c.email.toLowerCase().includes(search)) ||
                    (c.phone && c.phone && c.phone.toLowerCase().includes(search)) ||
                    (c.lead_source && c.lead_source.toLowerCase().includes(search)) ||
                    (c.role && c.role.toLowerCase().includes(search)) ||
                    (c.company && c.company.toLowerCase().includes(search)) ||
                    (c.company_name && c.company_name.toLowerCase().includes(search)) ||
                    (c.industry && c.industry.toLowerCase().includes(search));
                
                // Match company by ID or name (since filter might use either)
                const matchCompany = !companyFilter || 
                    c.company_id === companyFilter ||
                    c.company === companyFilter ||
                    c.company_name === companyFilter;
                
                const matchIndustry = !industry || c.industry === industry;
                return matchSearch && matchCompany && matchIndustry;
            });
            
            // Reset to first page when filtering
            contactsPage = 1;
            renderContacts();
        }

        function renderContacts() {
            const container = document.getElementById('contacts-list');
            if (!container) return;
            
            if (contactsFiltered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8">No contacts found</div>';
                return;
            }
            
            // Calculate pagination based on total records
            const totalRecords = contactsTotal || contacts.length;
            const filteredCount = contactsFiltered.length;
            const totalPages = Math.ceil(filteredCount / contactsPerPage);
            const startIdx = (contactsPage - 1) * contactsPerPage;
            const endIdx = Math.min(startIdx + contactsPerPage, filteredCount);
            const paginatedContacts = contactsFiltered.slice(startIdx, endIdx);
            
            // Add bulk actions header with pagination
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-slate-600">
                            Showing <strong>${startIdx + 1}-${endIdx}</strong> of <strong>${filteredCount}</strong> contacts
                            ${filteredCount !== totalRecords ? `(filtered from ${totalRecords} total)` : ''}
                        </div>
                        <div class="flex gap-2 items-center">
                            ${totalPages > 1 ? `
                                <div class="flex items-center gap-2">
                                    <button onclick="goToContactsPage(${contactsPage - 1})" ${contactsPage === 1 ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fa-solid fa-chevron-left"></i>
                                    </button>
                                    <span class="text-sm text-slate-600">Page ${contactsPage} / ${totalPages}</span>
                                    <button onclick="goToContactsPage(${contactsPage + 1})" ${contactsPage === totalPages ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </button>
                                </div>
                            ` : ''}
                            <button onclick="showPurgeContactsModal()" class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm font-bold">
                                <i class="fa-solid fa-trash mr-2"></i>Purge Selected
                            </button>
                            <button onclick="selectAllContacts()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm font-bold">
                                <i class="fa-solid fa-check-square mr-2"></i>Select All
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div style="overflow-x: visible; width: 100%;">
                        <table class="w-full text-xs" style="table-layout: fixed; width: 100%;">
                            <thead class="bg-slate-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-2 py-2 text-left w-8">
                                        <input type="checkbox" id="select-all-contacts" onchange="toggleSelectAllContacts()" class="rounded">
                                    </th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-32">Name</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-40">Email</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-28">Phone</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-32">Company</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-28">Designation</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-36">LinkedIn</th>
                                    <th class="px-2 py-2 text-center font-semibold text-slate-900 w-24">City</th>
                                    <th class="px-2 py-2 text-left font-semibold text-slate-900 w-28">Industry</th>
                                    <th class="px-2 py-2 text-center font-semibold text-slate-900 w-28">Lead Source</th>
                                    <th class="px-2 py-2 text-center font-semibold text-slate-900 w-16">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paginatedContacts.map((contact, idx) => `
                                    <tr id="contact-row-${contact.id}" class="border-b border-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'} hover:bg-indigo-50">
                                        <td class="px-1 py-1">
                                            <input type="checkbox" class="contact-checkbox rounded" value="${contact.id}" data-contact-id="${contact.id}">
                                        </td>
                                        <td class="px-1 py-1 font-medium text-slate-900 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="name" data-contact-id="${contact.id}" title="${contact.name || ''}">${contact.name || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="email" data-contact-id="${contact.id}" title="${contact.email || ''}">${contact.email || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="phone" data-contact-id="${contact.id}" title="${contact.phone || ''}">${contact.phone || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="company" data-contact-id="${contact.id}" title="${contact.company || contact.company_name || ''}">${contact.company || contact.company_name || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="role" data-contact-id="${contact.id}" title="${contact.role || ''}">${contact.role || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            <span class="editable-contact block truncate" data-field="linkedin" data-contact-id="${contact.id}">
                                            ${contact.linkedin ? `
                                                <a href="${contact.linkedin.startsWith('http') ? contact.linkedin : `https://${contact.linkedin}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${contact.linkedin}">${contact.linkedin.length > 25 ? contact.linkedin.substring(0, 25) + '...' : contact.linkedin}</a>
                                            ` : `‚Äî`}
                                            </span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden text-center">
                                            <span class="editable-contact inline-block truncate max-w-full" data-field="city" data-contact-id="${contact.id}" title="${contact.city || ''}">${contact.city || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden">
                                            ${contact.industry ? `
                                                <span class="editable-contact px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded inline-block" data-field="industry" data-contact-id="${contact.id}" title="${contact.industry}">${contact.industry}</span>
                                            ` : '<span class="editable-contact text-slate-400" data-field="industry" data-contact-id="${contact.id}">‚Äî</span>'}
                                        </td>
                                        <td class="px-1 py-1 text-slate-600 overflow-hidden text-center">
                                            <span class="editable-contact inline-block truncate max-w-full" data-field="lead_source" data-contact-id="${contact.id}" title="${contact.lead_source || ''}">${contact.lead_source || '‚Äî'}</span>
                                        </td>
                                        <td class="px-1 py-1 text-center">
                                            <div class="flex justify-center gap-1">
                                                <button onclick="viewContact('${contact.id}')" class="text-slate-600 hover:text-slate-700 text-xs" title="View">
                                                    <i class="fa-solid fa-eye"></i>
                                                </button>
                                                <button onclick="editContact('${contact.id}')" class="text-indigo-600 hover:text-indigo-700 text-xs" title="Edit">
                                                    <i class="fa-solid fa-edit"></i>
                                                </button>
                                                <button onclick="deleteContact('${contact.id}')" class="text-rose-600 hover:text-rose-700 text-xs" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function goToContactsPage(page) {
            const totalPages = Math.ceil(contactsFiltered.length / contactsPerPage);
            if (page >= 1 && page <= totalPages) {
                contactsPage = page;
                renderContacts();
            }
        }

        // This function is no longer used - keeping for backwards compatibility
        function startInlineEdit(contactId, field, currentValue) {
            // Deprecated - now using editContact() with row-level save
            console.warn('startInlineEdit is deprecated, use editContact() instead');
        }

        // This function is no longer used - keeping for backwards compatibility
        async function saveInlineEdit(contactId, field, newValue) {
            // Deprecated - now using saveContactEdits() with row-level save
            console.warn('saveInlineEdit is deprecated, use saveContactEdits() instead');
        }

        function editContactInline(contactId, companyId) {
            // Enable inline editing for contact fields in company view with row-level save
            const contactRow = document.getElementById(`contact-inline-${contactId}`);
            if (!contactRow) return;
            
            // Mark row as in edit mode
            contactRow.dataset.editing = 'true';
            contactRow.dataset.companyId = companyId;
            
            // Get contact data from the row
            const fields = ['name', 'email', 'role', 'phone', 'linkedin'];
            fields.forEach(field => {
                const span = contactRow.querySelector(`.inline-contact-field[data-field="${field}"]`);
                if (span && !span.querySelector('input')) {
                    let currentValue = '';
                    if (field === 'linkedin') {
                        const link = span.querySelector('a');
                        if (link) {
                            currentValue = link.href || link.textContent || '';
                        } else {
                            currentValue = span.textContent.trim() === '‚Äî' ? '' : span.textContent.trim();
                        }
                    } else {
                        currentValue = span.textContent.trim() === '‚Äî' ? '' : span.textContent.trim();
                    }
                    
                    // Create simple input without individual save/cancel
                    const input = document.createElement('input');
                    input.type = field === 'email' ? 'email' : field === 'linkedin' ? 'url' : 'text';
                    input.value = currentValue;
                    input.className = 'px-1 py-0.5 border border-indigo-300 rounded text-xs w-full';
                    input.dataset.field = field;
                    input.dataset.originalValue = currentValue;
                    
                    span.innerHTML = '';
                    span.appendChild(input);
                }
            });
            
            // Replace action buttons with Save/Cancel
            const actionsCell = contactRow.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = `
                    <div class="flex justify-center gap-1">
                        <button onclick="saveContactInlineEdits('${contactId}', '${companyId}')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-xs font-bold" title="Save All Changes">
                            <i class="fa-solid fa-check"></i>
                        </button>
                        <button onclick="cancelContactInlineEdits('${contactId}', '${companyId}')" class="px-2 py-1 bg-slate-600 hover:bg-slate-700 text-white rounded text-xs font-bold" title="Cancel">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        async function saveContactInlineEdits(contactId, companyId) {
            const contactRow = document.getElementById(`contact-inline-${contactId}`);
            if (!contactRow) return;
            
            // Collect all changed values
            const inputs = contactRow.querySelectorAll('input[data-field]');
            const updateData = {};
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                const newValue = input.value.trim();
                const originalValue = input.dataset.originalValue;
                
                // Only include changed fields
                if (newValue !== originalValue) {
                    updateData[field] = newValue || null;
                }
            });
            
            // If nothing changed, just cancel
            if (Object.keys(updateData).length === 0) {
                showToast('info', 'No Changes', 'No fields were modified', 2000);
                cancelContactInlineEdits(contactId, companyId);
                return;
            }
            
            // Show saving state
            const actionsCell = contactRow.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-emerald-600"></i>';
            }
            
            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                if (result.success) {
                    const fieldsUpdated = Object.keys(updateData).join(', ');
                    showToast('success', 'OK - Updated', `Contact updated: ${fieldsUpdated}`, 3000);
                    // Reload the inline contacts view after delay
                    setTimeout(async () => {
                        const response2 = await fetch(`/api/companies/${companyId}`, { credentials: 'include' });
                        const data2 = await response2.json();
                        if (data2.success) {
                            renderCompanyContactsInline(companyId, data2.contacts);
                        }
                    }, 1000);
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update contact', 5000);
                    cancelContactInlineEdits(contactId, companyId);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
                cancelContactInlineEdits(contactId, companyId);
            }
        }
        
        function cancelContactInlineEdits(contactId, companyId) {
            const contactRow = document.getElementById(`contact-inline-${contactId}`);
            if (!contactRow) return;
            
            // Restore original values
            const inputs = contactRow.querySelectorAll('input[data-field]');
            inputs.forEach(input => {
                const field = input.dataset.field;
                const span = input.parentElement;
                const originalValue = input.dataset.originalValue;
                
                if (field === 'linkedin' && originalValue && (originalValue.startsWith('http') || originalValue.includes('linkedin.com'))) {
                    span.innerHTML = `<a href="${originalValue.startsWith('http') ? originalValue : `https://${originalValue}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${originalValue}">${originalValue.length > 20 ? originalValue.substring(0, 20) + '...' : originalValue}</a>`;
                } else {
                    span.textContent = originalValue || '‚Äî';
                    if (!originalValue) span.className = 'inline-contact-field text-slate-400';
                }
            });
            
            // Restore action buttons
            const actionsCell = contactRow.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = `
                    <div class="flex justify-center gap-1">
                        <button onclick="editContactInline('${contactId}', '${companyId}')" class="text-indigo-600 hover:text-indigo-700" title="Edit">
                            <i class="fa-solid fa-edit text-xs"></i>
                        </button>
                        <button onclick="deleteSingleContactInline('${contactId}', '${companyId}')" class="text-rose-600 hover:text-rose-700" title="Delete">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
            }
            
            // Remove edit mode flag
            delete contactRow.dataset.editing;
        }

        function startInlineEditContact(contactId, field, currentValue, companyId) {
            const span = document.querySelector(`#contact-inline-${contactId} .inline-contact-field[data-field="${field}"]`);
            if (!span || span.querySelector('input')) return;
            
            const originalValue = currentValue === '‚Äî' ? '' : currentValue;
            const input = document.createElement('input');
            input.type = field === 'email' ? 'email' : field === 'linkedin' ? 'url' : 'text';
            input.value = originalValue;
            input.className = 'px-1 py-0.5 border border-indigo-300 rounded text-xs w-full';
            input.placeholder = field === 'linkedin' ? 'LinkedIn URL' : '';
            input.style.minWidth = '80px';
            input.style.width = '100%';
            
            let saved = false;
            input.onblur = () => {
                if (!saved) {
                    saveInlineEditContact(contactId, field, input.value, companyId);
                    saved = true;
                }
            };
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saved = true;
                    saveInlineEditContact(contactId, field, input.value, companyId);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    saved = true;
                    // Restore original value - handle LinkedIn specially
                    if (field === 'linkedin' && originalValue && (originalValue.startsWith('http') || originalValue.includes('linkedin.com'))) {
                        span.innerHTML = `<a href="${originalValue.startsWith('http') ? originalValue : `https://${originalValue}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${originalValue}">${originalValue.length > 20 ? originalValue.substring(0, 20) + '...' : originalValue}</a>`;
                    } else {
                        span.textContent = originalValue || '‚Äî';
                        if (!originalValue) span.className = 'inline-contact-field text-slate-400';
                    }
                }
            };
            
            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();
        }

        async function saveInlineEditContact(contactId, field, newValue, companyId) {
            const span = document.querySelector(`#contact-inline-${contactId} .inline-contact-field[data-field="${field}"]`);
            if (!span) return;
            
            span.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            try {
                const updateData = { [field]: newValue || null };
                
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                if (result.success) {
                    // Update display - handle LinkedIn specially
                    if (field === 'linkedin' && newValue && newValue.trim()) {
                        const linkedinValue = newValue.trim();
                        if (linkedinValue.startsWith('http') || linkedinValue.includes('linkedin.com')) {
                            span.innerHTML = `<a href="${linkedinValue.startsWith('http') ? linkedinValue : `https://${linkedinValue}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${linkedinValue}">${linkedinValue.length > 20 ? linkedinValue.substring(0, 20) + '...' : linkedinValue}</a>`;
                        } else {
                            span.textContent = linkedinValue || '‚Äî';
                            if (!linkedinValue) span.className = 'inline-contact-field text-slate-400';
                        }
                    } else {
                        span.textContent = newValue || '‚Äî';
                        if (!newValue && field === 'linkedin') span.className = 'inline-contact-field text-slate-400';
                    }
                    showToast('success', 'OK - Updated', 'Contact updated successfully', 2000);
                    // Reload company contacts to refresh data
                    const response2 = await fetch(`/api/companies/${companyId}`, { credentials: 'include' });
                    const data2 = await response2.json();
                    if (data2.success && data2.contacts) {
                        renderCompanyContactsInline(companyId, data2.contacts);
                    }
                } else {
                    span.textContent = newValue || '‚Äî';
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update contact', 3000);
                }
            } catch (error) {
                span.textContent = newValue || '‚Äî';
                showToast('error', 'Not OK - Network Error', error.message, 3000);
            }
        }

        function toggleSelectAllContacts() {
            const selectAll = document.getElementById('select-all-contacts');
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('select-all-contacts').checked = true;
        }

        function showPurgeContactsModal() {
            const selected = Array.from(document.querySelectorAll('.contact-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                showToast('warning', 'No Selection', 'Please select contacts to purge', 3000);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selected.length} contact(s)? This action cannot be undone.`)) {
                return;
            }
            
            purgeContacts(selected);
        }

        async function purgeContacts(contactIds) {
            try {
                showToast('info', 'Deleting...', `Deleting ${contactIds.length} contacts...`, 2000);
                
                // Delete in batches
                const batchSize = 10;
                for (let i = 0; i < contactIds.length; i += batchSize) {
                    const batch = contactIds.slice(i, i + batchSize);
                    await Promise.all(batch.map(id => 
                        fetch(`/api/contacts/${id}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        })
                    ));
                }
                
                showToast('success', 'OK - Deleted', `Successfully deleted ${contactIds.length} contacts`, 3000);
                loadContacts();
            } catch (error) {
                console.error('Error purging contacts:', error);
                showToast('error', 'Not OK - Failed', 'Failed to delete contacts', 5000);
            }
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Deleted', 'Contact deleted successfully', 3000);
                    loadContacts();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to delete contact', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function showAddContactModal() {
            // Simple prompt for now - can be enhanced with a modal
            const name = prompt('Contact Name:');
            if (!name) return;
            
            const email = prompt('Email (optional):');
            const phone = prompt('Phone (optional):');
            const company = prompt('Company Name:');
            const role = prompt('Role (optional):');
            
            createContact({ name, email: email || null, phone: phone || null, company, role: role || null });
        }

        async function createContact(data) {
            try {
                const response = await fetch('/api/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Created', 'Contact created successfully', 3000);
                    loadContacts();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to create contact', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function showEditContactModal(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            // Create or update edit modal
            let modal = document.getElementById('edit-contact-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'edit-contact-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-slate-900 mb-6">Edit Contact</h3>
                    <form id="edit-contact-form" onsubmit="saveContactEdit(event, '${contactId}')">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Name *</label>
                                <input type="text" id="edit-name" value="${(contact.name || '').replace(/"/g, '&quot;')}" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Designation</label>
                                <input type="text" id="edit-role" value="${(contact.role || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Email</label>
                                <input type="email" id="edit-email" value="${(contact.email || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Phone</label>
                                <input type="tel" id="edit-phone" value="${(contact.phone || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">LinkedIn</label>
                                <input type="url" id="edit-linkedin" value="${(contact.linkedin || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Company</label>
                                <input type="text" id="edit-company" value="${((contact.company || contact.company_name) || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">City</label>
                                <input type="text" id="edit-city" value="${(contact.city || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Industry</label>
                                <input type="text" id="edit-industry" value="${(contact.industry || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Lead Source</label>
                                <input type="text" id="edit-lead_source" value="${(contact.lead_source || '').replace(/"/g, '&quot;')}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4 border-t border-slate-200">
                            <button type="button" onclick="document.getElementById('edit-contact-modal').remove()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-bold">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function saveContactEdit(event, contactId) {
            event.preventDefault();
            const data = {
                name: document.getElementById('edit-name').value,
                role: document.getElementById('edit-role').value || null,
                email: document.getElementById('edit-email').value || null,
                phone: document.getElementById('edit-phone').value || null,
                linkedin: document.getElementById('edit-linkedin').value || null,
                company: document.getElementById('edit-company').value || null,
                city: document.getElementById('edit-city').value || null,
                industry: document.getElementById('edit-industry').value || null,
                lead_source: document.getElementById('edit-lead_source').value || null
            };
            updateContact(contactId, data);
            document.getElementById('edit-contact-modal').remove();
        }

        function viewContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) {
                showToast('error', 'Error', 'Contact not found', 3000);
                return;
            }
            
            // Scroll to contact row and highlight it
            const contactRow = document.getElementById(`contact-row-${contactId}`);
            if (contactRow) {
                contactRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                contactRow.classList.add('bg-indigo-100');
                setTimeout(() => contactRow.classList.remove('bg-indigo-100'), 3000);
            }
            
            // Show contact details in a simple view
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-900">Contact Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Name</label>
                            <p class="text-slate-900">${escapeHtml(contact.name || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Email</label>
                            <p class="text-slate-900">${escapeHtml(contact.email || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Phone</label>
                            <p class="text-slate-900">${escapeHtml(contact.phone || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Company</label>
                            <p class="text-slate-900">${escapeHtml(contact.company || contact.company_name || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Designation</label>
                            <p class="text-slate-900">${escapeHtml(contact.role || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">LinkedIn</label>
                            ${contact.linkedin ? `
                                <a href="${contact.linkedin.startsWith('http') ? contact.linkedin : `https://${contact.linkedin}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">
                                    ${escapeHtml(contact.linkedin)}
                                </a>
                            ` : '<p class="text-slate-400">‚Äî</p>'}
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">City</label>
                            <p class="text-slate-900">${escapeHtml(contact.city || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Industry</label>
                            <p class="text-slate-900">${escapeHtml(contact.industry || '‚Äî')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Lead Source</label>
                            <p class="text-slate-900">${escapeHtml(contact.lead_source || '‚Äî')}</p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-4 pt-4 border-t border-slate-200">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-bold">
                            Close
                        </button>
                        <button onclick="editContact('${contactId}'); this.closest('.fixed').remove();" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-edit mr-2"></i>Edit
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function editContact(contactId) {
            // Enable inline editing for all fields when edit icon is clicked
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) {
                showToast('error', 'Error', 'Contact not found', 3000);
                return;
            }
            
            const row = document.getElementById(`contact-row-${contactId}`);
            if (!row) return;
            
            // Mark row as in edit mode
            row.dataset.editing = 'true';
            
            // Make all fields editable
            const fields = ['name', 'email', 'phone', 'company', 'role', 'linkedin', 'city', 'industry', 'lead_source'];
            fields.forEach(field => {
                const span = row.querySelector(`[data-field="${field}"]`);
                if (span && !span.querySelector('input')) {
                    let value = '';
                    if (field === 'company') {
                        value = contact.company || contact.company_name || '';
                    } else if (field === 'linkedin') {
                        const link = span.querySelector('a');
                        value = link ? (link.href || link.textContent) : (contact.linkedin || '');
                    } else {
                        value = contact[field] || '';
                    }
                    
                    // Create simple input without save/cancel buttons
                    const input = document.createElement('input');
                    input.type = field === 'email' ? 'email' : field === 'linkedin' ? 'url' : 'text';
                    input.value = value;
                    input.className = 'px-1 py-0.5 border border-indigo-300 rounded text-xs w-full';
                    input.dataset.field = field;
                    input.dataset.originalValue = value;
                    
                    span.innerHTML = '';
                    span.appendChild(input);
                }
            });
            
            // Replace action buttons with Save/Cancel
            const actionsCell = row.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = `
                    <div class="flex justify-center gap-1">
                        <button onclick="saveContactEdits('${contactId}')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-xs font-bold" title="Save All Changes">
                            <i class="fa-solid fa-check mr-1"></i>Save
                        </button>
                        <button onclick="cancelContactEdits('${contactId}')" class="px-2 py-1 bg-slate-600 hover:bg-slate-700 text-white rounded text-xs font-bold" title="Cancel">
                            <i class="fa-solid fa-times mr-1"></i>Cancel
                        </button>
                    </div>
                `;
            }
        }
        
        async function saveContactEdits(contactId) {
            const row = document.getElementById(`contact-row-${contactId}`);
            if (!row) return;
            
            // Collect all changed values
            const inputs = row.querySelectorAll('input[data-field]');
            const updateData = {};
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                const newValue = input.value.trim();
                const originalValue = input.dataset.originalValue;
                
                // Only include changed fields
                if (newValue !== originalValue) {
                    updateData[field] = newValue || null;
                }
            });
            
            // If nothing changed, just cancel
            if (Object.keys(updateData).length === 0) {
                showToast('info', 'No Changes', 'No fields were modified', 2000);
                cancelContactEdits(contactId);
                return;
            }
            
            // Show saving state
            const actionsCell = row.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-emerald-600"></i>';
            }
            
            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                if (result.success) {
                    const fieldsUpdated = Object.keys(updateData).join(', ');
                    showToast('success', 'OK - Updated', `Updated: ${fieldsUpdated}`, 3000);
                    // Reload contacts after delay
                    setTimeout(() => loadContacts(), 1000);
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update contact', 5000);
                    cancelContactEdits(contactId);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
                cancelContactEdits(contactId);
            }
        }
        
        function cancelContactEdits(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) {
                loadContacts();
                return;
            }
            
            const row = document.getElementById(`contact-row-${contactId}`);
            if (!row) return;
            
            // Restore original values
            const inputs = row.querySelectorAll('input[data-field]');
            inputs.forEach(input => {
                const field = input.dataset.field;
                const span = input.parentElement;
                const originalValue = input.dataset.originalValue;
                
                if (field === 'linkedin' && originalValue && (originalValue.startsWith('http') || originalValue.includes('linkedin.com'))) {
                    span.innerHTML = `<a href="${originalValue.startsWith('http') ? originalValue : `https://${originalValue}`}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();" title="${originalValue}">${originalValue.length > 25 ? originalValue.substring(0, 25) + '...' : originalValue}</a>`;
                } else {
                    span.textContent = originalValue || '‚Äî';
                }
            });
            
            // Restore action buttons
            const actionsCell = row.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = `
                    <div class="flex justify-center gap-1">
                        <button onclick="viewContact('${contactId}')" class="text-slate-600 hover:text-slate-700 text-xs" title="View">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button onclick="editContact('${contactId}')" class="text-indigo-600 hover:text-indigo-700 text-xs" title="Edit">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button onclick="deleteContact('${contactId}')" class="text-rose-600 hover:text-rose-700 text-xs" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            
            // Remove edit mode flag
            delete row.dataset.editing;
        }

        async function updateContact(contactId, data) {
            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Updated', 'Contact updated successfully', 3000);
                    loadContacts();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to update contact', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function showImportExcelModal() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                await importExcelContacts(file);
            };
            input.click();
        }

        async function importExcelContacts(file) {
            // First, get headers to show column mapping
            const formData = new FormData();
            formData.append('file', file);
            formData.append('get_headers', 'true');
            
            showToast('info', 'Processing...', 'Reading Excel file headers...', 3000);
            
            try {
                const headersResponse = await fetch('/api/contacts/import-excel', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const headersData = await headersResponse.json();
                
                if (headersData.headers) {
                    // Show column mapping modal
                    showColumnMappingModal(headersData.headers, file);
                } else {
                    // Fallback: proceed with auto-mapping
                    proceedWithImport(file, {});
                }
            } catch (error) {
                console.error('Error reading Excel headers:', error);
                // Fallback: proceed with auto-mapping
                proceedWithImport(file, {});
            }
        }

        function showColumnMappingModal(excelHeaders, file) {
            const fieldMapping = {
                'name': 'Name',
                'role': 'Designation',
                'email': 'Email',
                'linkedin': 'LinkedIn',
                'phone': 'Phone',
                'lead_source': 'Source',
                'company': 'Company',
                'city': 'City',
                'industry': 'Industry'
            };
            
            let modal = document.createElement('div');
            modal.id = 'column-mapping-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            
            const mappingRows = Object.entries(fieldMapping).map(([dbField, displayName]) => {
                const currentValue = excelHeaders.find(h => 
                    h.toLowerCase().replace(/[^a-z0-9]/g, '') === dbField.toLowerCase().replace(/[^a-z0-9]/g, '') ||
                    (dbField === 'role' && (h.toLowerCase().includes('designation') || h.toLowerCase().includes('role'))) ||
                    (dbField === 'lead_source' && (h.toLowerCase().includes('source') || h.toLowerCase().includes('lead')))
                );
                
                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="px-2 py-1 font-medium text-slate-900 text-xs">${displayName}</td>
                        <td class="px-2 py-1">
                            <select class="w-full px-1.5 py-0.5 text-xs border border-slate-300 rounded" data-field="${dbField}" style="font-size: 11px; line-height: 1.4;">
                                <option value="">Auto-detect</option>
                                ${excelHeaders.map(h => `<option value="${h}" ${currentValue === h ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-3 max-w-lg w-full mx-4" style="overflow: hidden; display: flex; flex-direction: column;">
                    <h3 class="text-sm font-bold text-slate-900 mb-1">Map Excel Columns to Database Fields</h3>
                    <p class="text-xs text-slate-500 mb-2">Select Excel column for each field. Use "Auto-detect" for automatic mapping.</p>
                    <div class="mb-2" style="overflow: hidden;">
                        <table class="w-full text-xs" style="table-layout: fixed; width: 100%;">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-2 py-1 text-left font-semibold text-slate-900 text-xs" style="width: 35%;">Database Field</th>
                                    <th class="px-2 py-1 text-left font-semibold text-slate-900 text-xs" style="width: 65%;">Excel Column</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mappingRows}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-2 pt-2 border-t border-slate-200">
                        <button onclick="document.getElementById('column-mapping-modal').remove()" class="px-3 py-1 text-xs border border-slate-300 rounded text-slate-700 hover:bg-slate-50 font-semibold">
                            Cancel
                        </button>
                        <button onclick="applyColumnMapping('${file.name}')" class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white rounded font-semibold">
                            Continue
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store file reference
            window.currentImportFile = file;
            window.currentExcelHeaders = excelHeaders;
        }

        function applyColumnMapping(fileName) {
            const modal = document.getElementById('column-mapping-modal');
            if (!modal) return;
            
            const columnMap = {};
            modal.querySelectorAll('select[data-field]').forEach(select => {
                const dbField = select.getAttribute('data-field');
                const excelColumn = select.value;
                if (excelColumn) {
                    columnMap[excelColumn] = dbField;
                }
            });
            
            modal.remove();
            
            // Proceed with import using the column mapping
            proceedWithImport(window.currentImportFile, columnMap);
        }

        async function proceedWithImport(file, columnMap) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('preview', 'true');
            if (Object.keys(columnMap).length > 0) {
                formData.append('columnMap', JSON.stringify(columnMap));
            }
            
            showToast('info', 'Processing...', 'Uploading and parsing Excel file...', 3000);
            
            try {
                const previewResponse = await fetch('/api/contacts/import-excel', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const previewData = await previewResponse.json();
                
                if (previewData.preview) {
                    showImportPreviewModal(previewData, file);
                } else {
                    showToast('error', 'Not OK - Failed', previewData.error || 'Preview failed', 5000);
                }
            } catch (error) {
                console.error('Error importing Excel:', error);
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            }
        }

        function showImportProgressModal(total, isBackground = false) {
            // Create or update progress modal
            let modal = document.getElementById('import-progress-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'import-progress-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full mx-4">
                    <h3 class="text-2xl font-bold text-slate-900 mb-4">Importing Contacts</h3>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-slate-600 mb-2">
                            <span id="progress-message">Processing records...</span>
                            <span id="progress-text">0 / ${total}</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                            <div id="progress-bar" class="bg-emerald-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="progress-status" class="text-sm text-slate-600">Starting import...</div>
                    ${isBackground ? '<div class="mt-2 text-xs text-slate-500"><i class="fa-solid fa-info-circle mr-1"></i>Large file detected - processing in background</div>' : ''}
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function updateImportProgress(current, total, status) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressStatus = document.getElementById('progress-status');
            const progressMessage = document.getElementById('progress-message');
            
            if (progressBar) {
                // Ensure current never exceeds total
                const safeCurrent = Math.min(current, total);
                const percent = Math.min(Math.round((safeCurrent / total) * 100), 100);
                progressBar.style.width = `${percent}%`;
                if (progressText) {
                    progressText.textContent = `${safeCurrent} / ${total}`;
                }
                if (status && progressStatus) {
                    progressStatus.textContent = status;
                }
                if (status && progressMessage) {
                    progressMessage.textContent = status;
                }
            }
        }

        function hideImportProgressModal() {
            const modal = document.getElementById('import-progress-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showImportPreviewModal(previewData, file) {
            const counts = previewData.counts;
            const duplicates = previewData.duplicates || [];
            const uniques = previewData.uniques || [];
            const duplicateCheck = previewData.duplicate_check || 'Checks for duplicates by: Email (primary) and Phone (secondary)';
            const sheets = previewData.sheets || [];
            
            let modal = document.createElement('div');
            modal.id = 'import-preview-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            document.body.appendChild(modal);
            
            const sheetsInfo = sheets.length > 0 ? `
                <div class="mb-4 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-sm text-indigo-800"><strong>Sheets Processed:</strong> ${sheets.join(', ')} (${sheets.length} of ${previewData.sheets_total || sheets.length} total)</p>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-slate-900">Import Preview</h3>
                        <button onclick="document.getElementById('import-preview-modal').remove()" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    ${sheetsInfo}
                    
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800"><strong>Duplicate Detection:</strong> ${duplicateCheck}</p>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-sm text-slate-600">Total</div>
                            <div class="text-2xl font-bold text-slate-900">${counts.total}</div>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <div class="text-sm text-amber-600">Duplicates</div>
                            <div class="text-2xl font-bold text-amber-600">${counts.duplicates}</div>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-lg">
                            <div class="text-sm text-emerald-600">New</div>
                            <div class="text-2xl font-bold text-emerald-600">${counts.uniques}</div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <div class="text-sm text-indigo-600">Email Matches</div>
                            <div class="text-2xl font-bold text-indigo-600">${previewData.breakdown?.emailMatches || 0}</div>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-slate-900 mb-2">Duplicates (${duplicates.length})</h4>
                                <div class="border border-slate-200 rounded-lg max-h-96 overflow-y-auto">
                                    <table class="w-full text-xs">
                                        <thead class="bg-slate-100 sticky top-0">
                                            <tr>
                                                <th class="px-2 py-1 text-left">Name</th>
                                                <th class="px-2 py-1 text-left">Email</th>
                                                <th class="px-2 py-1 text-left">Match</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${duplicates.map((d, idx) => `
                                                <tr class="border-b border-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                                    <td class="px-2 py-1">${d.name || ''}</td>
                                                    <td class="px-2 py-1">${d.email || ''}</td>
                                                    <td class="px-2 py-1">
                                                        <span class="px-1 py-0.5 rounded text-xs ${d.match_type === 'email' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                                                            ${d.match_type}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-900 mb-2">New Contacts (${uniques.length})</h4>
                                <div class="border border-slate-200 rounded-lg max-h-96 overflow-y-auto">
                                    <table class="w-full text-xs">
                                        <thead class="bg-slate-100 sticky top-0">
                                            <tr>
                                                <th class="px-2 py-1 text-left">Name</th>
                                                <th class="px-2 py-1 text-left">Email</th>
                                                <th class="px-2 py-1 text-left">Company</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${uniques.map((u, idx) => `
                                                <tr class="border-b border-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                                    <td class="px-2 py-1">${u.name || ''}</td>
                                                    <td class="px-2 py-1">${u.email || ''}</td>
                                                    <td class="px-2 py-1">${u.company || ''}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-4 pt-4 border-t border-slate-200">
                        <button onclick="document.getElementById('import-preview-modal').remove()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-bold">
                            Cancel
                        </button>
                        <button onclick="proceedImport('${file.name}', false)" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-bold">
                            Import All (${counts.total})
                        </button>
                        <button onclick="proceedImport('${file.name}', true)" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-bold">
                            Import Only New (${counts.uniques})
                        </button>
                    </div>
                </div>
            `;
            
            // Store file reference
            window.currentImportFile = file;
        }

        async function proceedImport(fileName, importOnlyNew) {
            const modal = document.getElementById('import-preview-modal');
            if (modal) {
                modal.remove();
            }
            
            const file = window.currentImportFile;
            if (!file) {
                showToast('error', 'Not OK - Failed', 'File reference lost. Please try importing again.', 5000);
                return;
            }
            
            // Get preview data again to know counts
            const formData = new FormData();
            formData.append('file', file);
            formData.append('preview', 'true');
            
            try {
                const previewResponse = await fetch('/api/contacts/import-excel', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const contentType = previewResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await previewResponse.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    showToast('error', 'Not OK - Failed', 'Server returned invalid response', 5000);
                    return;
                }
                
                const previewData = await previewResponse.json();
                
                if (!previewData.preview) {
                    showToast('error', 'Not OK - Failed', previewData.error || 'Preview failed', 5000);
                    return;
                }
                
                const counts = previewData.counts;
                const totalToImport = importOnlyNew ? counts.uniques : counts.total;
                
                showImportProgressModal(totalToImport);
                
                // Simulate progress - use actual counts, not percentages
                let simulatedProgress = 0;
                let progressMessage = 'Uploading to server...';
                const maxSimulatedProgress = Math.max(1, Math.floor(totalToImport * 0.85)); // Cap at 85% of total, min 1
                
                const progressInterval = setInterval(() => {
                    // Increment by a small amount based on total
                    // For small imports (< 20), increment by 1; for larger, use percentage
                    const increment = totalToImport < 20 
                        ? 1 
                        : Math.max(1, Math.floor(totalToImport * 0.015)); // 1.5% of total per interval, min 1
                    
                    simulatedProgress = Math.min(simulatedProgress + increment, maxSimulatedProgress);
                    
                    if (simulatedProgress < maxSimulatedProgress * 0.6) {
                        progressMessage = 'Uploading to server...';
                        updateImportProgress(simulatedProgress, totalToImport, progressMessage);
                    } else if (simulatedProgress < maxSimulatedProgress) {
                        progressMessage = 'Processing records on server...';
                        updateImportProgress(simulatedProgress, totalToImport, progressMessage);
                    } else {
                        progressMessage = 'Processing records on server...';
                        updateImportProgress(maxSimulatedProgress, totalToImport, progressMessage);
                    }
                }, 500); // Slower interval to prevent rapid updates
                
                // Commit
                const commitFormData = new FormData();
                commitFormData.append('file', file);
                commitFormData.append('commit', 'true');
                commitFormData.append('force', 'true');
                commitFormData.append('importOnlyNew', importOnlyNew ? 'true' : 'false');
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 300000);
                    
                    const commitResponse = await fetch('/api/contacts/import-excel', {
                        method: 'POST',
                        credentials: 'include',
                        body: commitFormData,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // Check if response is OK first
                    if (!commitResponse.ok) {
                        let errorMessage = `HTTP ${commitResponse.status}: ${commitResponse.statusText}`;
                        try {
                            const errorText = await commitResponse.text();
                            if (errorText) {
                                try {
                                    const errorJson = JSON.parse(errorText);
                                    errorMessage = errorJson.error || errorJson.message || errorMessage;
                                } catch {
                                    errorMessage = errorText.substring(0, 200) || errorMessage;
                                }
                            }
                        } catch (e) {
                            console.error('Error reading error response:', e);
                        }
                        clearInterval(progressInterval);
                        hideImportProgressModal();
                        showToast('error', 'Not OK - Failed', errorMessage, 8000);
                        console.error('Import failed:', errorMessage);
                        return;
                    }
                    
                    const contentType2 = commitResponse.headers.get('content-type');
                    if (!contentType2 || !contentType2.includes('application/json')) {
                        const text = await commitResponse.text();
                        console.error('Non-JSON response:', text.substring(0, 200));
                        clearInterval(progressInterval);
                        hideImportProgressModal();
                        showToast('error', 'Not OK - Failed', 'Server returned invalid response', 5000);
                        return;
                    }
                    
                    const commitData = await commitResponse.json();
                    
                    clearInterval(progressInterval);
                    
                    console.log('Import response:', commitData); // Debug log
                    
                    // Check if this is a background job
                    if (commitData.job_id && commitData.use_background) {
                        // Start polling for job status
                        pollJobStatus(commitData.job_id, totalToImport);
                        return;
                    }
                    
                    // Handle synchronous import response
                    if (commitData.error && !commitData.success) {
                        clearInterval(progressInterval);
                        hideImportProgressModal();
                        showToast('error', 'Not OK - Failed', commitData.error || 'Import failed', 5000);
                        return;
                    }
                    
                    // Clear the progress interval before showing completion
                    clearInterval(progressInterval);
                    
                    // Update to actual imported count if available, otherwise use total
                    // The response should have 'imported' field, but fallback to total if not available
                    const actualImported = commitData.imported !== undefined ? commitData.imported : (commitData.total || totalToImport);
                    const actualTotal = commitData.total !== undefined ? commitData.total : totalToImport;
                    
                    // Always update progress to completion - ensure it shows 100%
                    updateImportProgress(actualTotal, actualTotal, 'Import completed!');
                    
                    setTimeout(() => {
                        hideImportProgressModal();
                        
                        // Check for success - either imported field exists, or success flag is true
                        if (commitData.imported !== undefined || commitData.success !== false) {
                            if (commitData.report && commitData.report.length > 0) {
                                showImportResultsModal(commitData);
                            }
                            // Show toast only once
                            showToast('success', 'OK - Imported', `Successfully imported ${actualImported} of ${actualTotal} contacts`, 5000);
                            // Reload data only once, without page refresh
                            loadContacts();
                            loadCompanies();
                        } else {
                            showToast('error', 'Not OK - Failed', commitData.error || 'Import failed', 5000);
                        }
                    }, 500);
                } catch (error) {
                    clearInterval(progressInterval);
                    hideImportProgressModal();
                    
                    if (error.name === 'AbortError') {
                        showToast('error', 'Not OK - Timeout', 'Import took too long (>5 minutes). Please try with a smaller file or check server logs.', 8000);
                    } else {
                        console.error('Import error:', error);
                        showToast('error', 'Not OK - Failed', error.message || 'Import failed. Check console for details.', 5000);
                    }
                }
            } catch (error) {
                console.error('Error in proceedImport:', error);
                showToast('error', 'Not OK - Failed', error.message || 'Failed to proceed with import', 5000);
            }
        }

        // Track active polling to prevent duplicates
        const activePollingJobs = new Set();
        
        function pollJobStatus(jobId, totalRecords) {
            // Prevent duplicate polling for the same job
            if (activePollingJobs.has(jobId)) {
                console.log(`Already polling job ${jobId}, skipping duplicate poll`);
                return;
            }
            activePollingJobs.add(jobId);
            
            let pollCount = 0;
            const maxPolls = 1200; // Poll for up to 20 minutes (1200 * 1 second) for very large files
            let isCompleted = false; // Guard to prevent multiple completion handlers
            
            const pollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch(`/api/jobs/${jobId}`, { credentials: 'include' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success && data.job) {
                        const job = data.job;
                        
                        // Update progress
                        const processed = job.processed_records || 0;
                        const total = job.total_records || totalRecords || 1;
                        const percent = total > 0 ? Math.min(100, Math.floor((processed / total) * 100)) : 0;
                        
                        // Update progress message
                        const progressMessage = document.getElementById('progress-message');
                        if (progressMessage) {
                            progressMessage.textContent = job.progress_message || `Processing... ${processed}/${total}`;
                        }
                        
                        updateImportProgress(processed, total, job.progress_message || `Processing... ${processed}/${total}`);
                        
                        // Check if job is complete
                        if (job.status === 'completed' && !isCompleted) {
                            isCompleted = true; // Set flag to prevent multiple completions
                            clearInterval(pollInterval);
                            activePollingJobs.delete(jobId);
                            updateImportProgress(total, total, 'Import completed!');
                            
                            setTimeout(() => {
                                hideImportProgressModal();
                                const message = `Successfully imported ${job.imported_count || 0} of ${total} contacts`;
                                const details = [];
                                if (job.error_count > 0) details.push(`${job.error_count} errors`);
                                if (job.skipped_count > 0) details.push(`${job.skipped_count} skipped`);
                                const fullMessage = details.length > 0 ? `${message}. ${details.join(', ')}.` : message;
                                // Show toast only once
                                showToast('success', 'OK - Imported', fullMessage, 5000);
                                // Only reload data once, without page refresh - debounced
                                setTimeout(() => {
                                    loadContacts();
                                    loadCompanies();
                                }, 500);
                            }, 1000);
                        } else if (job.status === 'failed' && !isCompleted) {
                            isCompleted = true;
                            clearInterval(pollInterval);
                            activePollingJobs.delete(jobId);
                            hideImportProgressModal();
                            const errorMsg = job.progress_message || 'Import failed';
                            showToast('error', 'Not OK - Failed', errorMsg, 5000);
                        } else if (job.status === 'cancelled' && !isCompleted) {
                            isCompleted = true;
                            clearInterval(pollInterval);
                            activePollingJobs.delete(jobId);
                            hideImportProgressModal();
                            showToast('info', 'Cancelled', 'Import was cancelled', 3000);
                        }
                    } else {
                        throw new Error(data.error || 'Failed to get job status');
                    }
                } catch (error) {
                    console.error('Error polling job status:', error);
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        activePollingJobs.delete(jobId);
                        hideImportProgressModal();
                        showToast('error', 'Not OK - Timeout', 'Job status polling timed out. The import may still be processing. Check job status manually.', 5000);
                    }
                }
            }, 1000); // Poll every second
            
            // Store interval ID so we can clear it if needed
            window.currentJobPollInterval = pollInterval;
        }

        function showImportResultsModal(data) {
            // Create results modal
            let modal = document.getElementById('import-results-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'import-results-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                document.body.appendChild(modal);
            }
            
            const detailedReport = data.detailed_report || [];
            const okCount = detailedReport.filter(r => r.status === 'OK').length;
            const notOkCount = detailedReport.filter(r => r.status === 'Not OK').length;
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-slate-900">Import Results</h3>
                        <button onclick="document.getElementById('import-results-modal').classList.add('hidden')" class="text-slate-500 hover:text-slate-700">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-sm text-slate-600">Total</div>
                            <div class="text-2xl font-bold text-slate-900">${data.total || 0}</div>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-lg">
                            <div class="text-sm text-emerald-600">OK</div>
                            <div class="text-2xl font-bold text-emerald-600">${okCount}</div>
                        </div>
                        <div class="bg-rose-50 p-4 rounded-lg">
                            <div class="text-sm text-rose-600">Not OK</div>
                            <div class="text-2xl font-bold text-rose-600">${notOkCount}</div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto border border-slate-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left">#</th>
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Email</th>
                                    <th class="px-4 py-2 text-left">Status</th>
                                    <th class="px-4 py-2 text-left">Message</th>
                                </tr>
                            </thead>
                            <tbody id="import-results-body">
                                ${detailedReport.map(r => `
                                    <tr class="border-b border-slate-100 ${r.status === 'OK' ? 'bg-emerald-50' : 'bg-rose-50'}">
                                        <td class="px-4 py-2">${r.index}</td>
                                        <td class="px-4 py-2">${r.name || ''}</td>
                                        <td class="px-4 py-2">${r.email || ''}</td>
                                        <td class="px-4 py-2">
                                            <span class="px-2 py-1 rounded-full text-xs font-bold ${r.status === 'OK' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                                                ${r.status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2">${r.message || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="document.getElementById('import-results-modal').classList.add('hidden')" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-bold">
                            Close
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function exportContactsExcel() {
            try {
                showToast('info', 'Exporting...', 'Preparing Excel export...', 2000);
                
                const response = await fetch('/api/contacts/export-excel', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                // Check if response is JSON (error) or binary (file)
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // It's an error response
                    const error = await response.json();
                    showToast('error', 'Not OK - Failed', error.error || 'Export failed', 5000);
                    return;
                }
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `contacts_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'OK - Exported', 'Contacts exported to Excel successfully', 3000);
                } else {
                    // Try to parse as text first to see what we got
                    const text = await response.text();
                    console.error('Export error response:', text);
                    showToast('error', 'Not OK - Failed', 'Export failed. Please check console for details.', 5000);
                }
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
            }
        }

        async function exportContactsSheets() {
            try {
                showToast('info', 'Exporting...', 'Exporting to Google Sheets...', 2000);
                
                const response = await fetch('/api/contacts/export-sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from export-sheets:', text.substring(0, 200));
                    showToast('error', 'Not OK - Failed', 'Unexpected response from server. Please check console.', 5000);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('success', 'OK - Exported', `Successfully exported ${data.exported} contacts to Google Sheets`, 5000);
                } else {
                    showToast('error', 'Not OK - Failed', data.error || 'Export failed', 5000);
                }
            } catch (error) {
                console.error('Error exporting to Google Sheets:', error);
                // Check if error is due to JSON parsing
                if (error.message && error.message.includes('JSON')) {
                    showToast('error', 'Not OK - Server Error', 'Server returned invalid response. Check console for details.', 5000);
                } else {
                    showToast('error', 'Not OK - Network Error', error.message || 'Network error', 5000);
                }
            }
        }

        // --- INIT ---
        // Global error handler for 401 errors - redirect to login
        let isHandlingAuthError = false;
        async function handleAuthError() {
            if (isHandlingAuthError) return;
            isHandlingAuthError = true;
            
            // Check session one more time
            try {
                const sessionCheck = await fetch('/api/auth/session', { credentials: 'include' });
                if (!sessionCheck.ok) {
                    // Session is invalid, redirect to login
                    window.location.href = '/login';
                    return;
                }
            } catch (e) {
                window.location.href = '/login';
                return;
            }
            
            isHandlingAuthError = false;
        }
        
        // Intercept fetch to handle 401 errors globally
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const response = await originalFetch(...args);
            
            // If we get a 401, try to handle it
            if (response.status === 401 && args[0] && typeof args[0] === 'string' && args[0].startsWith('/api/')) {
                const url = args[0];
                // Don't redirect on session check endpoint
                if (!url.includes('/api/auth/session')) {
                    console.warn(`401 error on ${url}, checking session...`);
                    await handleAuthError();
                }
            }
            
            return response;
        };

        window.onload = async function() {
            try {
                console.log('Page loading...');
                
                // Load industries for selector
                loadIndustries();
                // First check session and load user info
                await checkSuperUser(); // Check if user is super user and show User Management tab
                
                // Only load data if user is authenticated
                if (currentUserData) {
                    console.log('User authenticated, loading data...');
                    try {
                        if (typeof loadTargetsFromAPI === 'function') {
                            loadTargetsFromAPI(); // Load targets from database
                        }
                    } catch (e) {
                        console.error('Error loading targets:', e);
                    }
                    
                    try {
                        if (typeof renderGapChart === 'function') {
                            renderGapChart(); // Load first chart immediately
                        }
                    } catch (e) {
                        console.error('Error rendering chart:', e);
                    }
                    
                    try {
                        if (typeof updateRevenue === 'function') {
                            updateRevenue(); // Init simulator
                        }
                    } catch (e) {
                        console.error('Error updating revenue:', e);
                    }
                    
                    try {
                        if (typeof refreshAnalytics === 'function') {
                            refreshAnalytics(); // Load analytics
                        }
                    } catch (e) {
                        console.error('Error refreshing analytics:', e);
                    }
                    
                    try {
                        if (typeof loadMeetings === 'function') {
                            loadMeetings(); // Load meetings
                        }
                    } catch (e) {
                        console.error('Error loading meetings:', e);
                    }
                    
                    try {
                        if (typeof loadNotifications === 'function') {
                            loadNotifications(); // Load notifications
                        }
                    } catch (e) {
                        console.error('Error loading notifications:', e);
                    }
                    
                    // Auto-refresh analytics every 5 minutes (reduced from 30 seconds to reduce API calls)
                    try {
                        if (typeof refreshAnalytics === 'function') {
                            setInterval(refreshAnalytics, 300000); // 5 minutes
                        }
                    } catch (e) {
                        console.error('Error setting analytics interval:', e);
                    }
                } else {
                    console.log('No user data, skipping data load');
                }
                
                // Auto-refresh notifications every 5 minutes (reduced from 60 seconds)
                try {
                    if (typeof loadNotifications === 'function') {
                        setInterval(loadNotifications, 300000); // 5 minutes
                    }
                } catch (e) {
                    console.error('Error setting notifications interval:', e);
                }
                
                // Close notifications when clicking outside
                document.addEventListener('click', (e) => {
                    try {
                        const dropdown = document.getElementById('notification-dropdown');
                        if (dropdown && !e.target.closest('#notification-dropdown') && !e.target.closest('button[onclick="toggleNotifications()"]')) {
                            dropdown.classList.add('hidden');
                            if (typeof notificationsOpen !== 'undefined') {
                                notificationsOpen = false;
                            }
                        }
                    } catch (e) {
                        console.error('Error handling notification click:', e);
                    }
                });
                
                console.log('Page loaded successfully');
            } catch (error) {
                console.error('Critical error in window.onload:', error);
                console.error('Error stack:', error.stack);
                // Show user-friendly error
                if (typeof showToast === 'function') {
                    showToast('error', 'Initialization Error', 'Some features may not work. Please check the browser console and refresh the page.', 10000);
                } else {
                    alert('Page initialization error. Please check the browser console (F12) and refresh the page.');
                }
            }
        };

        // --- COMPANIES MANAGEMENT (duplicate removed - using declaration from line 3058) ---
        // Note: companies, companiesFiltered, companiesPage already declared above

        async function loadCompanies() {
            const container = document.getElementById('companies-list');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center text-slate-500 py-8">Loading companies...</div>';
            
            try {
                const response = await fetch('/api/companies', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.companies) {
                    companies = data.companies;
                    companiesFiltered = companies;
                    companiesPage = 1;
                    renderCompanies();
                    loadCompanyFilters();
                    
                    // Show industry notice for industry admins
                    showIndustryNoticeForCompanies();
                } else {
                    container.innerHTML = '<div class="text-center text-slate-500 py-8">No companies found</div>';
                    if (data.error) {
                        showToast('warning', 'Warning', data.error, 3000);
                    }
                }
            } catch (error) {
                console.error('Error loading companies:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load companies. <button onclick="loadCompanies()" class="text-indigo-600 hover:underline">Retry</button></div>';
                showToast('error', 'Not OK - Failed', error.message || 'Failed to load companies', 5000);
            }
        }

        function loadCompanyFilters() {
            const industryFilter = document.getElementById('company-industry-filter');
            if (industryFilter) {
                const industries = [...new Set(companies.map(c => c.industry).filter(Boolean))].sort();
                industryFilter.innerHTML = '<option value="">All Industries</option>';
                industries.forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industryFilter.appendChild(option);
                });
            }
        }

        function filterCompanies() {
            const search = document.getElementById('company-search').value.toLowerCase();
            const industry = document.getElementById('company-industry-filter').value;
            
            companiesFiltered = companies.filter(c => {
                const matchSearch = !search || 
                    (c.name && c.name.toLowerCase().includes(search)) ||
                    (c.domain && c.domain.toLowerCase().includes(search)) ||
                    (c.industry && c.industry.toLowerCase().includes(search));
                
                const matchIndustry = !industry || c.industry === industry;
                return matchSearch && matchIndustry;
            });
            
            companiesPage = 1;
            renderCompanies();
        }

        function toggleSelectAllCompanies() {
            const selectAll = document.getElementById('select-all-companies');
            const checkboxes = document.querySelectorAll('.company-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function selectAllCompanies() {
            const checkboxes = document.querySelectorAll('.company-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('select-all-companies').checked = true;
        }

        function showPurgeCompaniesModal() {
            const selected = Array.from(document.querySelectorAll('.company-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                showToast('warning', 'No Selection', 'Please select companies to purge', 3000);
                return;
            }
            
            // Check if any selected companies have contacts
            const selectedCompanies = companies.filter(c => selected.includes(c.id));
            const companiesWithContacts = selectedCompanies.filter(c => (c.contact_count || 0) > 0);
            
            if (companiesWithContacts.length > 0) {
                const totalContacts = companiesWithContacts.reduce((sum, c) => sum + (c.contact_count || 0), 0);
                if (!confirm(`Warning: ${companiesWithContacts.length} selected company/companies have ${totalContacts} associated contact(s). Deleting these companies will orphan those contacts. Are you sure you want to proceed?`)) {
                    return;
                }
            } else {
                if (!confirm(`Are you sure you want to delete ${selected.length} company/companies? This action cannot be undone.`)) {
                    return;
                }
            }
            
            purgeCompanies(selected);
        }

        async function purgeCompanies(companyIds) {
            try {
                showToast('info', 'Deleting...', `Deleting ${companyIds.length} companies...`, 2000);
                
                // Delete in batches
                const batchSize = 10;
                for (let i = 0; i < companyIds.length; i += batchSize) {
                    const batch = companyIds.slice(i, i + batchSize);
                    await Promise.all(batch.map(id => 
                        fetch(`/api/companies/${id}`, {
                            method: 'DELETE',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ confirm: true, deleteContacts: false })
                        })
                    ));
                }
                
                showToast('success', 'OK - Deleted', `Successfully deleted ${companyIds.length} companies`, 3000);
                loadCompanies();
            } catch (error) {
                console.error('Error purging companies:', error);
                showToast('error', 'Not OK - Failed', 'Failed to delete companies', 5000);
            }
        }

        async function deleteCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            const contactCount = company ? (company.contact_count || 0) : 0;
            
            let message = 'Are you sure you want to delete this company?';
            if (contactCount > 0) {
                message = `Warning: This company has ${contactCount} associated contact(s). Deleting it will orphan those contacts. ${message}`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/companies/${companyId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: true, deleteContacts: false })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Deleted', 'Company deleted successfully', 3000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to delete company', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        function showAddCompanyModal() {
            // Simple prompt for now - can be enhanced with a modal
            const name = prompt('Company Name:');
            if (!name) return;
            
            const domain = prompt('Domain (optional):');
            const industry = prompt('Industry (optional):');
            
            createCompany({ name, domain: domain || null, industry: industry || null });
        }

        async function createCompany(data) {
            try {
                const response = await fetch('/api/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Created', 'Company created successfully', 3000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to create company', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        async function backfillCompanyDomains() {
            if (!confirm('This will extract domains from contact emails for companies that are missing domains. Continue?')) {
                return;
            }
            
            try {
                showToast('info', 'Backfilling...', 'Extracting domains from contact emails...', 2000);
                
                const response = await fetch('/api/companies/backfill-domains', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'OK - Backfilled', `Successfully backfilled domains for ${result.updated} companies`, 5000);
                    loadCompanies();
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to backfill domains', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        // --- ADMIN FUNCTIONS (SUPER USER ONLY) ---
        function switchAdminTab(tabId) {
            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all admin tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('admin-tab-active', 'text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-slate-500', 'border-transparent');
            });
            
            // Show selected tab content
            const content = document.getElementById('admin-content-' + tabId);
            if (content) {
                content.classList.remove('hidden');
            }
            
            // Activate selected tab button
            const btn = document.getElementById('admin-tab-' + tabId);
            if (btn) {
                btn.classList.add('admin-tab-active', 'text-indigo-600', 'border-indigo-600');
                btn.classList.remove('text-slate-500', 'border-transparent');
            }
            
            // Load data for specific tab
            if (tabId === 'user-mgmt' && typeof loadUsers === 'function') {
                loadUsers();
            } else if (tabId === 'signatures' && typeof loadSignatures === 'function') {
                loadSignatures();
            }
        }


        async function runBatchImport() {
            const excelFile = document.getElementById('admin-excel-file').value;
            const batchSize = parseInt(document.getElementById('admin-batch-size').value) || 100;
            const threads = parseInt(document.getElementById('admin-threads').value) || 4;
            const updateExisting = document.getElementById('admin-update-existing').checked;
            const importOnlyNew = document.getElementById('admin-import-only-new').checked;
            const sheet = document.getElementById('admin-sheet').value || null;
            const dryRun = document.getElementById('admin-dry-run').checked;
            
            if (!excelFile) {
                showToast('error', 'Missing File', 'Please enter Excel file path', 3000);
                return;
            }
            
            if (!confirm(`Run batch import with:\n- File: ${excelFile}\n- Batch Size: ${batchSize}\n- Threads: ${threads}\n- Update Existing: ${updateExisting}\n- Import Only New: ${importOnlyNew}\n- Dry Run: ${dryRun}`)) {
                return;
            }
            
            try {
                showToast('info', 'Starting...', 'Starting batch import...', 2000);
                
                const response = await fetch('/api/admin/scripts/import-contacts', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        excel_file: excelFile,
                        batch_size: batchSize,
                        threads: threads,
                        update_existing: updateExisting,
                        import_only_new: importOnlyNew,
                        sheet: sheet,
                        dry_run: dryRun
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('success', 'OK - Started', `Batch import started (PID: ${result.process_id}). Check logs for progress.`, 8000);
                    document.getElementById('admin-import-status').innerHTML = `
                        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mt-4">
                            <div class="font-bold text-emerald-900">Import Started</div>
                            <div class="text-sm text-emerald-700 mt-2">Process ID: ${result.process_id}</div>
                            <div class="text-sm text-emerald-700">Command: ${result.command}</div>
                            <div class="text-xs text-emerald-600 mt-2">${result.note}</div>
                        </div>
                    `;
                } else {
                    showToast('error', 'Not OK - Failed', result.error || 'Failed to start import', 5000);
                }
            } catch (error) {
                showToast('error', 'Not OK - Network Error', error.message, 5000);
            }
        }

        // ========== SIGNATURE MANAGEMENT FUNCTIONS ==========
        let editingSignatureId = null;

        async function loadSignatures() {
            try {
                const response = await fetch('/api/signatures', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    renderSignatures(data.signatures || []);
                } else {
                    showToast('error', 'Error', 'Failed to load signatures', 3000);
                    document.getElementById('signatures-list').innerHTML = '<div class="text-center text-red-500 py-8">Failed to load signatures</div>';
                }
            } catch (error) {
                console.error('Error loading signatures:', error);
                showToast('error', 'Error', 'Failed to load signatures', 3000);
                document.getElementById('signatures-list').innerHTML = '<div class="text-center text-red-500 py-8">Error loading signatures</div>';
            }
        }

        function renderSignatures(signatures) {
            const container = document.getElementById('signatures-list');
            
            if (signatures.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-500 py-8 border border-slate-200 rounded-lg">
                        <i class="fa-solid fa-signature text-4xl mb-4 text-slate-300"></i>
                        <p class="mb-4">No signatures found. Create your first signature!</p>
                        <button onclick="showCreateSignatureForm()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium">
                            <i class="fa-solid fa-plus mr-2"></i>Create Signature
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = signatures.map(sig => {
                const sigJson = typeof sig.signature_json === 'string' ? JSON.parse(sig.signature_json) : (sig.signature_json || {});
                const defaultBadge = sig.is_default ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded ml-2">Default</span>' : '';
                
                return `
                    <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition-colors">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h3 class="font-bold text-lg text-slate-900">${escapeHtml(sig.name || sig.from_name)}</h3>
                                    ${defaultBadge}
                                </div>
                                <div class="text-sm text-slate-600 mb-1">
                                    <span class="font-medium">From:</span> ${escapeHtml(sig.from_name)} &lt;${escapeHtml(sig.from_email)}&gt;
                                </div>
                                ${sig.reply_to && sig.reply_to !== sig.from_email ? `
                                    <div class="text-xs text-slate-500 mb-1">
                                        <span class="font-medium">Reply to:</span> ${escapeHtml(sig.reply_to)}
                                    </div>
                                ` : ''}
                                ${sigJson.title || sigJson.company ? `
                                    <div class="text-sm text-slate-600 mt-2">
                                        ${sigJson.title ? `<div>${escapeHtml(sigJson.title)}</div>` : ''}
                                        ${sigJson.company ? `<div>${escapeHtml(sigJson.company)}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${sig.calendar_link ? `
                                    <div class="text-xs text-slate-500 mt-2">
                                        <i class="fa-solid fa-calendar mr-1"></i>Calendar: ${escapeHtml(sig.calendar_link)}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="editSignature('${sig.id}')" class="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-sm font-medium">
                                    <i class="fa-solid fa-edit mr-1"></i>Edit
                                </button>
                                ${!sig.is_default ? `
                                    <button onclick="setDefaultSignature('${sig.id}')" class="px-3 py-1.5 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded text-sm font-medium">
                                        <i class="fa-solid fa-star mr-1"></i>Set Default
                                    </button>
                                ` : ''}
                                <button onclick="deleteSignature('${sig.id}')" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm font-medium">
                                    <i class="fa-solid fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCreateSignatureForm() {
            editingSignatureId = null;
            document.getElementById('signature-modal-title').innerHTML = '<i class="fa-solid fa-signature text-indigo-600 mr-2"></i>Create Signature';
            document.getElementById('signature-form').reset();
            document.getElementById('sig-is-default').checked = false;
            document.getElementById('signature-modal').classList.remove('hidden');
        }

        function editSignature(signatureId) {
            editingSignatureId = signatureId;
            document.getElementById('signature-modal-title').innerHTML = '<i class="fa-solid fa-edit text-indigo-600 mr-2"></i>Edit Signature';
            
            // Fetch signature data
            fetch(`/api/signatures`, { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const sig = data.signatures.find(s => s.id === signatureId);
                        if (sig) {
                            const sigJson = typeof sig.signature_json === 'string' ? JSON.parse(sig.signature_json) : (sig.signature_json || {});
                            
                            document.getElementById('sig-name').value = sig.name || '';
                            document.getElementById('sig-from-name').value = sig.from_name || '';
                            document.getElementById('sig-from-email').value = sig.from_email || '';
                            document.getElementById('sig-reply-to').value = sig.reply_to || '';
                            document.getElementById('sig-title').value = sigJson.title || '';
                            document.getElementById('sig-company').value = sigJson.company || '';
                            document.getElementById('sig-phone').value = sigJson.phone || '';
                            document.getElementById('sig-website').value = sigJson.website || '';
                            document.getElementById('sig-linkedin').value = sigJson.linkedin || '';
                            document.getElementById('sig-calendar-link').value = sig.calendar_link || '';
                            document.getElementById('sig-cta-text').value = sig.cta_text || '';
                            document.getElementById('sig-cta-button').value = sig.cta_button || '';
                            document.getElementById('sig-is-default').checked = sig.is_default || false;
                            
                            document.getElementById('signature-modal').classList.remove('hidden');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading signature:', error);
                    showToast('error', 'Error', 'Failed to load signature', 3000);
                });
        }

        function closeSignatureModal() {
            document.getElementById('signature-modal').classList.add('hidden');
            editingSignatureId = null;
        }

        async function saveSignature(event) {
            event.preventDefault();
            
            const signatureData = {
                name: document.getElementById('sig-name').value,
                from_name: document.getElementById('sig-from-name').value,
                from_email: document.getElementById('sig-from-email').value,
                reply_to: document.getElementById('sig-reply-to').value || null,
                signature_json: {
                    title: document.getElementById('sig-title').value || null,
                    company: document.getElementById('sig-company').value || null,
                    phone: document.getElementById('sig-phone').value || null,
                    website: document.getElementById('sig-website').value || null,
                    linkedin: document.getElementById('sig-linkedin').value || null
                },
                calendar_link: document.getElementById('sig-calendar-link').value || null,
                cta_text: document.getElementById('sig-cta-text').value || null,
                cta_button: document.getElementById('sig-cta-button').value || null,
                is_default: document.getElementById('sig-is-default').checked
            };

            // Remove null values from signature_json
            Object.keys(signatureData.signature_json).forEach(key => {
                if (!signatureData.signature_json[key]) {
                    delete signatureData.signature_json[key];
                }
            });

            try {
                const url = editingSignatureId ? `/api/signatures/${editingSignatureId}` : '/api/signatures';
                const method = editingSignatureId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signatureData)
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Success', editingSignatureId ? 'Signature updated' : 'Signature created', 3000);
                    closeSignatureModal();
                    loadSignatures();
                } else {
                    showToast('error', 'Error', result.error || 'Failed to save signature', 5000);
                }
            } catch (error) {
                console.error('Error saving signature:', error);
                showToast('error', 'Error', 'Failed to save signature', 5000);
            }
        }

        async function deleteSignature(signatureId) {
            if (!confirm('Are you sure you want to delete this signature?')) {
                return;
            }

            try {
                const response = await fetch(`/api/signatures/${signatureId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Success', 'Signature deleted', 3000);
                    loadSignatures();
                } else {
                    showToast('error', 'Error', result.error || 'Failed to delete signature', 5000);
                }
            } catch (error) {
                console.error('Error deleting signature:', error);
                showToast('error', 'Error', 'Failed to delete signature', 5000);
            }
        }

        async function setDefaultSignature(signatureId) {
            try {
                const response = await fetch(`/api/signatures/${signatureId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_default: true })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Success', 'Default signature updated', 3000);
                    loadSignatures();
                } else {
                    showToast('error', 'Error', result.error || 'Failed to set default signature', 5000);
                }
            } catch (error) {
                console.error('Error setting default signature:', error);
                showToast('error', 'Error', 'Failed to set default signature', 5000);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

    </script>

    <!-- Signature Create/Edit Modal -->
    <div id="signature-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-900" id="signature-modal-title">
                        <i class="fa-solid fa-signature text-indigo-600 mr-2"></i>Create Signature
                    </h3>
                    <button onclick="closeSignatureModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="signature-form" onsubmit="saveSignature(event)">
                    <div class="space-y-4">
                        <!-- Basic Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Profile Name *</label>
                                <input type="text" id="sig-name" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="e.g., John - Sales Team">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">From Name *</label>
                                <input type="text" id="sig-from-name" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="e.g., John Smith">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">From Email *</label>
                                <input type="email" id="sig-from-email" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="john@company.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Reply-To Email</label>
                                <input type="email" id="sig-reply-to" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Leave empty to use From Email">
                            </div>
                        </div>

                        <!-- Signature Details -->
                        <div class="border-t border-slate-200 pt-4 mt-4">
                            <h4 class="font-bold text-slate-900 mb-4">Signature Details</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Job Title</label>
                                    <input type="text" id="sig-title" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Senior Sales Manager">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Company</label>
                                    <input type="text" id="sig-company" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Acme Corporation">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Phone</label>
                                    <input type="text" id="sig-phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="+1 (555) 123-4567">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Website</label>
                                    <input type="url" id="sig-website" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="https://www.company.com">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-slate-700 mb-2">LinkedIn Profile</label>
                                <input type="url" id="sig-linkedin" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="https://linkedin.com/in/username">
                            </div>
                        </div>

                        <!-- Calendar CTA -->
                        <div class="border-t border-slate-200 pt-4 mt-4">
                            <h4 class="font-bold text-slate-900 mb-4">Calendar Link (Optional)</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Calendar Link</label>
                                    <input type="url" id="sig-calendar-link" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="https://cal.com/username/30min">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">CTA Text</label>
                                        <input type="text" id="sig-cta-text" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Let's schedule a time to talk:">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Button Text</label>
                                        <input type="text" id="sig-cta-button" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Schedule a Meeting">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Default Signature -->
                        <div class="border-t border-slate-200 pt-4 mt-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="sig-is-default" class="mr-2">
                                <span class="text-sm font-medium text-slate-700">Set as default signature (will be used for all messages)</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-6 mt-6 border-t border-slate-200">
                        <button type="button" onclick="closeSignatureModal()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium">
                            <i class="fa-solid fa-save mr-2"></i>Save Signature
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pitch Send Preview Modal -->
    <div id="pitch-send-preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-900">
                        <i class="fa-solid fa-paper-plane text-emerald-600 mr-2"></i>Review Before Sending
                    </h3>
                    <button onclick="closePitchSendPreview()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="pitch-send-preview-subject-group" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Subject</label>
                    <input type="text" id="pitch-send-preview-subject" class="w-full px-3 py-2 border border-slate-300 rounded-lg" readonly>
                </div>
                <div id="pitch-send-preview-content" class="mb-6">
                    <!-- Preview content will be inserted here -->
                </div>
                <div class="flex gap-3 pt-4 border-t border-slate-200">
                    <button onclick="closePitchSendPreview()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium">
                        Cancel
                    </button>
                    <button onclick="confirmSendPitch()" id="btn-confirm-send-pitch" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium">
                        <i class="fa-solid fa-paper-plane mr-2"></i>Send Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>